import{j as e}from"./app-bridge-DAr010gb-1758091691979.js";import{r as s}from"./react-vendor-tAaa2TlE-1758091691979.js";import{m as ot}from"./index-DJeaMdRs-1758091691979.js";import{U as at}from"./UpgradeModal-DQgVZtKz-1758091691979.js";import{M as u,d as A,T as o,e as ae,a as c,I as y,f as we,B as I,D as rt,g as V,C as Ae,h as it,S as ct,P as dt,i as ht,R as ut,j as gt,l as pt,E as ft}from"./polaris-BdLPXLKJ-1758091691979.js";const xt=(q,d="")=>{try{return new URLSearchParams(window.location.search).get(q)||d}catch{return d}};function Dt({shop:q}){const d=q||xt("shop",""),m=s.useMemo(()=>ot(),[]),[x,ve]=s.useState([]),[Ee,re]=s.useState(!1),[R,ke]=s.useState(0),[S,W]=s.useState([]),[b,Q]=s.useState(!1),[St,ie]=s.useState(""),[M,Y]=s.useState(""),[C,U]=s.useState("all"),[ce,_]=s.useState(!1),[Ie,Me]=s.useState(""),[mt,Oe]=s.useState([]),[v,F]=s.useState([]),[E,de]=s.useState([]),[K,D]=s.useState(!1),[k,O]=s.useState({current:0,total:0,percent:0}),[he,N]=s.useState(""),[z,ue]=s.useState([]),[jt,yt]=s.useState(!1),[bt,Ct]=s.useState(null),[wt,At]=s.useState(!1),[vt,Pe]=s.useState(""),[De,H]=s.useState(!1),[L,T]=s.useState([]),[ge,pe]=s.useState(!1),[Le,$]=s.useState(!1),[Te,G]=s.useState(!1),[fe,J]=s.useState([]),[B,X]=s.useState({}),[Be,Z]=s.useState(!1),[Re,ee]=s.useState(!1),[xe,Et]=s.useState({}),[We,te]=s.useState(!1),[Se,se]=s.useState(null),[ze,me]=s.useState(!1),[je,f]=s.useState(""),[ne,le]=s.useState(!1),[$e,ye]=s.useState(!1),[Ue,Fe]=s.useState("starter"),[p,be]=s.useState({processing:!1,current:0,total:0,currentItem:"",results:null});s.useEffect(()=>{d&&m("/plans/me",{shop:d}).then(t=>{const l=(t==null?void 0:t.modelsSuggested)||["google/gemini-1.5-flash"];Oe(l.map(n=>({label:n,value:n}))),Me(l[0])}).catch(t=>f(`Error loading models: ${t.message}`))},[d,m]),s.useEffect(()=>{d&&m(`/api/languages/shop/${d}`).then(t=>{const l=(t==null?void 0:t.shopLanguages)||["en"];de(l),F([])}).catch(()=>{de(["en"]),F([])})},[d,m]);const P=s.useCallback(async()=>{re(!0);try{const t=new URLSearchParams({shop:d,...M&&{search:M},...C!=="all"&&{optimized:C}});let n=(await m(`/collections/list?${t}`)).collections||[];if(M){const i=M.toLowerCase();n=n.filter(a=>a.title.toLowerCase().includes(i)||a.handle.toLowerCase().includes(i))}C!=="all"&&(n=n.filter(i=>C==="true"?i.hasSeoData:!i.hasSeoData)),ve(n),ke(n.length)}catch(t){f(`Error loading collections: ${t.message}`)}finally{re(!1)}},[d,M,C,m]);s.useEffect(()=>{d&&(P(),$(!1))},[d,C]),s.useEffect(()=>{const t=setTimeout(()=>{d&&P()},500);return()=>clearTimeout(t)},[M]);const Ne=s.useCallback(t=>{W(t);const l=t.some(n=>{const i=x.find(a=>a.id===n);return i==null?void 0:i.hasSeoData});$(l),t.length===0&&Q(!1)},[x]),He=s.useCallback(t=>{if(Q(t),t){W(x.map(n=>n.id));const l=x.some(n=>n.hasSeoData);$(l)}else W([]),$(!1)},[x]),Ge=async t=>{me(!0);try{const l=`/collections/${t.split("/").pop()}/seo-data?shop=${encodeURIComponent(d)}`,n=await m(l);se(n),te(!0)}catch(l){f((l==null?void 0:l.status)===404?"No SEO data found for this collection":"Failed to load SEO data")}finally{me(!1)}},Je=()=>{if(S.length===0&&!b){f("Please select collections first");return}ee(!0)},Ve=()=>{const t=x.filter(a=>S.includes(a.id)),l=t.filter(a=>{var r;return((r=a.optimizedLanguages)==null?void 0:r.length)>0}),n=async()=>{try{D(!0),ie("Checking eligibility...");const a=await m("/ai-enhance/check-eligibility",{method:"POST",shop:d,body:{shop:d}});if(!a.eligible){Fe(a.currentPlan||"starter"),le(!1),ye(!0);return}console.log("Selected collections:",t),console.log("Selected collections length:",t.length),console.log("Shop domain:",d),console.log("Selected language:",v);const r={successful:0,failed:0,skipped:0};for(const h of l)try{const g=h.optimizedLanguages||[];if(g.length===0){console.log(`No optimized languages for ${h.title}, skipping`),r.skipped++;continue}console.log(`Enhancing ${h.title} for languages:`,g);try{(await m(`/ai-enhance/collection/${encodeURIComponent(h.id)}`,{method:"POST",shop:d,body:{shop:d,languages:g}})).ok?r.successful++:r.failed++}catch(w){console.error("API call error:",w),r.failed++}}catch(g){console.error("Error enhancing collection:",h.id,g),r.failed++,f(`Error enhancing ${h.title}`)}be({processing:!1,current:0,total:0,currentItem:"",results:r}),await P()}catch(a){console.error("AI Enhance error:",a),f("Failed to enhance collections")}finally{D(!1),ie("")}},i=()=>{le(!1),be({processing:!1,current:0,total:0,currentItem:"",results:null}),p.results&&p.results.successful>0&&P()};return!p.processing&&!p.results?e.jsx(u,{open:ne,title:"AI Enhanced add-ons for AI Search",onClose:i,primaryAction:{content:"Start AI Enhancement",onAction:n},secondaryActions:[{content:"Cancel",onAction:i}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(o,{variant:"bodyMd",children:["AI enhancement will improve bullets and FAQ for ",l.length," collections."]}),e.jsx(o,{variant:"bodySm",tone:"subdued",children:"Note: AI enhancement is only available for Growth Extra and Enterprise plans."})]})})}):p.processing?e.jsx(u,{open:ne,title:"Processing AI Enhancement",onClose:()=>{},noScroll:!0,children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsxs(o,{variant:"bodyMd",children:["Processing: ",p.currentItem]}),e.jsx(ae,{progress:p.current/p.total*100}),e.jsxs(o,{variant:"bodySm",tone:"subdued",children:[p.current," of ",p.total," collections (",Math.round(p.current/p.total*100),"%)"]})]})})}):p.results!==null?e.jsx(u,{open:ne,title:"AI Enhancement Results",onClose:i,primaryAction:{content:"Done",onAction:i},children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(y,{gap:"400",children:[e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"success",children:p.results.successful})]}),e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:p.results.failed})]}),e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Skipped:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"info",children:p.results.skipped})]})]}),p.results.skippedDueToPlan>0&&e.jsx(c,{paddingBlockStart:"300",children:e.jsx(o,{variant:"bodySm",tone:"subdued",children:"AI enhancement is only available for Growth Extra and Enterprise plans."})})]})})}):null},qe=async()=>{if(!v.length){f("Please select at least one language");return}ee(!1),D(!0),O({current:0,total:0,percent:0}),ue([]),X({});try{const t=b?x:x.filter(a=>S.includes(a.id)),l=t.length;O({current:0,total:l,percent:0});const n={};for(let a=0;a<t.length;a++){const r=t[a];N(r.title);try{const w=await m("/seo/generate-collection-multi",{method:"POST",shop:d,body:{shop:d,collectionId:r.id,model:Ie,languages:v}});n[r.id]={success:!0,data:w}}catch(w){n[r.id]={success:!1,error:w.message},ue(oe=>[...oe,{collection:r.title,error:w.message}])}const h=a+1,g=Math.round(h/l*100);O({current:h,total:l,percent:g})}X(n),Z(!0);const i=Object.values(n).filter(a=>a.success).length;f(`Generated SEO for ${i} collections`)}catch(t){f(`Error: ${t.message}`)}finally{D(!1),N("")}},Qe=async()=>{var t,l;D(!0),O({current:0,total:0,percent:0});try{const n=Object.entries(B).filter(([a,r])=>r.success),i=n.length;O({current:0,total:i,percent:0});for(let a=0;a<n.length;a++){const[r,h]=n[a],g=x.find(j=>j.id===r);if(!g)continue;N(g.title);try{if(console.log("Applying SEO for collection:",r),console.log("Result data:",h.data),console.log("Results array:",(t=h.data)==null?void 0:t.results),!((l=h.data)!=null&&l.results)||!Array.isArray(h.data.results))throw new Error("Invalid results structure");const j=await m("/seo/apply-collection-multi",{method:"POST",shop:d,body:{shop:d,collectionId:r,results:h.data.results.map(Ce=>({language:Ce.language,seo:Ce.data})),options:{updateTitle:!0,updateDescription:!0,updateSeo:!0,updateMetafields:!0}}});if(!(j!=null&&j.ok))throw new Error((j==null?void 0:j.error)||"Apply failed")}catch(j){console.error("Apply error for collection:",r,j),z.push({id:g.id,title:g.title,message:j.message})}const w=a+1,oe=Math.round(w/i*100);O({current:w,total:i,percent:oe})}f("SEO applied successfully!"),Z(!1),X({}),W([]),await P()}catch(n){f(`Error applying SEO: ${n.message}`)}finally{D(!1),N("")}},Ye=async(t=[])=>{pe(!0),Pe("");try{const l=b?x:x.filter(r=>S.includes(r.id)),n=l.length*t.length;let i=0;const a=[];for(const r of l)for(const h of t)try{await m("/collections/delete-seo",{method:"DELETE",shop:d,body:{shop:d,collectionId:r.id,language:h}})}catch(g){console.error(`Failed to delete ${h} for ${r.title}:`,g),a.push({id:r.id,title:r.title,message:g.message})}finally{i++,O({current:i,total:n,percent:Math.round(i/n*100)})}f(`Deleted SEO for ${t.join(", ").toUpperCase()}`),setTimeout(async()=>{await P(),W([]),Q(!1),$(!1)},100)}catch(l){f(`Delete error: ${l.message}`)}finally{pe(!1),J([]),T([])}},_e=t=>{var r,h;const l=((r=B[t.id])==null?void 0:r.success)||xe[t.id],n=((h=B[t.id])==null?void 0:h.data)||xe[t.id],i=t.optimizedLanguages||[],a=e.jsx(c,{width:"40px",height:"40px",background:"surface-neutral",borderRadius:"200"});return e.jsx(pt,{id:t.id,url:"",media:a,accessibilityLabel:`View details for ${t.title}`,children:e.jsxs(y,{gap:"400",align:"center",blockAlign:"center",wrap:!1,children:[e.jsxs(c,{style:{flex:"1 1 30%",minWidth:"200px"},children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:t.title}),e.jsxs(o,{variant:"bodySm",tone:"subdued",children:["Handle: ",t.handle]})]}),e.jsx(c,{style:{flex:"0 0 15%",minWidth:"100px",textAlign:"center"},children:e.jsxs(o,{variant:"bodyMd",children:[t.productsCount," products"]})}),e.jsx(c,{style:{flex:"0 0 25%",minWidth:"160px"},children:t.hasSeoData?e.jsx(y,{gap:"100",children:E.map(g=>e.jsx(V,{tone:i.includes(g)?"success":"subdued",size:"small",children:g.toUpperCase()},g))}):e.jsx(V,{tone:"subdued",children:"No AI Search Optimisation"})}),e.jsxs(c,{style:{flex:"0 0 15%",minWidth:"120px"},children:[l&&e.jsx(I,{size:"slim",onClick:()=>{se(n),te(!0)},children:"Preview JSON"}),!l&&t.hasSeoData&&e.jsx(I,{size:"slim",loading:ze,onClick:()=>Ge(t.id),children:"Preview JSON"})]})]})})},Ke=K&&!p.processing&&e.jsx(u,{open:K,title:"Processing Collections",onClose:()=>{},noScroll:!0,children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(o,{variant:"bodyMd",children:he?`Processing: ${he}`:"Preparing..."}),e.jsx(ae,{progress:k.percent}),e.jsxs(o,{variant:"bodySm",tone:"subdued",children:[k.current," of ",k.total," collections (",k.percent,"%)"]})]})})}),Xe=e.jsx(u,{open:Re,title:"Select Languages",primaryAction:{content:"Generate Optimization for AI Search",onAction:qe,disabled:v.length===0},secondaryActions:[{content:"Cancel",onAction:()=>ee(!1)}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(o,{variant:"bodyMd",children:["Select languages to generate AI Search Optimisation for ",b?"all":S.length," selected collections:"]}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(y,{gap:"200",wrap:!0,children:E.map(t=>e.jsx(we,{label:t.toUpperCase(),checked:v.includes(t),onChange:l=>{F(l?[...v,t]:v.filter(n=>n!==t))}},t))})}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(I,{plain:!0,onClick:()=>{F(v.length===E.length?[]:[...E])},children:v.length===E.length?"Deselect all":"Select all"})})]})})}),Ze=e.jsx(u,{open:Be&&!K,title:"AI Search Optimisation Results",primaryAction:{content:"Apply Optimisation",onAction:Qe,disabled:!Object.values(B).some(t=>t.success)},secondaryActions:[{content:"Cancel",onAction:()=>Z(!1)}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(y,{gap:"400",children:[e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"success",children:Object.values(B).filter(t=>t.success).length})]}),e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:Object.values(B).filter(t=>!t.success).length})]})]}),z.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{}),e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Errors:"}),e.jsxs(c,{maxHeight:"200px",overflowY:"scroll",children:[z.slice(0,10).map((t,l)=>e.jsxs(o,{variant:"bodySm",tone:"critical",children:[t.collection,": ",t.error]},l)),z.length>10&&e.jsxs(o,{variant:"bodySm",tone:"subdued",children:["... and ",z.length-10," more errors"]})]})]})]})})}),et=e.jsx(u,{open:We,title:"SEO Data Preview",secondaryActions:[{content:"Close",onAction:()=>{te(!1),se(null)}}],children:e.jsx(u.Section,{children:e.jsx(c,{children:e.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"12px",backgroundColor:"#f6f6f7",padding:"12px",borderRadius:"4px",maxHeight:"400px",overflow:"auto"},children:Se?JSON.stringify(Se,null,2):""})})})}),tt=e.jsx(u,{open:De,title:"Delete Optimization for AI Search",onClose:()=>{H(!1),T([])},primaryAction:{content:"Continue",onAction:()=>{J(L),H(!1),G(!0)},disabled:L.length===0},secondaryActions:[{content:"Cancel",onAction:()=>{H(!1),T([])}}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsxs(o,{variant:"bodyMd",children:["Select languages to delete AI Search Optimisation from ",b?R:S.length," selected collections:"]}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(y,{gap:"400",wrap:!1,children:E.map(t=>e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer",userSelect:"none"},children:[e.jsx("input",{type:"checkbox",checked:L.includes(t),onChange:l=>{T(l.target.checked?[...L,t]:L.filter(n=>n!==t))},style:{marginRight:"8px",width:"18px",height:"18px",cursor:"pointer"}}),e.jsx(o,{variant:"bodyMd",children:t.toUpperCase()})]},t))})}),e.jsx(c,{children:e.jsx(I,{plain:!0,onClick:()=>{T(L.length===E.length?[]:[...E])},children:"Select all"})}),e.jsx(c,{paddingBlockStart:"300",children:e.jsx(o,{variant:"bodySm",children:"Warning: This will permanently delete AI Search Optimisation data for selected languages."})})]})})}),st=e.jsx(u,{open:Te,title:"Confirm Deletion",onClose:()=>{G(!1),J([])},primaryAction:{content:"Delete",destructive:!0,onAction:async()=>{G(!1),setTimeout(()=>{Ye(fe)},100)}},secondaryActions:[{content:"Cancel",onAction:()=>{G(!1),J([]),T([])}}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(o,{variant:"bodyMd",children:"Are you sure you want to delete AI Search Optimisation for the following languages?"}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(y,{gap:"200",children:fe.map(t=>e.jsx(V,{tone:"warning",children:t.toUpperCase()},t))})}),e.jsxs(o,{variant:"bodyMd",children:["This will delete optimisation from ",b?R:S.length," selected collections."]}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(o,{variant:"bodySm",tone:"critical",children:"This action cannot be undone."})})]})})}),nt=ge&&e.jsx(u,{open:ge,title:"Deleting SEO Data",onClose:()=>{},noScroll:!0,children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(o,{variant:"bodyMd",children:"Deleting selected languages..."}),e.jsx(ae,{progress:k.percent}),e.jsxs(o,{variant:"bodySm",tone:"subdued",children:[k.current," of ",k.total," operations (",k.percent,"%)"]})]})})}),lt=e.jsx(ft,{heading:"No collections found",action:{content:"Clear filters",onAction:()=>{Y(""),U("all"),P()}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Try adjusting your filters or search terms"})});return e.jsxs(e.Fragment,{children:[e.jsx(Ae,{children:e.jsxs(c,{padding:"400",children:[e.jsxs(y,{gap:"400",align:"space-between",blockAlign:"start",wrap:!1,children:[e.jsx(c,{minWidth:"400px",maxWidth:"600px",children:e.jsx(it,{label:"",placeholder:"Search by collection name...",value:M,onChange:Y,prefix:e.jsx(ct,{}),clearButton:!0,onClearButtonClick:()=>Y("")})}),e.jsxs(A,{gap:"200",children:[e.jsx(I,{primary:!0,onClick:Je,disabled:S.length===0&&!b,children:"Generate Optimization for AI Search"}),S.length===0&&!b||!x.filter(n=>S.includes(n.id)).some(n=>{var i;return((i=n.optimizedLanguages)==null?void 0:i.length)>0})?null:e.jsx(I,{onClick:()=>le(!0),disabled:S.length===0&&!b,children:"AI Enhanced add-ons for AI Search"}),e.jsx(I,{outline:!0,destructive:!0,onClick:()=>H(!0),disabled:S.length===0||!Le,children:"Delete Optimization for AI Search"})]})]}),R>0&&e.jsx(c,{paddingBlockStart:"300",children:e.jsx(we,{label:`Select all ${R} collections`,checked:b,onChange:He})})]})}),e.jsx(c,{paddingBlockStart:"400",children:e.jsxs(Ae,{children:[e.jsxs(c,{padding:"400",borderBlockEndWidth:"025",borderColor:"border",children:[e.jsx(y,{gap:"200",wrap:!0,children:e.jsx(dt,{active:ce,activator:e.jsx(I,{disclosure:"down",onClick:()=>_(!ce),removeUnderline:!0,children:e.jsxs(y,{gap:"100",blockAlign:"center",children:[e.jsx("span",{children:"AI Search Status"}),C!=="all"&&e.jsx(c,{onClick:t=>{t.stopPropagation(),U("all")},children:e.jsx(o,{as:"span",tone:"subdued",children:"✕"})})]})}),onClose:()=>_(!1),children:e.jsx(c,{padding:"300",minWidth:"200px",children:e.jsx(ht,{title:"AI Search Status",titleHidden:!0,choices:[{label:"All collections",value:"all"},{label:"Has AI Search Optimisation",value:"true"},{label:"No AI Search Optimisation",value:"false"}],selected:[C],onChange:t=>{U(t[0]),_(!1)}})})})}),C!=="all"&&e.jsx(c,{paddingBlockStart:"200",children:e.jsx(y,{gap:"100",wrap:!0,children:e.jsx(V,{onRemove:()=>U("all"),children:C==="true"?"Has AI Search Optimisation":"No AI Search Optimisation"})})})]}),e.jsx(ut,{resourceName:{singular:"collection",plural:"collections"},items:x,renderItem:_e,selectedItems:S,onSelectionChange:Ne,selectable:!0,loading:Ee,totalItemsCount:R,emptyState:lt,showHeader:!1})]})}),Ke,Xe,Ze,et,tt,st,nt,Ve(),e.jsx(at,{open:$e,onClose:()=>ye(!1),featureName:"AI Enhancement",currentPlan:Ue}),je&&e.jsx(gt,{content:je,onDismiss:()=>f("")})]})}export{Dt as default};
