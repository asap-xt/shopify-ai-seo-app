import{j as e}from"./app-bridge-COfZN3B4-1758101240046.js";import{r as s}from"./react-vendor-tAaa2TlE-1758101240046.js";import{m as rt}from"./index-gAZ4DdUc-1758101240046.js";import{U as it}from"./UpgradeModal-CUA2YQBz-1758101240046.js";import{M as u,d as A,T as o,e as ce,a as c,I as C,f as ve,B as O,D as ct,g as X,C as we,h as dt,S as ht,P as ut,i as gt,R as pt,j as ft,l as xt,E as mt}from"./polaris-CgXnMwsQ-1758101240046.js";const St=(Z,d="")=>{try{return new URLSearchParams(window.location.search).get(Z)||d}catch{return d}};function zt({shop:Z}){const d=Z||St("shop",""),b=s.useMemo(()=>rt(),[]),[S,Ae]=s.useState([]),[Ee,de]=s.useState(!1),[$,Me]=s.useState(0),[j,U]=s.useState([]),[v,ee]=s.useState(!1),[jt,ke]=s.useState(""),[P,te]=s.useState(""),[w,H]=s.useState("all"),[he,se]=s.useState(!1),[Ie,Oe]=s.useState(""),[yt,Pe]=s.useState([]),[E,G]=s.useState([]),[k,ue]=s.useState([]),[ne,L]=s.useState(!1),[I,M]=s.useState({current:0,total:0,percent:0}),[ge,z]=s.useState(""),[F,pe]=s.useState([]),[bt,Ct]=s.useState(!1),[vt,wt]=s.useState(null),[At,Et]=s.useState(!1),[Mt,De]=s.useState(""),[Le,J]=s.useState(!1),[T,B]=s.useState([]),[fe,xe]=s.useState(!1),[ze,N]=s.useState(!1),[Te,V]=s.useState(!1),[me,q]=s.useState([]),[R,Q]=s.useState({}),[Be,Y]=s.useState(!1),[Re,le]=s.useState(!1),[Se,kt]=s.useState({}),[We,oe]=s.useState(!1),[je,ae]=s.useState(null),[$e,ye]=s.useState(!1),[be,f]=s.useState(""),[re,ie]=s.useState(!1),[Ue,Ce]=s.useState(!1),[Fe,Ne]=s.useState("starter"),[g,He]=s.useState({processing:!1,current:0,total:0,currentItem:"",results:null});s.useEffect(()=>{d&&b("/plans/me",{shop:d}).then(t=>{const l=(t==null?void 0:t.modelsSuggested)||["google/gemini-1.5-flash"];Pe(l.map(n=>({label:n,value:n}))),Oe(l[0])}).catch(t=>f(`Error loading models: ${t.message}`))},[d,b]),s.useEffect(()=>{d&&b(`/api/languages/shop/${d}`).then(t=>{const l=(t==null?void 0:t.shopLanguages)||["en"];ue(l),G([])}).catch(()=>{ue(["en"]),G([])})},[d,b]);const D=s.useCallback(async()=>{de(!0);try{const t=new URLSearchParams({shop:d,...P&&{search:P},...w!=="all"&&{optimized:w}});let n=(await b(`/collections/list?${t}`)).collections||[];if(P){const r=P.toLowerCase();n=n.filter(a=>a.title.toLowerCase().includes(r)||a.handle.toLowerCase().includes(r))}w!=="all"&&(n=n.filter(r=>w==="true"?r.hasSeoData:!r.hasSeoData)),Ae(n),Me(n.length)}catch(t){f(`Error loading collections: ${t.message}`)}finally{de(!1)}},[d,P,w,b]);s.useEffect(()=>{d&&(D(),N(!1))},[d,w]),s.useEffect(()=>{const t=setTimeout(()=>{d&&D()},500);return()=>clearTimeout(t)},[P]);const Ge=s.useCallback(t=>{U(t);const l=t.some(n=>{const r=S.find(a=>a.id===n);return r==null?void 0:r.hasSeoData});N(l),t.length===0&&ee(!1)},[S]),Je=s.useCallback(t=>{if(ee(t),t){U(S.map(n=>n.id));const l=S.some(n=>n.hasSeoData);N(l)}else U([]),N(!1)},[S]),Ve=async t=>{ye(!0);try{const l=`/collections/${t.split("/").pop()}/seo-data?shop=${encodeURIComponent(d)}`,n=await b(l);ae(n),oe(!0)}catch(l){f((l==null?void 0:l.status)===404?"No SEO data found for this collection":"Failed to load SEO data")}finally{ye(!1)}},qe=()=>{if(j.length===0&&!v){f("Please select collections first");return}le(!0)},Qe=()=>{const t=S.filter(a=>j.includes(a.id)),l=t.filter(a=>{var i;return((i=a.optimizedLanguages)==null?void 0:i.length)>0}),n=async()=>{try{L(!0),ke("Checking eligibility...");const a=await b("/ai-enhance/check-eligibility",{method:"POST",shop:d,body:{shop:d}});if(!a.eligible){Ne(a.currentPlan||"starter"),ie(!1),Ce(!0);return}console.log("Selected collections:",t),console.log("Selected collections length:",t.length),console.log("Shop domain:",d),console.log("Selected language:",E);const i=l.length;M({current:0,total:i,percent:0});const h={};for(let x=0;x<l.length;x++){const y=l[x];z(y.title);try{const W=y.optimizedLanguages||[];if(W.length===0){console.log(`No optimized languages for ${y.title}, skipping`),h[y.id]={success:!1,error:"No optimized languages"};continue}console.log(`Enhancing ${y.title} for languages:`,W);const K=await b(`/ai-enhance/collection/${encodeURIComponent(y.id)}`,{method:"POST",shop:d,body:{shop:d,languages:W}});h[y.id]={success:K.ok,data:K,error:K.ok?null:K.error||"Enhancement failed"}}catch(W){console.error("Error enhancing collection:",y.id,W),h[y.id]={success:!1,error:W.message}}const m=x+1,_=Math.round(m/i*100);M({current:m,total:i,percent:_})}Q(h),Y(!0);const p=Object.values(h).filter(x=>x.success).length;f(`Enhanced ${p} collections`),await D()}catch(a){console.error("AI Enhance error:",a),f("Failed to enhance collections")}finally{L(!1),z("")}},r=()=>{ie(!1),He({processing:!1,current:0,total:0,currentItem:"",results:null}),g.results&&g.results.successful>0&&D()};return!g.processing&&!g.results?e.jsx(u,{open:re,title:"AI Enhanced add-ons for AI Search",onClose:r,primaryAction:{content:"Start AI Enhancement",onAction:n},secondaryActions:[{content:"Cancel",onAction:r}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(o,{variant:"bodyMd",children:["AI enhancement will improve bullets and FAQ for ",l.length," collections."]}),e.jsx(o,{variant:"bodySm",tone:"subdued",children:"Note: AI enhancement is only available for Growth Extra and Enterprise plans."})]})})}):g.processing?e.jsx(u,{open:re,title:"Processing AI Enhancement",onClose:()=>{},noScroll:!0,children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsxs(o,{variant:"bodyMd",children:["Processing: ",g.currentItem]}),e.jsx(ce,{progress:g.current/g.total*100}),e.jsxs(o,{variant:"bodySm",tone:"subdued",children:[g.current," of ",g.total," collections (",Math.round(g.current/g.total*100),"%)"]})]})})}):g.results!==null?e.jsx(u,{open:re,title:"AI Enhancement Results",onClose:r,primaryAction:{content:"Done",onAction:r},children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(C,{gap:"400",children:[e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"success",children:g.results.successful})]}),e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:g.results.failed})]}),e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Skipped:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"info",children:g.results.skipped})]})]}),g.results.skippedDueToPlan>0&&e.jsx(c,{paddingBlockStart:"300",children:e.jsx(o,{variant:"bodySm",tone:"subdued",children:"AI enhancement is only available for Growth Extra and Enterprise plans."})})]})})}):null},Ye=async()=>{if(!E.length){f("Please select at least one language");return}le(!1),L(!0),M({current:0,total:0,percent:0}),pe([]),Q({});try{const t=v?S:S.filter(a=>j.includes(a.id)),l=t.length;M({current:0,total:l,percent:0});const n={};for(let a=0;a<t.length;a++){const i=t[a];z(i.title);try{const x=await b("/seo/generate-collection-multi",{method:"POST",shop:d,body:{shop:d,collectionId:i.id,model:Ie,languages:E}});n[i.id]={success:!0,data:x}}catch(x){n[i.id]={success:!1,error:x.message},pe(y=>[...y,{collection:i.title,error:x.message}])}const h=a+1,p=Math.round(h/l*100);M({current:h,total:l,percent:p})}Q(n),Y(!0);const r=Object.values(n).filter(a=>a.success).length;f(`Generated optimization for ${r} collections`)}catch(t){f(`Error: ${t.message}`)}finally{L(!1),z("")}},_e=async()=>{var t,l;L(!0),M({current:0,total:0,percent:0});try{const n=Object.entries(R).filter(([a,i])=>i.success),r=n.length;M({current:0,total:r,percent:0});for(let a=0;a<n.length;a++){const[i,h]=n[a],p=S.find(m=>m.id===i);if(!p)continue;z(p.title);try{if(console.log("Applying SEO for collection:",i),console.log("Result data:",h.data),console.log("Results array:",(t=h.data)==null?void 0:t.results),!((l=h.data)!=null&&l.results)||!Array.isArray(h.data.results))throw new Error("Invalid results structure");const m=await b("/seo/apply-collection-multi",{method:"POST",shop:d,body:{shop:d,collectionId:i,results:h.data.results.map(_=>({language:_.language,seo:_.data})),options:{updateTitle:!0,updateDescription:!0,updateSeo:!0,updateMetafields:!0}}});if(!(m!=null&&m.ok))throw new Error((m==null?void 0:m.error)||"Apply failed")}catch(m){console.error("Apply error for collection:",i,m),F.push({id:p.id,title:p.title,message:m.message})}const x=a+1,y=Math.round(x/r*100);M({current:x,total:r,percent:y})}f("Optimization applied successfully!"),Y(!1),Q({}),U([]),await D()}catch(n){f(`Error applying optimization: ${n.message}`)}finally{L(!1),z("")}},Ke=async(t=[])=>{xe(!0),De("");try{const l=v?S:S.filter(i=>j.includes(i.id)),n=l.length*t.length;let r=0;const a=[];for(const i of l)for(const h of t)try{await b("/collections/delete-seo",{method:"DELETE",shop:d,body:{shop:d,collectionId:i.id,language:h}})}catch(p){console.error(`Failed to delete ${h} for ${i.title}:`,p),a.push({id:i.id,title:i.title,message:p.message})}finally{r++,M({current:r,total:n,percent:Math.round(r/n*100)})}f(`Deleted optimization for ${t.join(", ").toUpperCase()}`),setTimeout(async()=>{await D(),U([]),ee(!1),N(!1)},100)}catch(l){f(`Delete error: ${l.message}`)}finally{xe(!1),q([]),B([])}},Xe=t=>{var i,h;const l=((i=R[t.id])==null?void 0:i.success)||Se[t.id],n=((h=R[t.id])==null?void 0:h.data)||Se[t.id],r=t.optimizedLanguages||[],a=e.jsx(c,{width:"40px",height:"40px",background:"surface-neutral",borderRadius:"200"});return e.jsx(xt,{id:t.id,url:"",media:a,accessibilityLabel:`View details for ${t.title}`,children:e.jsxs(C,{gap:"400",align:"center",blockAlign:"center",wrap:!1,children:[e.jsxs(c,{style:{flex:"1 1 30%",minWidth:"200px"},children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:t.title}),e.jsxs(o,{variant:"bodySm",tone:"subdued",children:["Handle: ",t.handle]})]}),e.jsx(c,{style:{flex:"0 0 15%",minWidth:"100px",textAlign:"center"},children:e.jsxs(o,{variant:"bodyMd",children:[t.productsCount," products"]})}),e.jsx(c,{style:{flex:"0 0 25%",minWidth:"160px"},children:t.hasSeoData?e.jsx(C,{gap:"100",children:k.map(p=>e.jsx(X,{tone:r.includes(p)?"success":"subdued",size:"small",children:p.toUpperCase()},p))}):e.jsx(X,{tone:"subdued",children:"No AI Search Optimisation"})}),e.jsxs(c,{style:{flex:"0 0 15%",minWidth:"120px"},children:[l&&e.jsx(O,{size:"slim",onClick:()=>{ae(n),oe(!0)},children:"Preview JSON"}),!l&&t.hasSeoData&&e.jsx(O,{size:"slim",loading:$e,onClick:()=>Ve(t.id),children:"Preview JSON"})]})]})})},Ze=ne&&!g.processing&&e.jsx(u,{open:ne,title:"Processing Collections",onClose:()=>{},noScroll:!0,children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(o,{variant:"bodyMd",children:ge?`Processing: ${ge}`:"Preparing..."}),e.jsx(ce,{progress:I.percent}),e.jsxs(o,{variant:"bodySm",tone:"subdued",children:[I.current," of ",I.total," collections (",I.percent,"%)"]})]})})}),et=e.jsx(u,{open:Re,title:"Select Languages",primaryAction:{content:"Generate Optimization for AI Search",onAction:Ye,disabled:E.length===0},secondaryActions:[{content:"Cancel",onAction:()=>le(!1)}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(o,{variant:"bodyMd",children:["Select languages to generate AI Search Optimisation for ",v?"all":j.length," selected collections:"]}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(C,{gap:"200",wrap:!0,children:k.map(t=>e.jsx(ve,{label:t.toUpperCase(),checked:E.includes(t),onChange:l=>{G(l?[...E,t]:E.filter(n=>n!==t))}},t))})}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(O,{plain:!0,onClick:()=>{G(E.length===k.length?[]:[...k])},children:E.length===k.length?"Deselect all":"Select all"})})]})})}),tt=e.jsx(u,{open:Be&&!ne,title:"AI Search Optimisation Results",primaryAction:{content:"Apply Optimisation",onAction:_e,disabled:!Object.values(R).some(t=>t.success)},secondaryActions:[{content:"Cancel",onAction:()=>Y(!1)}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(C,{gap:"400",children:[e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"success",children:Object.values(R).filter(t=>t.success).length})]}),e.jsxs(c,{children:[e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(o,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:Object.values(R).filter(t=>!t.success).length})]})]}),F.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(ct,{}),e.jsx(o,{variant:"bodyMd",fontWeight:"semibold",children:"Errors:"}),e.jsxs(c,{maxHeight:"200px",overflowY:"scroll",children:[F.slice(0,10).map((t,l)=>e.jsxs(o,{variant:"bodySm",tone:"critical",children:[t.collection,": ",t.error]},l)),F.length>10&&e.jsxs(o,{variant:"bodySm",tone:"subdued",children:["... and ",F.length-10," more errors"]})]})]})]})})}),st=e.jsx(u,{open:We,title:"SEO Data Preview",secondaryActions:[{content:"Close",onAction:()=>{oe(!1),ae(null)}}],children:e.jsx(u.Section,{children:e.jsx(c,{children:e.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"12px",backgroundColor:"#f6f6f7",padding:"12px",borderRadius:"4px",maxHeight:"400px",overflow:"auto"},children:je?JSON.stringify(je,null,2):""})})})}),nt=e.jsx(u,{open:Le,title:"Delete Optimization for AI Search",onClose:()=>{J(!1),B([])},primaryAction:{content:"Continue",onAction:()=>{q(T),J(!1),V(!0)},disabled:T.length===0},secondaryActions:[{content:"Cancel",onAction:()=>{J(!1),B([])}}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsxs(o,{variant:"bodyMd",children:["Select languages to delete AI Search Optimisation from ",v?$:j.length," selected collections:"]}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(C,{gap:"400",wrap:!1,children:k.map(t=>e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer",userSelect:"none"},children:[e.jsx("input",{type:"checkbox",checked:T.includes(t),onChange:l=>{B(l.target.checked?[...T,t]:T.filter(n=>n!==t))},style:{marginRight:"8px",width:"18px",height:"18px",cursor:"pointer"}}),e.jsx(o,{variant:"bodyMd",children:t.toUpperCase()})]},t))})}),e.jsx(c,{children:e.jsx(O,{plain:!0,onClick:()=>{B(T.length===k.length?[]:[...k])},children:"Select all"})}),e.jsx(c,{paddingBlockStart:"300",children:e.jsx(o,{variant:"bodySm",children:"Warning: This will permanently delete AI Search Optimisation data for selected languages."})})]})})}),lt=e.jsx(u,{open:Te,title:"Confirm Deletion",onClose:()=>{V(!1),q([])},primaryAction:{content:"Delete",destructive:!0,onAction:async()=>{V(!1),setTimeout(()=>{Ke(me)},100)}},secondaryActions:[{content:"Cancel",onAction:()=>{V(!1),q([]),B([])}}],children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(o,{variant:"bodyMd",children:"Are you sure you want to delete AI Search Optimisation for the following languages?"}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(C,{gap:"200",children:me.map(t=>e.jsx(X,{tone:"warning",children:t.toUpperCase()},t))})}),e.jsxs(o,{variant:"bodyMd",children:["This will delete optimisation from ",v?$:j.length," selected collections."]}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(o,{variant:"bodySm",tone:"critical",children:"This action cannot be undone."})})]})})}),ot=fe&&e.jsx(u,{open:fe,title:"Deleting SEO Data",onClose:()=>{},noScroll:!0,children:e.jsx(u.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(o,{variant:"bodyMd",children:"Deleting selected languages..."}),e.jsx(ce,{progress:I.percent}),e.jsxs(o,{variant:"bodySm",tone:"subdued",children:[I.current," of ",I.total," operations (",I.percent,"%)"]})]})})}),at=e.jsx(mt,{heading:"No collections found",action:{content:"Clear filters",onAction:()=>{te(""),H("all"),D()}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Try adjusting your filters or search terms"})});return e.jsxs(e.Fragment,{children:[e.jsx(we,{children:e.jsxs(c,{padding:"400",children:[e.jsxs(C,{gap:"400",align:"space-between",blockAlign:"start",wrap:!1,children:[e.jsx(c,{minWidth:"400px",maxWidth:"600px",children:e.jsx(dt,{label:"",placeholder:"Search by collection name...",value:P,onChange:te,prefix:e.jsx(ht,{}),clearButton:!0,onClearButtonClick:()=>te("")})}),e.jsxs(A,{gap:"200",children:[e.jsx(O,{primary:!0,onClick:qe,disabled:j.length===0&&!v,children:"Generate Optimization for AI Search"}),j.length===0&&!v||!S.filter(n=>j.includes(n.id)).some(n=>{var r;return((r=n.optimizedLanguages)==null?void 0:r.length)>0})?null:e.jsx(O,{onClick:()=>ie(!0),disabled:j.length===0&&!v,children:"AI Enhanced add-ons for AI Search"}),e.jsx(O,{outline:!0,destructive:!0,onClick:()=>J(!0),disabled:j.length===0||!ze,children:"Delete Optimization for AI Search"})]})]}),$>0&&e.jsx(c,{paddingBlockStart:"300",children:e.jsx(ve,{label:`Select all ${$} collections`,checked:v,onChange:Je})})]})}),e.jsx(c,{paddingBlockStart:"400",children:e.jsxs(we,{children:[e.jsxs(c,{padding:"400",borderBlockEndWidth:"025",borderColor:"border",children:[e.jsx(C,{gap:"200",wrap:!0,children:e.jsx(ut,{active:he,activator:e.jsx(O,{disclosure:"down",onClick:()=>se(!he),removeUnderline:!0,children:e.jsxs(C,{gap:"100",blockAlign:"center",children:[e.jsx("span",{children:"AI Search Status"}),w!=="all"&&e.jsx(c,{onClick:t=>{t.stopPropagation(),H("all")},children:e.jsx(o,{as:"span",tone:"subdued",children:"✕"})})]})}),onClose:()=>se(!1),children:e.jsx(c,{padding:"300",minWidth:"200px",children:e.jsx(gt,{title:"AI Search Status",titleHidden:!0,choices:[{label:"All collections",value:"all"},{label:"Has AI Search Optimisation",value:"true"},{label:"No AI Search Optimisation",value:"false"}],selected:[w],onChange:t=>{H(t[0]),se(!1)}})})})}),w!=="all"&&e.jsx(c,{paddingBlockStart:"200",children:e.jsx(C,{gap:"100",wrap:!0,children:e.jsx(X,{onRemove:()=>H("all"),children:w==="true"?"Has AI Search Optimisation":"No AI Search Optimisation"})})})]}),e.jsx(pt,{resourceName:{singular:"collection",plural:"collections"},items:S,renderItem:Xe,selectedItems:j,onSelectionChange:Ge,selectable:!0,loading:Ee,totalItemsCount:$,emptyState:at,showHeader:!1})]})}),Ze,et,tt,st,nt,lt,ot,Qe(),e.jsx(it,{open:Ue,onClose:()=>Ce(!1),featureName:"AI Enhancement",currentPlan:Fe}),be&&e.jsx(ft,{content:be,onDismiss:()=>f("")})]})}export{zt as default};
