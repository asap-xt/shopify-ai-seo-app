import{j as e}from"./app-bridge-DJvLHO9Z-1758913664761.js";import{r as s}from"./react-vendor-tAaa2TlE-1758913664761.js";import{m as ot}from"./sessionFetch-oYyP4He9-1758913664761.js";import{U as lt}from"./UpgradeModal-Cf6a2LBY-1758913664761.js";import{M as p,d as A,T as d,e as xe,a as u,I as b,f as je,B as I,D as at,g as X,C as Ce,i as rt,S as it,P as ct,j as dt,R as ht,k as ut,m as gt,E as pt}from"./polaris-CSkHIexm-1758913664761.js";const ft=(B,r="")=>{try{return new URLSearchParams(window.location.search).get(B)||r}catch{return r}};function Pt({shop:B}){const r=B||ft("shop","");console.log("[COLLECTIONS] Component initialized with shop:",r,"shopProp:",B);const x=s.useMemo(()=>ot(),[]),[f,ye]=s.useState([]),[be,le]=s.useState(!1),[R,we]=s.useState(0),[S,$]=s.useState([]),[j,G]=s.useState(!1),[St,Ae]=s.useState(""),[L,Z]=s.useState(""),[C,J]=s.useState("all"),[ae,ee]=s.useState(!1),[Oe,ve]=s.useState(""),[mt,Ee]=s.useState([]),[O,V]=s.useState([]),[v,re]=s.useState([]),[te,D]=s.useState(!1),[E,w]=s.useState({current:0,total:0,percent:0}),[ie,T]=s.useState(""),[W,ce]=s.useState([]),[xt,jt]=s.useState(!1),[Ct,yt]=s.useState(null),[bt,wt]=s.useState(!1),[At,Ie]=s.useState(""),[Le,q]=s.useState(!1),[z,N]=s.useState([]),[de,he]=s.useState(!1),[ke,U]=s.useState(!1),[Me,Q]=s.useState(!1),[ue,Y]=s.useState([]),[k,_]=s.useState({}),[Pe,K]=s.useState(!1),[De,se]=s.useState(!1),[ge,Ot]=s.useState({}),[Te,ne]=s.useState(!1),[pe,oe]=s.useState(null),[ze,fe]=s.useState(!1),[Se,m]=s.useState(""),[Ne,F]=s.useState(!1),[Be,me]=s.useState(!1),[Re,$e]=s.useState("starter"),[We,vt]=s.useState({processing:!1,current:0,total:0,currentItem:"",results:null});s.useEffect(()=>{r&&x("/plans/me",{shop:r}).then(t=>{const o=(t==null?void 0:t.modelsSuggested)||["google/gemini-1.5-flash"];Ee(o.map(n=>({label:n,value:n}))),ve(o[0])}).catch(t=>m(`Error loading models: ${t.message}`))},[r,x]),s.useEffect(()=>{r&&(console.log("[COLLECTIONS] Loading languages for shop:",r),x(`/api/languages/shop/${r}?shop=${r}`).then(t=>(console.log("[COLLECTIONS] Languages API response:",t),t.json())).then(t=>{console.log("[COLLECTIONS] Languages API data:",t);const o=(t==null?void 0:t.shopLanguages)||["en"];console.log("[COLLECTIONS] Extracted languages:",o),re(o),V([])}).catch(t=>{console.error("[COLLECTIONS] Languages API error:",t),re(["en"]),V([])}))},[r,x]);const M=s.useCallback(async()=>{le(!0);try{console.log("[COLLECTIONS] Shop value:",r),console.log("[COLLECTIONS] Shop prop:",B),console.log("[COLLECTIONS] URL search params:",window.location.search);const o=`/collections/list-graphql?${new URLSearchParams({shop:r,...L&&{search:L},...C!=="all"&&{optimized:C}})}`;console.log("[COLLECTIONS] Using GraphQL endpoint:",o);const n=await x(o);if(console.log("[COLLECTIONS] API Response status:",n.status),!n.ok){const a=await n.text();throw console.error("[COLLECTIONS] API Error:",n.status,a),new Error(`API Error: ${n.status} ${a}`)}const h=await n.json();console.log("[COLLECTIONS] API Response data:",h);let l=h.collections||[];if(L){const a=L.toLowerCase();l=l.filter(i=>i.title.toLowerCase().includes(a)||i.handle.toLowerCase().includes(a))}C!=="all"&&(l=l.filter(a=>C==="true"?a.hasSeoData:!a.hasSeoData)),ye(l),we(l.length)}catch(t){m(`Error loading collections: ${t.message}`)}finally{le(!1)}},[r,L,C,x]);s.useEffect(()=>{r&&(M(),U(!1))},[r,C,M]),s.useEffect(()=>{const t=setTimeout(()=>{r&&M()},500);return()=>clearTimeout(t)},[L]);const Ue=s.useCallback(t=>{$(t);const o=t.some(n=>{const h=f.find(l=>l.id===n);return h==null?void 0:h.hasSeoData});U(o),t.length===0&&G(!1)},[f]),Fe=s.useCallback(t=>{if(G(t),t){$(f.map(n=>n.id));const o=f.some(n=>n.hasSeoData);U(o)}else $([]),U(!1)},[f]),He=async t=>{fe(!0);try{const o=`/collections/${t.split("/").pop()}/seo-data?shop=${encodeURIComponent(r)}`,n=await x(o);oe(n),ne(!0)}catch(o){m((o==null?void 0:o.status)===404?"No SEO data found for this collection":"Failed to load SEO data")}finally{fe(!1)}},Ge=()=>{if(S.length===0&&!j){m("Please select collections first");return}se(!0)},Je=async()=>{try{D(!0),Ae("Checking eligibility...");const t=await x("/ai-enhance/check-eligibility",{method:"POST",shop:r,body:{shop:r}});if(!t.eligible){$e(t.currentPlan||"starter"),F(!1),me(!0);return}F(!1);const n=f.filter(i=>S.includes(i.id)).filter(i=>{var c;return((c=i.optimizedLanguages)==null?void 0:c.length)>0}),h=n.length;w({current:0,total:h,percent:0});const l={};for(let i=0;i<n.length;i++){const c=n[i];T(c.title);try{const g=c.optimizedLanguages||[];if(g.length===0){console.log(`No optimized languages for ${c.title}, skipping`),l[c.id]={success:!1,skipped:!0,error:"No optimized languages"};continue}console.log(`Enhancing ${c.title} for languages:`,g);const P=await x(`/ai-enhance/collection/${encodeURIComponent(c.id)}`,{method:"POST",shop:r,body:{shop:r,languages:g}});l[c.id]={success:P.ok,skipped:!1,data:P,error:P.ok?null:P.error||"Enhancement failed"}}catch(g){console.error("Error enhancing collection:",c.id,g),l[c.id]={success:!1,skipped:!1,error:g.message}}const y=i+1,H=Math.round(y/h*100);w({current:y,total:h,percent:H})}_(l),K(!0);const a=Object.values(l).filter(i=>i.success).length;m(`Enhanced ${a} collections`),await M()}catch(t){console.error("AI Enhance error:",t),m("Failed to enhance collections")}finally{D(!1),T("")}},Ve=async()=>{if(!O.length){m("Please select at least one language");return}se(!1),D(!0),w({current:0,total:0,percent:0}),ce([]),_({});try{const t=j?f:f.filter(l=>S.includes(l.id)),o=t.length;w({current:0,total:o,percent:0});const n={};for(let l=0;l<t.length;l++){const a=t[l];T(a.title);try{const y=await x("/seo/generate-collection-multi",{method:"POST",shop:r,body:{shop:r,collectionId:a.id,model:Oe,languages:O}});n[a.id]={success:!0,data:y}}catch(y){n[a.id]={success:!1,error:y.message},ce(H=>[...H,{collection:a.title,error:y.message}])}const i=l+1,c=Math.round(i/o*100);w({current:i,total:o,percent:c})}_(n),K(!0);const h=Object.values(n).filter(l=>l.success).length;m(`Generated optimization for ${h} collections`)}catch(t){m(`Error: ${t.message}`)}finally{D(!1),T("")}},qe=async()=>{var t,o;D(!0),w({current:0,total:0,percent:0});try{const n=Object.entries(k).filter(([l,a])=>a.success),h=n.length;w({current:0,total:h,percent:0});for(let l=0;l<n.length;l++){const[a,i]=n[l],c=f.find(g=>g.id===a);if(!c)continue;T(c.title);try{if(console.log("Applying SEO for collection:",a),console.log("Result data:",i.data),console.log("Results array:",(t=i.data)==null?void 0:t.results),!((o=i.data)!=null&&o.results)||!Array.isArray(i.data.results))throw new Error("Invalid results structure");const g=await x("/seo/apply-collection-multi",{method:"POST",shop:r,body:{shop:r,collectionId:a,results:i.data.results.map(P=>({language:P.language,seo:P.data})),options:{updateTitle:!0,updateDescription:!0,updateSeo:!0,updateMetafields:!0}}});if(!(g!=null&&g.ok))throw new Error((g==null?void 0:g.error)||"Apply failed")}catch(g){console.error("Apply error for collection:",a,g),W.push({id:c.id,title:c.title,message:g.message})}const y=l+1,H=Math.round(y/h*100);w({current:y,total:h,percent:H})}m("Optimization applied successfully!"),K(!1),_({}),$([]),await M(),G(!1)}catch(n){m(`Error applying optimization: ${n.message}`)}finally{D(!1),T("")}},Qe=async(t=[])=>{he(!0),Ie("");try{const o=j?f:f.filter(a=>S.includes(a.id)),n=o.length*t.length;let h=0;const l=[];for(const a of o)for(const i of t)try{await x("/collections/delete-seo",{method:"DELETE",shop:r,body:{shop:r,collectionId:a.id,language:i}})}catch(c){console.error(`Failed to delete ${i} for ${a.title}:`,c),l.push({id:a.id,title:a.title,message:c.message})}finally{h++,w({current:h,total:n,percent:Math.round(h/n*100)})}m(`Deleted optimization for ${t.join(", ").toUpperCase()}`),setTimeout(async()=>{await M(),$([]),G(!1),U(!1)},100)}catch(o){m(`Delete error: ${o.message}`)}finally{he(!1),Y([]),N([])}},Ye=t=>{var a,i;const o=((a=k[t.id])==null?void 0:a.success)||ge[t.id],n=((i=k[t.id])==null?void 0:i.data)||ge[t.id],h=t.optimizedLanguages||[],l=e.jsx(u,{width:"40px",height:"40px",background:"surface-neutral",borderRadius:"200"});return e.jsx(gt,{id:t.id,url:"",media:l,accessibilityLabel:`View details for ${t.title}`,children:e.jsxs(b,{gap:"400",align:"center",blockAlign:"center",wrap:!1,children:[e.jsxs(u,{style:{flex:"1 1 30%",minWidth:"200px"},children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:t.title}),e.jsxs(d,{variant:"bodySm",tone:"subdued",children:["Handle: ",t.handle]})]}),e.jsx(u,{style:{flex:"0 0 15%",minWidth:"100px",textAlign:"center"},children:e.jsxs(d,{variant:"bodyMd",children:[t.productsCount," products"]})}),e.jsx(u,{style:{flex:"0 0 25%",minWidth:"160px"},children:t.hasSeoData?e.jsx(b,{gap:"100",children:v.map(c=>e.jsx(X,{tone:h.includes(c)?"success":"subdued",size:"small",children:c.toUpperCase()},c))}):e.jsx(X,{tone:"subdued",children:"No AI Search Optimisation"})}),e.jsxs(u,{style:{flex:"0 0 15%",minWidth:"120px"},children:[o&&e.jsx(I,{size:"slim",onClick:()=>{oe(n),ne(!0)},children:"Preview JSON"}),!o&&t.hasSeoData&&e.jsx(I,{size:"slim",loading:ze,onClick:()=>He(t.id),children:"Preview JSON"})]})]})})},_e=te&&!We.processing&&e.jsx(p,{open:te,title:"Processing Collections",onClose:()=>{},noScroll:!0,children:e.jsx(p.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(d,{variant:"bodyMd",children:ie?`Processing: ${ie}`:"Preparing..."}),e.jsx(xe,{progress:E.percent}),e.jsxs(d,{variant:"bodySm",tone:"subdued",children:[E.current," of ",E.total," collections (",E.percent,"%)"]})]})})}),Ke=e.jsx(p,{open:De,title:"Select Languages",primaryAction:{content:"Generate Optimization for AI Search",onAction:Ve,disabled:O.length===0},secondaryActions:[{content:"Cancel",onAction:()=>se(!1)}],children:e.jsx(p.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(d,{variant:"bodyMd",children:["Select languages to generate AI Search Optimisation for ",j?"all":S.length," selected collections:"]}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(b,{gap:"200",wrap:!0,children:v.map(t=>e.jsx(je,{label:t.toUpperCase(),checked:O.includes(t),onChange:o=>{V(o?[...O,t]:O.filter(n=>n!==t))}},t))})}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(I,{plain:!0,onClick:()=>{V(O.length===v.length?[]:[...v])},children:O.length===v.length?"Deselect all":"Select all"})})]})})}),Xe=e.jsx(p,{open:Pe&&!te,title:"AI Search Optimisation Results",primaryAction:{content:"Apply Optimisation",onAction:qe,disabled:!Object.values(k).some(t=>t.success)},secondaryActions:[{content:"Cancel",onAction:()=>K(!1)}],children:e.jsx(p.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(b,{gap:"400",children:[e.jsxs(u,{children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(d,{variant:"headingLg",fontWeight:"bold",tone:"success",children:Object.values(k).filter(t=>t.success&&!t.skipped).length})]}),e.jsxs(u,{children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Skipped:"}),e.jsx(d,{variant:"headingLg",fontWeight:"bold",tone:"info",children:Object.values(k).filter(t=>t.skipped).length})]}),e.jsxs(u,{children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(d,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:Object.values(k).filter(t=>!t.success&&!t.skipped).length})]})]}),W.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(at,{}),e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Errors:"}),e.jsxs(u,{maxHeight:"200px",overflowY:"scroll",children:[W.slice(0,10).map((t,o)=>e.jsxs(d,{variant:"bodySm",tone:"critical",children:[t.collection,": ",t.error]},o)),W.length>10&&e.jsxs(d,{variant:"bodySm",tone:"subdued",children:["... and ",W.length-10," more errors"]})]})]})]})})}),Ze=e.jsx(p,{open:Te,title:"SEO Data Preview",secondaryActions:[{content:"Close",onAction:()=>{ne(!1),oe(null)}}],children:e.jsx(p.Section,{children:e.jsx(u,{children:e.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"12px",backgroundColor:"#f6f6f7",padding:"12px",borderRadius:"4px",maxHeight:"400px",overflow:"auto"},children:pe?JSON.stringify(pe,null,2):""})})})}),et=e.jsx(p,{open:Le,title:"Delete Optimization for AI Search",onClose:()=>{q(!1),N([])},primaryAction:{content:"Continue",onAction:()=>{Y(z),q(!1),Q(!0)},disabled:z.length===0},secondaryActions:[{content:"Cancel",onAction:()=>{q(!1),N([])}}],children:e.jsx(p.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsxs(d,{variant:"bodyMd",children:["Select languages to delete AI Search Optimisation from ",j?R:S.length," selected collections:"]}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(b,{gap:"400",wrap:!1,children:v.map(t=>e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer",userSelect:"none"},children:[e.jsx("input",{type:"checkbox",checked:z.includes(t),onChange:o=>{N(o.target.checked?[...z,t]:z.filter(n=>n!==t))},style:{marginRight:"8px",width:"18px",height:"18px",cursor:"pointer"}}),e.jsx(d,{variant:"bodyMd",children:t.toUpperCase()})]},t))})}),e.jsx(u,{children:e.jsx(I,{plain:!0,onClick:()=>{N(z.length===v.length?[]:[...v])},children:"Select all"})}),e.jsx(u,{paddingBlockStart:"300",children:e.jsx(d,{variant:"bodySm",children:"Warning: This will permanently delete AI Search Optimisation data for selected languages."})})]})})}),tt=e.jsx(p,{open:Me,title:"Confirm Deletion",onClose:()=>{Q(!1),Y([])},primaryAction:{content:"Delete",destructive:!0,onAction:async()=>{Q(!1),setTimeout(()=>{Qe(ue)},100)}},secondaryActions:[{content:"Cancel",onAction:()=>{Q(!1),Y([]),N([])}}],children:e.jsx(p.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(d,{variant:"bodyMd",children:"Are you sure you want to delete AI Search Optimisation for the following languages?"}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(b,{gap:"200",children:ue.map(t=>e.jsx(X,{tone:"warning",children:t.toUpperCase()},t))})}),e.jsxs(d,{variant:"bodyMd",children:["This will delete optimisation from ",j?R:S.length," selected collections."]}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(d,{variant:"bodySm",tone:"critical",children:"This action cannot be undone."})})]})})}),st=de&&e.jsx(p,{open:de,title:"Deleting SEO Data",onClose:()=>{},noScroll:!0,children:e.jsx(p.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(d,{variant:"bodyMd",children:"Deleting selected languages..."}),e.jsx(xe,{progress:E.percent}),e.jsxs(d,{variant:"bodySm",tone:"subdued",children:[E.current," of ",E.total," operations (",E.percent,"%)"]})]})})}),nt=e.jsx(pt,{heading:"No collections found",action:{content:"Clear filters",onAction:()=>{Z(""),J("all"),M()}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Try adjusting your filters or search terms"})});return e.jsxs(e.Fragment,{children:[e.jsx(Ce,{children:e.jsxs(u,{padding:"400",children:[e.jsxs(b,{gap:"400",align:"space-between",blockAlign:"start",wrap:!1,children:[e.jsx(u,{minWidth:"400px",maxWidth:"600px",children:e.jsx(A,{gap:"200",children:e.jsx(rt,{label:"",placeholder:"Search by collection name...",value:L,onChange:Z,prefix:e.jsx(it,{}),clearButton:!0,onClearButtonClick:()=>Z("")})})}),e.jsxs(A,{gap:"200",children:[e.jsx(I,{primary:!0,onClick:Ge,disabled:S.length===0&&!j,children:"Generate Optimization for AI Search"}),S.length===0&&!j||!f.filter(n=>S.includes(n.id)).some(n=>{var h;return((h=n.optimizedLanguages)==null?void 0:h.length)>0})?null:e.jsx(I,{onClick:()=>F(!0),disabled:S.length===0&&!j,children:"AI Enhanced add-ons for AI Search"}),e.jsx(I,{outline:!0,destructive:!0,onClick:()=>q(!0),disabled:S.length===0||!ke,children:"Delete Optimization for AI Search"})]})]}),R>0&&e.jsx(u,{paddingBlockStart:"300",children:e.jsx(je,{label:`Select all ${R} collections`,checked:j,onChange:Fe})})]})}),e.jsx(u,{paddingBlockStart:"400",children:e.jsxs(Ce,{children:[e.jsxs(u,{padding:"400",borderBlockEndWidth:"025",borderColor:"border",children:[e.jsx(b,{gap:"200",wrap:!0,children:e.jsx(ct,{active:ae,activator:e.jsx(I,{disclosure:"down",onClick:()=>ee(!ae),removeUnderline:!0,children:e.jsxs(b,{gap:"100",blockAlign:"center",children:[e.jsx("span",{children:"AI Search Status"}),C!=="all"&&e.jsx(u,{onClick:t=>{t.stopPropagation(),J("all")},children:e.jsx(d,{as:"span",tone:"subdued",children:"✕"})})]})}),onClose:()=>ee(!1),children:e.jsx(u,{padding:"300",minWidth:"200px",children:e.jsx(dt,{title:"AI Search Status",titleHidden:!0,choices:[{label:"All collections",value:"all"},{label:"Has AI Search Optimisation",value:"true"},{label:"No AI Search Optimisation",value:"false"}],selected:[C],onChange:t=>{J(t[0]),ee(!1)}})})})}),C!=="all"&&e.jsx(u,{paddingBlockStart:"200",children:e.jsx(b,{gap:"100",wrap:!0,children:e.jsx(X,{onRemove:()=>J("all"),children:C==="true"?"Has AI Search Optimisation":"No AI Search Optimisation"})})})]}),e.jsx(ht,{resourceName:{singular:"collection",plural:"collections"},items:f,renderItem:Ye,selectedItems:S,onSelectionChange:Ue,selectable:!0,loading:be,totalItemsCount:R,emptyState:nt,showHeader:!1})]})}),_e,Ke,Xe,Ze,et,tt,st,e.jsx(p,{open:Ne,onClose:()=>F(!1),title:"AI Enhanced add-ons for AI Search",primaryAction:{content:"Start AI Enhancement",onAction:Je},secondaryActions:[{content:"Cancel",onAction:()=>F(!1)}],children:e.jsx(p.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(d,{variant:"bodyMd",children:["AI enhancement will improve bullets and FAQ for ",f.filter(t=>{var o;return S.includes(t.id)&&((o=t.optimizedLanguages)==null?void 0:o.length)>0}).length," collections."]}),e.jsx(d,{variant:"bodySm",tone:"subdued",children:"Note: AI enhancement is only available for Growth Extra and Enterprise plans."})]})})}),e.jsx(lt,{open:Be,onClose:()=>me(!1),featureName:"AI Enhancement",currentPlan:Re}),Se&&e.jsx(ut,{content:Se,onDismiss:()=>m("")})]})}export{Pt as default};
