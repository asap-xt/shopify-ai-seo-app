import{j as e}from"./app-bridge-BXW6T1kI-1760285514483.js";import{r as o}from"./react-vendor-tAaa2TlE-1760285514483.js";import{c as R,L as h,C as p,a as E,I as l,r as K,T as t,w as Q,x as N,h as T,d,g as L,D as w,B as m,n as V,e as X,M as P,y as Z,i as ee}from"./polaris-BwdnrZS4-1760285514483.js";const A=[10,20,50,100];function re({shop:f}){var $,F,O;const[Y,D]=o.useState(!0),[r,z]=o.useState(null),[W,C]=o.useState(null),[J,u]=o.useState(!1),[q,j]=o.useState(!1),[g,y]=o.useState(""),[b,S]=o.useState(A[0]),[v,k]=o.useState(!1),[U,x]=o.useState(null),M=o.useCallback(async()=>{try{D(!0),x(null);const a=await fetch(`/api/billing/info?shop=${f}`,{headers:{"Content-Type":"application/json"}});if(!a.ok)throw new Error(`HTTP ${a.status}`);const s=await a.json();z(s)}catch(a){console.error("[Billing] Error fetching info:",a),x("Failed to load billing information")}finally{D(!1)}},[f]);o.useEffect(()=>{M()},[M]);const G=async a=>{var s;try{k(!0),x(null);const c=await fetch("/api/billing/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:f,plan:a,endTrial:((s=r==null?void 0:r.subscription)==null?void 0:s.inTrial)||!1})}),B=await c.json();if(!c.ok)throw new Error(B.error||"Failed to create subscription");B.confirmationUrl&&(window.top.location.href=B.confirmationUrl)}catch(c){console.error("[Billing] Subscribe error:",c),x(c.message)}finally{k(!1),u(!1)}},H=async a=>{try{k(!0),x(null);const s=await fetch("/api/billing/tokens/purchase",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:f,amount:parseFloat(a)})}),c=await s.json();if(!s.ok)throw new Error(c.error||"Failed to purchase tokens");c.confirmationUrl&&(window.top.location.href=c.confirmationUrl)}catch(s){console.error("[Billing] Purchase error:",s),x(s.message)}finally{k(!1),j(!1)}},I=a=>{const s=a*.6;return Math.floor(s*1e4)};if(Y)return e.jsx(R,{title:"Billing & Subscriptions",children:e.jsx(h,{children:e.jsx(h.Section,{children:e.jsx(p,{children:e.jsx(E,{padding:"800",children:e.jsxs(l,{align:"center",blockAlign:"center",children:[e.jsx(K,{size:"large"}),e.jsx(t,{variant:"bodyMd",children:"Loading billing information..."})]})})})})})});const n=r==null?void 0:r.subscription,i=r==null?void 0:r.tokens,_=(r==null?void 0:r.plans)||[];return e.jsxs(R,{title:"Billing & Subscriptions",primaryAction:{content:"Purchase Tokens",icon:N,onAction:()=>j(!0)},secondaryActions:[{content:"Refresh",icon:Q,onAction:M}],children:[e.jsxs(h,{children:[U&&e.jsx(h.Section,{children:e.jsx(T,{title:"Error",tone:"critical",onDismiss:()=>x(null),children:e.jsx("p",{children:U})})}),(n==null?void 0:n.inTrial)&&e.jsx(h.Section,{children:e.jsx(T,{title:"You are in trial period",tone:"info",action:{content:"Activate Plan",onAction:()=>u(!0)},children:e.jsxs("p",{children:["Your trial ends on ",new Date(n.trialEndsAt).toLocaleDateString(),". AI-enhanced features require plan activation or token purchase."]})})}),e.jsx(h.Section,{variant:"oneThird",children:e.jsx(p,{children:e.jsxs(d,{gap:"400",children:[e.jsxs(l,{align:"space-between",blockAlign:"center",children:[e.jsx(t,{variant:"headingMd",children:"Current Plan"}),n&&e.jsx(L,{tone:n.inTrial?"attention":"success",children:n.inTrial?"Trial":"Active"})]}),e.jsx(w,{}),n?e.jsxs(d,{gap:"300",children:[e.jsxs(l,{align:"space-between",children:[e.jsx(t,{variant:"bodyMd",tone:"subdued",children:"Plan"}),e.jsx(t,{variant:"bodyMd",fontWeight:"semibold",children:n.plan.charAt(0).toUpperCase()+n.plan.slice(1)})]}),e.jsxs(l,{align:"space-between",children:[e.jsx(t,{variant:"bodyMd",tone:"subdued",children:"Price"}),e.jsxs(t,{variant:"bodyMd",fontWeight:"semibold",children:["$",n.price,"/month"]})]}),n.inTrial&&e.jsxs(l,{align:"space-between",children:[e.jsx(t,{variant:"bodyMd",tone:"subdued",children:"Trial ends"}),e.jsx(t,{variant:"bodyMd",fontWeight:"semibold",children:new Date(n.trialEndsAt).toLocaleDateString()})]}),e.jsx(m,{variant:"primary",fullWidth:!0,onClick:()=>u(!0),children:"Change Plan"})]}):e.jsxs(d,{gap:"300",children:[e.jsx(t,{variant:"bodyMd",tone:"subdued",children:"No active subscription"}),e.jsx(m,{variant:"primary",fullWidth:!0,onClick:()=>u(!0),children:"Choose a Plan"})]})]})})}),e.jsx(h.Section,{variant:"oneThird",children:e.jsx(p,{children:e.jsxs(d,{gap:"400",children:[e.jsxs(l,{align:"space-between",blockAlign:"center",children:[e.jsx(t,{variant:"headingMd",children:"Token Balance"}),e.jsx(V,{source:N,tone:"base"})]}),e.jsx(w,{}),e.jsxs(d,{gap:"300",children:[e.jsxs(E,{children:[e.jsx(t,{variant:"heading2xl",alignment:"center",children:(($=i==null?void 0:i.balance)==null?void 0:$.toLocaleString())||0}),e.jsx(t,{variant:"bodySm",tone:"subdued",alignment:"center",children:"tokens available"})]}),e.jsx(X,{progress:Math.min(100,(i==null?void 0:i.balance)/1e4*100),size:"small",tone:"primary"}),e.jsxs(l,{align:"space-between",children:[e.jsx(t,{variant:"bodySm",tone:"subdued",children:"Purchased"}),e.jsx(t,{variant:"bodySm",children:((F=i==null?void 0:i.totalPurchased)==null?void 0:F.toLocaleString())||0})]}),e.jsxs(l,{align:"space-between",children:[e.jsx(t,{variant:"bodySm",tone:"subdued",children:"Used"}),e.jsx(t,{variant:"bodySm",children:((O=i==null?void 0:i.totalUsed)==null?void 0:O.toLocaleString())||0})]}),e.jsx(m,{variant:"primary",fullWidth:!0,onClick:()=>j(!0),children:"Buy More Tokens"})]})]})})}),e.jsx(h.Section,{children:e.jsx(p,{children:e.jsxs(d,{gap:"400",children:[e.jsx(t,{variant:"headingLg",children:"Available Plans"}),e.jsx(w,{}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))",gap:"16px"},children:_.map(a=>e.jsx(p,{children:e.jsxs(d,{gap:"300",children:[e.jsxs(l,{align:"space-between",blockAlign:"center",children:[e.jsx(t,{variant:"headingMd",children:a.name}),(n==null?void 0:n.plan)===a.key&&e.jsx(L,{tone:"success",children:"Current"})]}),e.jsxs(t,{variant:"heading2xl",children:["$",a.price]}),e.jsx(t,{variant:"bodySm",tone:"subdued",children:"per month"}),a.includedTokens>0&&e.jsxs(L,{tone:"info",children:["+",a.includedTokens.toLocaleString()," tokens/month"]}),e.jsx(m,{variant:(n==null?void 0:n.plan)===a.key?"secondary":"primary",fullWidth:!0,disabled:(n==null?void 0:n.plan)===a.key,onClick:()=>{C(a.key),u(!0)},children:(n==null?void 0:n.plan)===a.key?"Current Plan":"Select Plan"})]})},a.key))})]})})})]}),e.jsx(P,{open:J,onClose:()=>{u(!1),C(null)},title:"Confirm Plan Selection",primaryAction:{content:v?"Processing...":"Confirm",loading:v,onAction:()=>G(W||(n==null?void 0:n.plan))},secondaryActions:[{content:"Cancel",onAction:()=>{u(!1),C(null)}}],children:e.jsx(P.Section,{children:e.jsxs(d,{gap:"400",children:[e.jsxs(t,{children:["You are about to subscribe to the ",e.jsx("strong",{children:W||(n==null?void 0:n.plan)})," plan."]}),(n==null?void 0:n.inTrial)&&e.jsx(T,{tone:"warning",children:e.jsx("p",{children:"This will end your trial period and start billing immediately."})})]})})}),e.jsx(P,{open:q,onClose:()=>{j(!1),y(""),S(A[0])},title:"Purchase Tokens",primaryAction:{content:v?"Processing...":"Purchase",loading:v,onAction:()=>H(g||b)},secondaryActions:[{content:"Cancel",onAction:()=>{j(!1),y(""),S(A[0])}}],children:e.jsx(P.Section,{children:e.jsxs(d,{gap:"400",children:[e.jsx(t,{variant:"headingMd",children:"Select Amount"}),e.jsx(Z,{variant:"segmented",children:A.map(a=>e.jsxs(m,{pressed:b===a&&!g,onClick:()=>{S(a),y("")},children:["$",a]},a))}),e.jsx(t,{variant:"bodyMd",tone:"subdued",children:"Or enter a custom amount (multiples of $5)"}),e.jsx(ee,{type:"number",value:g,onChange:a=>{y(a),S(null)},placeholder:"Enter amount",prefix:"$",min:5,step:5,autoComplete:"off"}),e.jsx(E,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:e.jsxs(d,{gap:"200",children:[e.jsxs(l,{align:"space-between",children:[e.jsx(t,{variant:"bodyMd",children:"Amount"}),e.jsxs(t,{variant:"bodyMd",fontWeight:"semibold",children:["$",g||b]})]}),e.jsxs(l,{align:"space-between",children:[e.jsx(t,{variant:"bodyMd",children:"Tokens"}),e.jsx(t,{variant:"bodyMd",fontWeight:"semibold",children:I(parseFloat(g||b)).toLocaleString()})]}),e.jsx(w,{}),e.jsx(t,{variant:"bodySm",tone:"subdued",children:"60% goes to tokens, 40% to app maintenance"})]})}),(n==null?void 0:n.inTrial)&&e.jsx(T,{tone:"info",children:e.jsx("p",{children:"Your trial will continue after purchasing tokens."})})]})})})]})}export{re as default};
