import{r as e,j as t}from"./react-vendor-BXVC7v0l.js";import{m as n}from"./sessionFetch-CmgJKowD.js";import{T as a,I as i,a as s}from"./TokenPurchaseModal-DnK58cDo.js";import{U as o}from"./UpgradeModal-DYlOzGkq.js";import{C as r,B as l,a as d,d as u,I as c,i as p,T as m,o as g,p as h,q as v,b as f,r as b,f as x,D as j,M as S,l as y}from"./polaris-LiLfZG0r.js";import"./app-bridge-DUY42B6P.js";import"./vendor-Cs_VgJ2r.js";import"./index-C-Mnz8nd.js";const w={"ai-seo-product-enhanced":{base:2e3,perLanguage:1500,description:"Enhanced AI SEO with rich attributes"},"ai-seo-collection":{base:1500,perLanguage:1200,description:"AI SEO optimization for collection"},"ai-schema-advanced":{base:3e3,perProduct:150,description:"Advanced schema data generation"},"ai-sitemap-optimized":{base:2e3,perProduct:2500,description:"AI-optimized sitemap generation"}};function A(e,t={}){const n=w[e];if(!n)return{estimated:0,withMargin:0,perItem:0,itemCount:0};const{productCount:a=0,collectionCount:i=0,languages:s=1}=t;let o=0,r=0,l=0;switch(e){case"ai-seo-product-enhanced":r=n.base+s*n.perLanguage,l=a,o=a*r;break;case"ai-seo-collection":r=n.base+s*n.perLanguage,l=i,o=i*r;break;case"ai-schema-advanced":case"ai-sitemap-optimized":r=n.perProduct,l=a,o=n.base+a*n.perProduct;break;default:o=n.base}return{estimated:o,withMargin:Math.ceil(1.5*o),perItem:r,itemCount:l,feature:e,formula:k(e,t)}}function k(e,t){const n=w[e],{productCount:a=0,collectionCount:i=0,languages:s=1}=t;switch(e){case"ai-seo-product-enhanced":return`${a} products Ã— (${n.base} + ${s} Ã— ${n.perLanguage})`;case"ai-seo-collection":return`${i} collections Ã— (${n.base} + ${s} Ã— ${n.perLanguage})`;case"ai-schema-advanced":case"ai-sitemap-optimized":return`${n.base} + (${a} Ã— ${n.perProduct})`;default:return`base: ${n.base}`}}function C({shop:w}){var k,C;const P=w||((e,t="")=>{try{return new URLSearchParams(window.location.search).get(e)||t}catch{return t}})("shop",""),[I,z]=e.useState(null),[T,$]=e.useState(!1),[_,R]=e.useState(""),[M,q]=e.useState(null),[E,O]=e.useState(null),[L,G]=e.useState(!1),N=e.useMemo(()=>n(),[]),[U,F]=e.useState(!1),[B,D]=e.useState(null),[W,H]=e.useState(!1),[Y,Q]=e.useState({inProgress:!1,status:"idle",message:null,position:null,estimatedTime:null,generatedAt:null,productCount:0}),J=e.useRef(null),[K,V]=e.useState(!1),[X,Z]=e.useState(null),[ee,te]=e.useState(!1),[ne,ae]=e.useState(!1),[ie,se]=e.useState(!1),[oe,re]=e.useState(!1),[le,de]=e.useState(null),[ue,ce]=e.useState(!1),[pe,me]=e.useState(null),[ge,he]=e.useState(!1),ve=e.useCallback(async()=>{if(P)try{const e=await N(`/api/sitemap/info?shop=${P}`);z(e)}catch(e){R(e.message||"Failed to load sitemap info")}},[P,N]),fe=e.useCallback(async()=>{var e,t,n;if(P)try{const a="\n        query PlansMe($shop:String!) {\n          plansMe(shop:$shop) {\n            shop\n            plan\n            planKey\n            priceUsd\n            product_limit\n            collection_limit\n            language_limit\n            providersAllowed\n            modelsSuggested\n            autosyncCron\n            trial {\n              active\n              ends_at\n              days_left\n            }\n          }\n        }\n      ",i=await N("/graphql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:a,variables:{shop:P}})});if(null==(e=null==i?void 0:i.errors)?void 0:e.length)throw new Error((null==(t=i.errors[0])?void 0:t.message)||"GraphQL error");const s=null==(n=null==i?void 0:i.data)?void 0:n.plansMe;q(s||null)}catch(a){}},[P,N]),be=e.useCallback(async()=>{var e,t,n,a;if(P){$(!0),O(null);try{const i=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(P)}`,{method:"POST",credentials:"include",headers:{Authorization:`Bearer ${(null==(n=null==(t=null==(e=window.__SHOPIFY_APP_BRIDGE__)?void 0:e.getState())?void 0:t.session)?void 0:n.token)||""}`,"Content-Type":"application/json"}});if(i.ok){const e=await i.json();e.success?(R(e.message||"Sitemap generation started!"),O(e.job),(null==(a=e.job)?void 0:a.queued)&&G(!0)):R(e.message||"Sitemap generation failed")}else{const e=await i.text();R(`Sitemap generation failed: ${e}`)}}catch(i){R(i.message||"Sitemap generation failed")}finally{$(!1)}}},[P]),xe=e.useCallback(async()=>{if(P&&L)try{const e=await N(`/api/sitemap/status?shop=${P}`);O(e.queue),"completed"!==e.queue.status&&"failed"!==e.queue.status&&"idle"!==e.queue.status||(G(!1),R(e.queue.message||"Sitemap generation completed!"),await ve())}catch(e){}},[P,L,N,ve]);e.useEffect(()=>{if(L){const e=setInterval(xe,3e3);return()=>clearInterval(e)}},[L,xe]);const je=e.useCallback(async()=>{var e,t,n;if(P){F(!0),H(!0),D(null);try{const a=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(P)}&force=true&t=${Date.now()}`,{method:"GET",credentials:"include",headers:{Authorization:`Bearer ${(null==(n=null==(t=null==(e=window.__SHOPIFY_APP_BRIDGE__)?void 0:e.getState())?void 0:t.session)?void 0:n.token)||""}`}});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);{const e=await a.text();D(e)}}catch(a){D(`Error loading sitemap: ${a.message}`)}finally{H(!1)}}},[P]),Se=e=>{if(!e)return"";const t=Math.floor((new Date-new Date(e))/1e3);if(t<60)return"just now";const n=Math.floor(t/60);if(n<60)return`${n}m ago`;const a=Math.floor(n/60);if(a<24)return`${a}h ago`;return`${Math.floor(a/24)}d ago`},ye=e.useCallback(async()=>{var e,t;if(P)try{const n=await N(`/api/sitemap/status?shop=${P}`);(null==(e=n.sitemap)?void 0:e.generatedAt)&&!0===(null==(t=n.sitemap)?void 0:t.isAiEnhanced)?Z({generated:!0,generatedAt:n.sitemap.generatedAt,productCount:n.sitemap.productCount||0}):Z(null)}catch(n){}},[P,N]),we=e.useCallback(async()=>{try{const e=await N(`/api/sitemap/status?shop=${P}`);return Q(t=>{var n,a,i,s,o;return t.inProgress&&!e.inProgress&&("completed"===e.status||"failed"===e.status)&&(J.current&&(clearInterval(J.current),J.current=null),"completed"===e.status?(R(`AI-Optimized Sitemap generated! (${(null==(n=e.sitemap)?void 0:n.productCount)||0} products)`),ye()):"failed"===e.status&&R("AI-Optimized Sitemap generation failed")),{inProgress:e.inProgress||!1,status:e.status||"idle",message:e.message||null,position:(null==(a=e.queue)?void 0:a.position)||null,estimatedTime:(null==(i=e.queue)?void 0:i.estimatedTime)||null,generatedAt:(null==(s=e.sitemap)?void 0:s.generatedAt)||null,productCount:(null==(o=e.sitemap)?void 0:o.productCount)||0}}),e}catch(e){}},[P,N,ye]),Ae=e.useCallback(()=>{J.current&&clearInterval(J.current),we(),J.current=setInterval(()=>{we()},5e3)},[we]),ke=e.useCallback(async()=>{var e,t,n;if(P){V(!0);try{let s=I;if(!(null==s?void 0:s.productCount)&&!(null==s?void 0:s.lastProductCount))try{s=await N(`/api/sitemap/info?shop=${P}`),z(s)}catch(a){}const o=((null==M?void 0:M.plan)||"starter").toLowerCase().replace(" ","_"),r=["growth_extra","growth extra","enterprise"],l=["professional_plus","professional plus","growth_plus","growth plus"].includes(o);if(!r.includes(o)&&!l)return re(!0),void V(!1);if(l)try{const e=(await N(`/api/billing/tokens/balance?shop=${P}`)).balance||0,t=A("ai-sitemap-optimized",{productCount:(null==s?void 0:s.productCount)||(null==s?void 0:s.lastProductCount)||0});if(!(e>=t.withMargin))return de({feature:"ai-sitemap-optimized",tokensRequired:t.withMargin,tokensAvailable:e,tokensNeeded:Math.max(0,t.withMargin-e)}),ae(!0),void V(!1)}catch(i){return R("Failed to check token balance"),void V(!1)}const d=await N("/graphql",{method:"POST",body:JSON.stringify({query:"mutation RegenerateSitemap($shop: String!) {\n            regenerateSitemap(shop: $shop) {\n              success\n              message\n              queued\n              position\n              estimatedTime\n            }\n          }",variables:{shop:P}})});if(null==(e=null==d?void 0:d.errors)?void 0:e.length){const e=(null==(t=d.errors[0])?void 0:t.message)||"GraphQL error";if(e.includes("TRIAL_RESTRICTION"))return de({trialRestriction:!0,requiresActivation:!0,message:"AI-Optimized Sitemap is locked during trial period. Activate your plan to unlock."}),void te(!0);throw new Error(e)}const u=null==(n=null==d?void 0:d.data)?void 0:n.regenerateSitemap;if(null==u?void 0:u.success)R(u.message||"AI-Optimized Sitemap generation started!"),u.queued&&(Q({inProgress:!0,status:"queued",message:"Queued for processing...",position:u.position,estimatedTime:u.estimatedTime,generatedAt:null,productCount:0}),Ae());else{const e=(null==u?void 0:u.message)||"";if(e.startsWith("TRIAL_RESTRICTION:"))return V(!1),de({trialRestriction:!0,requiresActivation:!0,feature:"ai-sitemap-optimized",currentPlan:(null==M?void 0:M.plan)||"enterprise"}),void te(!0);if(e.startsWith("INSUFFICIENT_TOKENS:")){V(!1);const e=A("ai-sitemap-optimized",{productCount:(null==s?void 0:s.productCount)||(null==s?void 0:s.lastProductCount)||0});return de({feature:"ai-sitemap-optimized",tokensRequired:e.withMargin,tokensAvailable:0,tokensNeeded:e.withMargin}),void ae(!0)}if(e.startsWith("PLAN_NOT_ELIGIBLE:"))return V(!1),setUpgradeModalData({featureName:"AI-Optimized Sitemap",currentPlan:(null==M?void 0:M.plan)||"starter",minimumPlanRequired:"Growth Extra",errorMessage:"Your plan does not include AI-Optimized Sitemap. Upgrade to Growth Extra or Enterprise, or purchase tokens on a Plus plan."}),void re(!0);R((null==u?void 0:u.message)||"Failed to start AI-Optimized Sitemap generation")}}catch(i){if(402===i.status&&i.trialRestriction&&i.requiresActivation)de({trialRestriction:!0,requiresActivation:!0,feature:"ai-sitemap-optimized",currentPlan:(null==M?void 0:M.plan)||"enterprise"}),te(!0);else if(402===i.status||i.requiresPurchase){const e=A("ai-sitemap-optimized",{productCount:(null==currentInfo?void 0:currentInfo.productCount)||(null==currentInfo?void 0:currentInfo.lastProductCount)||0});de({...i,feature:"ai-sitemap-optimized",tokensRequired:e.withMargin,tokensAvailable:i.tokensAvailable||0,tokensNeeded:e.withMargin}),ae(!0)}else R(i.message||"Failed to generate AI-Optimized Sitemap")}finally{V(!1)}}},[P,N,M,Ae]),Ce=e.useCallback(async()=>{var e,t,n;if(P){ce(!0),he(!0),me(null);try{const a=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(P)}&force=true&ai=true&t=${Date.now()}`,{method:"GET",credentials:"include",headers:{Authorization:`Bearer ${(null==(n=null==(t=null==(e=window.__SHOPIFY_APP_BRIDGE__)?void 0:e.getState())?void 0:t.session)?void 0:n.token)||""}`}});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);{const e=await a.text();me(e)}}catch(a){me(`Error loading AI sitemap: ${a.message}`)}finally{he(!1)}}},[P]),Pe=e.useCallback(async()=>{try{const e=await N("/api/billing/activate",{method:"POST",body:{shop:P,endTrial:!0,returnTo:window.location.pathname}});(null==e?void 0:e.confirmationUrl)?window.top.location.href=e.confirmationUrl:(null==e?void 0:e.success)?(R("Plan activated successfully!"),te(!1),fe()):R("Failed to activate plan")}catch(e){R(e.message||"Failed to activate plan")}},[P,N,fe]);return e.useEffect(()=>()=>{J.current&&clearInterval(J.current)},[]),e.useEffect(()=>{ve(),fe(),ye(),we().then(e=>{(null==e?void 0:e.inProgress)&&Ae()})},[ve,fe,ye,we,Ae]),t.jsxs(r,{children:[t.jsx(l,{padding:"400",children:t.jsxs(d,{gap:"400",children:[t.jsxs(u,{tone:"info",children:["Your ",t.jsx("strong",{children:(null==M?void 0:M.plan)||"Starter"})," plan: up to ",t.jsxs("strong",{children:[(null==(k=null==M?void 0:M.product_limit)?void 0:k.toLocaleString())||"70"," products"]})," in ",(null==M?void 0:M.language_limit)||1," language",((null==M?void 0:M.language_limit)||1)>1?"s":"",".",(null==I?void 0:I.productCount)&&(null==M?void 0:M.product_limit)&&I.productCount>M.product_limit&&t.jsxs(t.Fragment,{children:[" (You have ",I.productCount,", only first ",M.product_limit.toLocaleString()," included)"]})]}),(T||K||Y.inProgress)&&t.jsx(u,{tone:"info",children:t.jsxs(c,{gap:"200",blockAlign:"center",children:[t.jsx(p,{size:"small"}),t.jsxs(m,{variant:"bodyMd",children:[Y.inProgress||K?`AI-Optimized: ${Y.message||"Processing..."}`:"Generating basic sitemap...",Y.position>0&&` (Queue: ${Y.position})`]})]})}),t.jsx(l,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",borderWidth:"025",borderColor:(null==I?void 0:I.generated)?"border-success":"border",children:t.jsxs(c,{align:"space-between",blockAlign:"center",gap:"400",children:[t.jsxs(c,{gap:"300",blockAlign:"center",children:[(null==I?void 0:I.generated)?t.jsx(g,{source:h,tone:"success"}):t.jsx(g,{source:v,tone:"subdued"}),t.jsxs(d,{gap:"050",children:[t.jsx(m,{variant:"bodyMd",fontWeight:"semibold",children:"Basic Sitemap"}),(null==I?void 0:I.generated)?t.jsxs(c,{gap:"200",blockAlign:"center",children:[t.jsxs(m,{variant:"bodySm",tone:"subdued",children:[I.lastProductCount||0," products Â· ",Se(I.generatedAt)]}),t.jsx(f,{variant:"plain",size:"slim",onClick:je,children:"View"})]}):t.jsx(m,{variant:"bodySm",tone:"subdued",children:"Not generated yet"})]})]}),t.jsx(f,{onClick:be,loading:T,disabled:T,size:"slim",children:(null==I?void 0:I.generated)?"Regenerate":"Generate"})]})}),t.jsx(l,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",borderWidth:"025",borderColor:(null==X?void 0:X.generated)?"border-success":"border",children:t.jsxs(c,{align:"space-between",blockAlign:"center",gap:"400",children:[t.jsxs(c,{gap:"300",blockAlign:"center",children:[(null==X?void 0:X.generated)?t.jsx(g,{source:h,tone:"success"}):(null==I?void 0:I.generated)?t.jsx(g,{source:v,tone:"subdued"}):t.jsx(g,{source:b,tone:"subdued"}),t.jsxs(d,{gap:"050",children:[t.jsxs(c,{gap:"200",blockAlign:"center",children:[t.jsx(m,{variant:"bodyMd",fontWeight:"semibold",children:"AI-Optimized Sitemap"}),t.jsx(x,{tone:"info",size:"small",children:"Premium"})]}),(null==X?void 0:X.generated)?t.jsxs(c,{gap:"200",blockAlign:"center",children:[t.jsxs(m,{variant:"bodySm",tone:"subdued",children:[X.productCount||0," products Â· ",Se(X.generatedAt)]}),t.jsx(f,{variant:"plain",size:"slim",onClick:Ce,children:"View"})]}):(null==I?void 0:I.generated)?t.jsx(m,{variant:"bodySm",tone:"subdued",children:"Adds AI descriptions & enhanced metadata"}):t.jsx(m,{variant:"bodySm",tone:"subdued",children:"Generate basic sitemap first"})]})]}),t.jsx(f,{primary:!0,onClick:ke,loading:K||Y.inProgress,disabled:!(null==I?void 0:I.generated)||K||Y.inProgress,size:"slim",children:(null==X?void 0:X.generated)?"Regenerate":"Generate"})]})}),t.jsx(j,{}),t.jsx(l,{children:t.jsxs(d,{gap:"300",children:[t.jsxs(l,{children:[t.jsx(m,{variant:"headingSm",as:"h4",children:"Basic Sitemap includes:"}),t.jsx(l,{paddingBlockStart:"100",children:t.jsx(m,{variant:"bodySm",tone:"subdued",children:"âœ“ All active products with structured URLs Â· Priority rankings Â· Multi-language URLs Â· Standard XML format"})})]}),t.jsx(l,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",children:t.jsxs(d,{gap:"200",children:[t.jsxs(c,{gap:"200",blockAlign:"center",children:[t.jsx(m,{variant:"headingSm",as:"h4",children:"Why AI-Optimized?"}),t.jsx(x,{tone:"info",size:"small",children:"Premium"})]}),t.jsx(m,{variant:"bodySm",tone:"subdued",children:"Make your products stand out when customers search with AI assistants like ChatGPT, Perplexity, or Google AI."}),t.jsxs(d,{gap:"100",children:[t.jsxs(m,{variant:"bodySm",children:["âœ“ ",t.jsx("strong",{children:"AI-generated descriptions"})," â€” helps AI models better understand and recommend your products"]}),t.jsxs(m,{variant:"bodySm",children:["âœ“ ",t.jsx("strong",{children:"Enhanced metadata"})," â€” category, price range, and key features formatted for AI consumption"]}),t.jsxs(m,{variant:"bodySm",children:["âœ“ ",t.jsx("strong",{children:"Structured annotations"})," â€” special AI-readable tags that increase visibility in AI search results"]})]})]})}),t.jsx(l,{children:t.jsxs(m,{variant:"bodySm",tone:"subdued",children:["ðŸ’¡ ",t.jsx("strong",{children:"Tip:"})," Regenerate your sitemaps after adding new products or updating existing ones to keep AI models up to date with your catalog."]})})]})})]})}),U&&t.jsx(S,{open:U,onClose:()=>{F(!1),D(null)},title:"AI-Optimized Sitemap",primaryAction:{content:"Copy",onAction:()=>{navigator.clipboard.writeText(B),R("Copied to clipboard!")},disabled:W},secondaryActions:[{content:"Close",onAction:()=>{F(!1),D(null)}}],children:t.jsx(S.Section,{children:t.jsx(l,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:W?t.jsxs(c,{align:"center",gap:"200",children:[t.jsx(p,{size:"small"}),t.jsx(m,{variant:"bodyMd",children:"Loading sitemap XML... This may take a moment for large stores."})]}):t.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"12px",margin:0,overflow:"auto",maxHeight:"400px"},children:B})})})}),ue&&t.jsx(S,{open:ue,onClose:()=>{ce(!1),me(null)},title:"AI-Optimized Sitemap",primaryAction:{content:"Copy",onAction:()=>{navigator.clipboard.writeText(pe),R("Copied to clipboard!")},disabled:ge},secondaryActions:[{content:"Close",onAction:()=>{ce(!1),me(null)}}],children:t.jsx(S.Section,{children:t.jsx(l,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:ge?t.jsxs(c,{align:"center",gap:"200",children:[t.jsx(p,{size:"small"}),t.jsx(m,{variant:"bodyMd",children:"Loading AI-optimized sitemap..."})]}):t.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"12px",margin:0,overflow:"auto",maxHeight:"400px"},children:pe})})})}),t.jsx(a,{open:ee,onClose:()=>{te(!1),de(null)},feature:"ai-sitemap-optimized",currentPlan:(null==M?void 0:M.plan)||"Starter",trialEndsAt:null==(C=null==M?void 0:M.trial)?void 0:C.ends_at,tokensRequired:A("ai-sitemap-optimized",{productCount:(null==I?void 0:I.productCount)||(null==I?void 0:I.lastProductCount)||0}).withMargin,onActivatePlan:Pe,onPurchaseTokens:()=>{te(!1),se(!0)}}),t.jsx(i,{open:ne,onClose:()=>{ae(!1),de(null)},feature:(null==le?void 0:le.feature)||"ai-sitemap-optimized",tokensRequired:(null==le?void 0:le.tokensRequired)||0,tokensAvailable:(null==le?void 0:le.tokensAvailable)||0,tokensNeeded:(null==le?void 0:le.tokensNeeded)||(null==le?void 0:le.tokensRequired)||0,currentPlan:(null==M?void 0:M.plan)||"Starter",needsUpgrade:null==le?void 0:le.needsUpgrade,onBuyTokens:()=>{ae(!1),se(!0)}}),t.jsx(s,{open:ie,onClose:()=>se(!1),shop:P,returnTo:window.location.pathname}),t.jsx(o,{open:oe,onClose:()=>re(!1),featureName:"AI-Optimized Sitemap",currentPlan:(null==M?void 0:M.plan)||"Starter",minimumPlanRequired:"Professional Plus",features:["AI-enhanced product descriptions in sitemap","Better AI crawler understanding","Professional Plus, Growth Plus, Growth Extra, or Enterprise plan","Or purchase tokens on any Plus plan"],returnTo:window.location.pathname}),_&&t.jsx(y,{content:_,onDismiss:()=>R("")})]})}export{C as default};
