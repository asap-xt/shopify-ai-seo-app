import{j as e}from"./app-bridge-BF9aPrYY-1758911745419.js";import{r as s}from"./react-vendor-tAaa2TlE-1758911745419.js";import{U as nt}from"./UpgradeModal-DnEFvySQ-1758911745419.js";import{M as g,d as w,T as d,e as me,a as u,I as b,f as xe,B as k,D as lt,g as K,C as je,i as ot,S as at,P as it,j as rt,R as ct,k as dt,m as ht,E as ut}from"./polaris-YGlhh6Io-1758911745419.js";const pt=(B,i="")=>{try{return new URLSearchParams(window.location.search).get(B)||i}catch{return i}};function It({shop:B}){const i=B||pt("shop","");console.log("[COLLECTIONS] Component initialized with shop:",i,"shopProp:",B);const[f,ye]=s.useState([]),[be,le]=s.useState(!1),[R,Ce]=s.useState(0),[S,$]=s.useState([]),[x,H]=s.useState(!1),[gt,we]=s.useState(""),[E,X]=s.useState(""),[j,G]=s.useState("all"),[oe,Z]=s.useState(!1),[ve,Ae]=s.useState(""),[ft,Oe]=s.useState([]),[v,J]=s.useState([]),[A,ae]=s.useState([]),[ee,L]=s.useState(!1),[O,C]=s.useState({current:0,total:0,percent:0}),[ie,P]=s.useState(""),[N,re]=s.useState([]),[St,mt]=s.useState(!1),[xt,jt]=s.useState(null),[yt,bt]=s.useState(!1),[Ct,ke]=s.useState(""),[Ee,V]=s.useState(!1),[T,z]=s.useState([]),[ce,de]=s.useState(!1),[Ie,W]=s.useState(!1),[Me,q]=s.useState(!1),[he,Q]=s.useState([]),[I,Y]=s.useState({}),[De,_]=s.useState(!1),[Le,te]=s.useState(!1),[ue,wt]=s.useState({}),[Pe,se]=s.useState(!1),[pe,ne]=s.useState(null),[Te,ge]=s.useState(!1),[fe,m]=s.useState(""),[ze,U]=s.useState(!1),[Be,Se]=s.useState(!1),[Re,$e]=s.useState("starter"),[Ne,vt]=s.useState({processing:!1,current:0,total:0,currentItem:"",results:null});s.useEffect(()=>{i&&api("/plans/me",{shop:i}).then(t=>{const n=(t==null?void 0:t.modelsSuggested)||["google/gemini-1.5-flash"];Oe(n.map(l=>({label:l,value:l}))),Ae(n[0])}).catch(t=>m(`Error loading models: ${t.message}`))},[i,api]),s.useEffect(()=>{i&&api(`/api/languages/shop/${i}`).then(t=>{const n=(t==null?void 0:t.shopLanguages)||["en"];ae(n),J([])}).catch(()=>{ae(["en"]),J([])})},[i,api]);const M=s.useCallback(async()=>{le(!0);try{console.log("[COLLECTIONS] Shop value:",i),console.log("[COLLECTIONS] Shop prop:",B),console.log("[COLLECTIONS] URL search params:",window.location.search);const n=`/collections/list-graphql?${new URLSearchParams({shop:i,...E&&{search:E},...j!=="all"&&{optimized:j}})}`;console.log("[COLLECTIONS] Using GraphQL endpoint:",n);let a=(await api(n)).collections||[];if(E){const o=E.toLowerCase();a=a.filter(r=>r.title.toLowerCase().includes(o)||r.handle.toLowerCase().includes(o))}j!=="all"&&(a=a.filter(o=>j==="true"?o.hasSeoData:!o.hasSeoData)),ye(a),Ce(a.length)}catch(t){m(`Error loading collections: ${t.message}`)}finally{le(!1)}},[i,E,j,api]);s.useEffect(()=>{i&&(M(),W(!1))},[i,j,M]),s.useEffect(()=>{const t=setTimeout(()=>{i&&M()},500);return()=>clearTimeout(t)},[E]);const We=s.useCallback(t=>{$(t);const n=t.some(l=>{const a=f.find(o=>o.id===l);return a==null?void 0:a.hasSeoData});W(n),t.length===0&&H(!1)},[f]),Ue=s.useCallback(t=>{if(H(t),t){$(f.map(l=>l.id));const n=f.some(l=>l.hasSeoData);W(n)}else $([]),W(!1)},[f]),Fe=async t=>{ge(!0);try{const n=`/collections/${t.split("/").pop()}/seo-data?shop=${encodeURIComponent(i)}`,l=await api(n);ne(l),se(!0)}catch(n){m((n==null?void 0:n.status)===404?"No SEO data found for this collection":"Failed to load SEO data")}finally{ge(!1)}},He=()=>{if(S.length===0&&!x){m("Please select collections first");return}te(!0)},Ge=async()=>{try{L(!0),we("Checking eligibility...");const t=await api("/ai-enhance/check-eligibility",{method:"POST",shop:i,body:{shop:i}});if(!t.eligible){$e(t.currentPlan||"starter"),U(!1),Se(!0);return}U(!1);const l=f.filter(h=>S.includes(h.id)).filter(h=>{var c;return((c=h.optimizedLanguages)==null?void 0:c.length)>0}),a=l.length;C({current:0,total:a,percent:0});const o={};for(let h=0;h<l.length;h++){const c=l[h];P(c.title);try{const p=c.optimizedLanguages||[];if(p.length===0){console.log(`No optimized languages for ${c.title}, skipping`),o[c.id]={success:!1,skipped:!0,error:"No optimized languages"};continue}console.log(`Enhancing ${c.title} for languages:`,p);const D=await api(`/ai-enhance/collection/${encodeURIComponent(c.id)}`,{method:"POST",shop:i,body:{shop:i,languages:p}});o[c.id]={success:D.ok,skipped:!1,data:D,error:D.ok?null:D.error||"Enhancement failed"}}catch(p){console.error("Error enhancing collection:",c.id,p),o[c.id]={success:!1,skipped:!1,error:p.message}}const y=h+1,F=Math.round(y/a*100);C({current:y,total:a,percent:F})}Y(o),_(!0);const r=Object.values(o).filter(h=>h.success).length;m(`Enhanced ${r} collections`),await M()}catch(t){console.error("AI Enhance error:",t),m("Failed to enhance collections")}finally{L(!1),P("")}},Je=async()=>{if(!v.length){m("Please select at least one language");return}te(!1),L(!0),C({current:0,total:0,percent:0}),re([]),Y({});try{const t=x?f:f.filter(o=>S.includes(o.id)),n=t.length;C({current:0,total:n,percent:0});const l={};for(let o=0;o<t.length;o++){const r=t[o];P(r.title);try{const y=await api("/seo/generate-collection-multi",{method:"POST",shop:i,body:{shop:i,collectionId:r.id,model:ve,languages:v}});l[r.id]={success:!0,data:y}}catch(y){l[r.id]={success:!1,error:y.message},re(F=>[...F,{collection:r.title,error:y.message}])}const h=o+1,c=Math.round(h/n*100);C({current:h,total:n,percent:c})}Y(l),_(!0);const a=Object.values(l).filter(o=>o.success).length;m(`Generated optimization for ${a} collections`)}catch(t){m(`Error: ${t.message}`)}finally{L(!1),P("")}},Ve=async()=>{var t,n;L(!0),C({current:0,total:0,percent:0});try{const l=Object.entries(I).filter(([o,r])=>r.success),a=l.length;C({current:0,total:a,percent:0});for(let o=0;o<l.length;o++){const[r,h]=l[o],c=f.find(p=>p.id===r);if(!c)continue;P(c.title);try{if(console.log("Applying SEO for collection:",r),console.log("Result data:",h.data),console.log("Results array:",(t=h.data)==null?void 0:t.results),!((n=h.data)!=null&&n.results)||!Array.isArray(h.data.results))throw new Error("Invalid results structure");const p=await api("/seo/apply-collection-multi",{method:"POST",shop:i,body:{shop:i,collectionId:r,results:h.data.results.map(D=>({language:D.language,seo:D.data})),options:{updateTitle:!0,updateDescription:!0,updateSeo:!0,updateMetafields:!0}}});if(!(p!=null&&p.ok))throw new Error((p==null?void 0:p.error)||"Apply failed")}catch(p){console.error("Apply error for collection:",r,p),N.push({id:c.id,title:c.title,message:p.message})}const y=o+1,F=Math.round(y/a*100);C({current:y,total:a,percent:F})}m("Optimization applied successfully!"),_(!1),Y({}),$([]),await M(),H(!1)}catch(l){m(`Error applying optimization: ${l.message}`)}finally{L(!1),P("")}},qe=async(t=[])=>{de(!0),ke("");try{const n=x?f:f.filter(r=>S.includes(r.id)),l=n.length*t.length;let a=0;const o=[];for(const r of n)for(const h of t)try{await api("/collections/delete-seo",{method:"DELETE",shop:i,body:{shop:i,collectionId:r.id,language:h}})}catch(c){console.error(`Failed to delete ${h} for ${r.title}:`,c),o.push({id:r.id,title:r.title,message:c.message})}finally{a++,C({current:a,total:l,percent:Math.round(a/l*100)})}m(`Deleted optimization for ${t.join(", ").toUpperCase()}`),setTimeout(async()=>{await M(),$([]),H(!1),W(!1)},100)}catch(n){m(`Delete error: ${n.message}`)}finally{de(!1),Q([]),z([])}},Qe=t=>{var r,h;const n=((r=I[t.id])==null?void 0:r.success)||ue[t.id],l=((h=I[t.id])==null?void 0:h.data)||ue[t.id],a=t.optimizedLanguages||[],o=e.jsx(u,{width:"40px",height:"40px",background:"surface-neutral",borderRadius:"200"});return e.jsx(ht,{id:t.id,url:"",media:o,accessibilityLabel:`View details for ${t.title}`,children:e.jsxs(b,{gap:"400",align:"center",blockAlign:"center",wrap:!1,children:[e.jsxs(u,{style:{flex:"1 1 30%",minWidth:"200px"},children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:t.title}),e.jsxs(d,{variant:"bodySm",tone:"subdued",children:["Handle: ",t.handle]})]}),e.jsx(u,{style:{flex:"0 0 15%",minWidth:"100px",textAlign:"center"},children:e.jsxs(d,{variant:"bodyMd",children:[t.productsCount," products"]})}),e.jsx(u,{style:{flex:"0 0 25%",minWidth:"160px"},children:t.hasSeoData?e.jsx(b,{gap:"100",children:A.map(c=>e.jsx(K,{tone:a.includes(c)?"success":"subdued",size:"small",children:c.toUpperCase()},c))}):e.jsx(K,{tone:"subdued",children:"No AI Search Optimisation"})}),e.jsxs(u,{style:{flex:"0 0 15%",minWidth:"120px"},children:[n&&e.jsx(k,{size:"slim",onClick:()=>{ne(l),se(!0)},children:"Preview JSON"}),!n&&t.hasSeoData&&e.jsx(k,{size:"slim",loading:Te,onClick:()=>Fe(t.id),children:"Preview JSON"})]})]})})},Ye=ee&&!Ne.processing&&e.jsx(g,{open:ee,title:"Processing Collections",onClose:()=>{},noScroll:!0,children:e.jsx(g.Section,{children:e.jsxs(w,{gap:"400",children:[e.jsx(d,{variant:"bodyMd",children:ie?`Processing: ${ie}`:"Preparing..."}),e.jsx(me,{progress:O.percent}),e.jsxs(d,{variant:"bodySm",tone:"subdued",children:[O.current," of ",O.total," collections (",O.percent,"%)"]})]})})}),_e=e.jsx(g,{open:Le,title:"Select Languages",primaryAction:{content:"Generate Optimization for AI Search",onAction:Je,disabled:v.length===0},secondaryActions:[{content:"Cancel",onAction:()=>te(!1)}],children:e.jsx(g.Section,{children:e.jsxs(w,{gap:"300",children:[e.jsxs(d,{variant:"bodyMd",children:["Select languages to generate AI Search Optimisation for ",x?"all":S.length," selected collections:"]}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(b,{gap:"200",wrap:!0,children:A.map(t=>e.jsx(xe,{label:t.toUpperCase(),checked:v.includes(t),onChange:n=>{J(n?[...v,t]:v.filter(l=>l!==t))}},t))})}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(k,{plain:!0,onClick:()=>{J(v.length===A.length?[]:[...A])},children:v.length===A.length?"Deselect all":"Select all"})})]})})}),Ke=e.jsx(g,{open:De&&!ee,title:"AI Search Optimisation Results",primaryAction:{content:"Apply Optimisation",onAction:Ve,disabled:!Object.values(I).some(t=>t.success)},secondaryActions:[{content:"Cancel",onAction:()=>_(!1)}],children:e.jsx(g.Section,{children:e.jsxs(w,{gap:"300",children:[e.jsxs(b,{gap:"400",children:[e.jsxs(u,{children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(d,{variant:"headingLg",fontWeight:"bold",tone:"success",children:Object.values(I).filter(t=>t.success&&!t.skipped).length})]}),e.jsxs(u,{children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Skipped:"}),e.jsx(d,{variant:"headingLg",fontWeight:"bold",tone:"info",children:Object.values(I).filter(t=>t.skipped).length})]}),e.jsxs(u,{children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(d,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:Object.values(I).filter(t=>!t.success&&!t.skipped).length})]})]}),N.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(lt,{}),e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Errors:"}),e.jsxs(u,{maxHeight:"200px",overflowY:"scroll",children:[N.slice(0,10).map((t,n)=>e.jsxs(d,{variant:"bodySm",tone:"critical",children:[t.collection,": ",t.error]},n)),N.length>10&&e.jsxs(d,{variant:"bodySm",tone:"subdued",children:["... and ",N.length-10," more errors"]})]})]})]})})}),Xe=e.jsx(g,{open:Pe,title:"SEO Data Preview",secondaryActions:[{content:"Close",onAction:()=>{se(!1),ne(null)}}],children:e.jsx(g.Section,{children:e.jsx(u,{children:e.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"12px",backgroundColor:"#f6f6f7",padding:"12px",borderRadius:"4px",maxHeight:"400px",overflow:"auto"},children:pe?JSON.stringify(pe,null,2):""})})})}),Ze=e.jsx(g,{open:Ee,title:"Delete Optimization for AI Search",onClose:()=>{V(!1),z([])},primaryAction:{content:"Continue",onAction:()=>{Q(T),V(!1),q(!0)},disabled:T.length===0},secondaryActions:[{content:"Cancel",onAction:()=>{V(!1),z([])}}],children:e.jsx(g.Section,{children:e.jsxs(w,{gap:"400",children:[e.jsxs(d,{variant:"bodyMd",children:["Select languages to delete AI Search Optimisation from ",x?R:S.length," selected collections:"]}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(b,{gap:"400",wrap:!1,children:A.map(t=>e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer",userSelect:"none"},children:[e.jsx("input",{type:"checkbox",checked:T.includes(t),onChange:n=>{z(n.target.checked?[...T,t]:T.filter(l=>l!==t))},style:{marginRight:"8px",width:"18px",height:"18px",cursor:"pointer"}}),e.jsx(d,{variant:"bodyMd",children:t.toUpperCase()})]},t))})}),e.jsx(u,{children:e.jsx(k,{plain:!0,onClick:()=>{z(T.length===A.length?[]:[...A])},children:"Select all"})}),e.jsx(u,{paddingBlockStart:"300",children:e.jsx(d,{variant:"bodySm",children:"Warning: This will permanently delete AI Search Optimisation data for selected languages."})})]})})}),et=e.jsx(g,{open:Me,title:"Confirm Deletion",onClose:()=>{q(!1),Q([])},primaryAction:{content:"Delete",destructive:!0,onAction:async()=>{q(!1),setTimeout(()=>{qe(he)},100)}},secondaryActions:[{content:"Cancel",onAction:()=>{q(!1),Q([]),z([])}}],children:e.jsx(g.Section,{children:e.jsxs(w,{gap:"400",children:[e.jsx(d,{variant:"bodyMd",children:"Are you sure you want to delete AI Search Optimisation for the following languages?"}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(b,{gap:"200",children:he.map(t=>e.jsx(K,{tone:"warning",children:t.toUpperCase()},t))})}),e.jsxs(d,{variant:"bodyMd",children:["This will delete optimisation from ",x?R:S.length," selected collections."]}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(d,{variant:"bodySm",tone:"critical",children:"This action cannot be undone."})})]})})}),tt=ce&&e.jsx(g,{open:ce,title:"Deleting SEO Data",onClose:()=>{},noScroll:!0,children:e.jsx(g.Section,{children:e.jsxs(w,{gap:"400",children:[e.jsx(d,{variant:"bodyMd",children:"Deleting selected languages..."}),e.jsx(me,{progress:O.percent}),e.jsxs(d,{variant:"bodySm",tone:"subdued",children:[O.current," of ",O.total," operations (",O.percent,"%)"]})]})})}),st=e.jsx(ut,{heading:"No collections found",action:{content:"Clear filters",onAction:()=>{X(""),G("all"),M()}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Try adjusting your filters or search terms"})});return e.jsxs(e.Fragment,{children:[e.jsx(je,{children:e.jsxs(u,{padding:"400",children:[e.jsxs(b,{gap:"400",align:"space-between",blockAlign:"start",wrap:!1,children:[e.jsx(u,{minWidth:"400px",maxWidth:"600px",children:e.jsx(w,{gap:"200",children:e.jsx(ot,{label:"",placeholder:"Search by collection name...",value:E,onChange:X,prefix:e.jsx(at,{}),clearButton:!0,onClearButtonClick:()=>X("")})})}),e.jsxs(w,{gap:"200",children:[e.jsx(k,{primary:!0,onClick:He,disabled:S.length===0&&!x,children:"Generate Optimization for AI Search"}),S.length===0&&!x||!f.filter(l=>S.includes(l.id)).some(l=>{var a;return((a=l.optimizedLanguages)==null?void 0:a.length)>0})?null:e.jsx(k,{onClick:()=>U(!0),disabled:S.length===0&&!x,children:"AI Enhanced add-ons for AI Search"}),e.jsx(k,{outline:!0,destructive:!0,onClick:()=>V(!0),disabled:S.length===0||!Ie,children:"Delete Optimization for AI Search"})]})]}),R>0&&e.jsx(u,{paddingBlockStart:"300",children:e.jsx(xe,{label:`Select all ${R} collections`,checked:x,onChange:Ue})})]})}),e.jsx(u,{paddingBlockStart:"400",children:e.jsxs(je,{children:[e.jsxs(u,{padding:"400",borderBlockEndWidth:"025",borderColor:"border",children:[e.jsx(b,{gap:"200",wrap:!0,children:e.jsx(it,{active:oe,activator:e.jsx(k,{disclosure:"down",onClick:()=>Z(!oe),removeUnderline:!0,children:e.jsxs(b,{gap:"100",blockAlign:"center",children:[e.jsx("span",{children:"AI Search Status"}),j!=="all"&&e.jsx(u,{onClick:t=>{t.stopPropagation(),G("all")},children:e.jsx(d,{as:"span",tone:"subdued",children:"✕"})})]})}),onClose:()=>Z(!1),children:e.jsx(u,{padding:"300",minWidth:"200px",children:e.jsx(rt,{title:"AI Search Status",titleHidden:!0,choices:[{label:"All collections",value:"all"},{label:"Has AI Search Optimisation",value:"true"},{label:"No AI Search Optimisation",value:"false"}],selected:[j],onChange:t=>{G(t[0]),Z(!1)}})})})}),j!=="all"&&e.jsx(u,{paddingBlockStart:"200",children:e.jsx(b,{gap:"100",wrap:!0,children:e.jsx(K,{onRemove:()=>G("all"),children:j==="true"?"Has AI Search Optimisation":"No AI Search Optimisation"})})})]}),e.jsx(ct,{resourceName:{singular:"collection",plural:"collections"},items:f,renderItem:Qe,selectedItems:S,onSelectionChange:We,selectable:!0,loading:be,totalItemsCount:R,emptyState:st,showHeader:!1})]})}),Ye,_e,Ke,Xe,Ze,et,tt,e.jsx(g,{open:ze,onClose:()=>U(!1),title:"AI Enhanced add-ons for AI Search",primaryAction:{content:"Start AI Enhancement",onAction:Ge},secondaryActions:[{content:"Cancel",onAction:()=>U(!1)}],children:e.jsx(g.Section,{children:e.jsxs(w,{gap:"300",children:[e.jsxs(d,{variant:"bodyMd",children:["AI enhancement will improve bullets and FAQ for ",f.filter(t=>{var n;return S.includes(t.id)&&((n=t.optimizedLanguages)==null?void 0:n.length)>0}).length," collections."]}),e.jsx(d,{variant:"bodySm",tone:"subdued",children:"Note: AI enhancement is only available for Growth Extra and Enterprise plans."})]})})}),e.jsx(nt,{open:Be,onClose:()=>Se(!1),featureName:"AI Enhancement",currentPlan:Re}),fe&&e.jsx(dt,{content:fe,onDismiss:()=>m("")})]})}export{It as default};
