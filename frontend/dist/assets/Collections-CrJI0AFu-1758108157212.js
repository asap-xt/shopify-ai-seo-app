import{j as e}from"./app-bridge-DQy99Tqb-1758108157212.js";import{r as s}from"./react-vendor-tAaa2TlE-1758108157212.js";import{m as tt}from"./index-DQBdOeZ6-1758108157212.js";import{U as st}from"./UpgradeModal-LvAR2khj-1758108157212.js";import{M as h,d as A,T as a,e as Se,a as o,I as b,f as me,B as k,D as nt,g as J,C as je,h as lt,S as at,P as ot,i as rt,R as it,j as ct,l as dt,E as ht}from"./polaris-fYMZGqCZ-1758108157212.js";const ut=(V,d="")=>{try{return new URLSearchParams(window.location.search).get(V)||d}catch{return d}};function Dt({shop:V}){const d=V||ut("shop",""),m=s.useMemo(()=>tt(),[]),[g,ye]=s.useState([]),[be,le]=s.useState(!1),[L,we]=s.useState(0),[f,B]=s.useState([]),[j,q]=s.useState(!1),[pt,gt]=s.useState(""),[M,Q]=s.useState(""),[y,W]=s.useState("all"),[ae,Y]=s.useState(!1),[Ce,ve]=s.useState(""),[ft,Ae]=s.useState([]),[w,$]=s.useState([]),[C,oe]=s.useState([]),[_,U]=s.useState(!1),[v,O]=s.useState({current:0,total:0,percent:0}),[re,F]=s.useState(""),[z,ie]=s.useState([]),[xt,St]=s.useState(!1),[mt,jt]=s.useState(null),[yt,bt]=s.useState(!1),[wt,ke]=s.useState(""),[Me,N]=s.useState(!1),[D,P]=s.useState([]),[ce,de]=s.useState(!1),[Oe,T]=s.useState(!1),[Ee,H]=s.useState(!1),[he,G]=s.useState([]),[E,K]=s.useState({}),[Ie,X]=s.useState(!1),[De,Z]=s.useState(!1),[ue,Ct]=s.useState({}),[Pe,ee]=s.useState(!1),[pe,te]=s.useState(null),[Le,ge]=s.useState(!1),[fe,x]=s.useState(""),[Be,se]=s.useState(!1),[ze,Te]=s.useState(!1),[Re,vt]=s.useState("starter"),[We,At]=s.useState({processing:!1,current:0,total:0,currentItem:"",results:null});s.useEffect(()=>{d&&m("/plans/me",{shop:d}).then(t=>{const l=(t==null?void 0:t.modelsSuggested)||["google/gemini-1.5-flash"];Ae(l.map(n=>({label:n,value:n}))),ve(l[0])}).catch(t=>x(`Error loading models: ${t.message}`))},[d,m]),s.useEffect(()=>{d&&m(`/api/languages/shop/${d}`).then(t=>{const l=(t==null?void 0:t.shopLanguages)||["en"];oe(l),$([])}).catch(()=>{oe(["en"]),$([])})},[d,m]);const R=s.useCallback(async()=>{le(!0);try{const t=new URLSearchParams({shop:d,...M&&{search:M},...y!=="all"&&{optimized:y}});let n=(await m(`/collections/list?${t}`)).collections||[];if(M){const r=M.toLowerCase();n=n.filter(i=>i.title.toLowerCase().includes(r)||i.handle.toLowerCase().includes(r))}y!=="all"&&(n=n.filter(r=>y==="true"?r.hasSeoData:!r.hasSeoData)),ye(n),we(n.length)}catch(t){x(`Error loading collections: ${t.message}`)}finally{le(!1)}},[d,M,y,m]);s.useEffect(()=>{d&&(R(),T(!1))},[d,y]),s.useEffect(()=>{const t=setTimeout(()=>{d&&R()},500);return()=>clearTimeout(t)},[M]);const $e=s.useCallback(t=>{B(t);const l=t.some(n=>{const r=g.find(i=>i.id===n);return r==null?void 0:r.hasSeoData});T(l),t.length===0&&q(!1)},[g]),Ue=s.useCallback(t=>{if(q(t),t){B(g.map(n=>n.id));const l=g.some(n=>n.hasSeoData);T(l)}else B([]),T(!1)},[g]),Fe=async t=>{ge(!0);try{const l=`/collections/${t.split("/").pop()}/seo-data?shop=${encodeURIComponent(d)}`,n=await m(l);te(n),ee(!0)}catch(l){x((l==null?void 0:l.status)===404?"No SEO data found for this collection":"Failed to load SEO data")}finally{ge(!1)}},Ne=()=>{if(f.length===0&&!j){x("Please select collections first");return}Z(!0)},He=async()=>{if(!w.length){x("Please select at least one language");return}Z(!1),U(!0),O({current:0,total:0,percent:0}),ie([]),K({});try{const t=j?g:g.filter(i=>f.includes(i.id)),l=t.length;O({current:0,total:l,percent:0});const n={};for(let i=0;i<t.length;i++){const c=t[i];F(c.title);try{const I=await m("/seo/generate-collection-multi",{method:"POST",shop:d,body:{shop:d,collectionId:c.id,model:Ce,languages:w}});n[c.id]={success:!0,data:I}}catch(I){n[c.id]={success:!1,error:I.message},ie(ne=>[...ne,{collection:c.title,error:I.message}])}const u=i+1,p=Math.round(u/l*100);O({current:u,total:l,percent:p})}K(n),X(!0);const r=Object.values(n).filter(i=>i.success).length;x(`Generated optimization for ${r} collections`)}catch(t){x(`Error: ${t.message}`)}finally{U(!1),F("")}},Ge=async()=>{var t,l;U(!0),O({current:0,total:0,percent:0});try{const n=Object.entries(E).filter(([i,c])=>c.success),r=n.length;O({current:0,total:r,percent:0});for(let i=0;i<n.length;i++){const[c,u]=n[i],p=g.find(S=>S.id===c);if(!p)continue;F(p.title);try{if(console.log("Applying SEO for collection:",c),console.log("Result data:",u.data),console.log("Results array:",(t=u.data)==null?void 0:t.results),!((l=u.data)!=null&&l.results)||!Array.isArray(u.data.results))throw new Error("Invalid results structure");const S=await m("/seo/apply-collection-multi",{method:"POST",shop:d,body:{shop:d,collectionId:c,results:u.data.results.map(xe=>({language:xe.language,seo:xe.data})),options:{updateTitle:!0,updateDescription:!0,updateSeo:!0,updateMetafields:!0}}});if(!(S!=null&&S.ok))throw new Error((S==null?void 0:S.error)||"Apply failed")}catch(S){console.error("Apply error for collection:",c,S),z.push({id:p.id,title:p.title,message:S.message})}const I=i+1,ne=Math.round(I/r*100);O({current:I,total:r,percent:ne})}x("Optimization applied successfully!"),X(!1),K({}),B([]),await R()}catch(n){x(`Error applying optimization: ${n.message}`)}finally{U(!1),F("")}},Je=async(t=[])=>{de(!0),ke("");try{const l=j?g:g.filter(c=>f.includes(c.id)),n=l.length*t.length;let r=0;const i=[];for(const c of l)for(const u of t)try{await m("/collections/delete-seo",{method:"DELETE",shop:d,body:{shop:d,collectionId:c.id,language:u}})}catch(p){console.error(`Failed to delete ${u} for ${c.title}:`,p),i.push({id:c.id,title:c.title,message:p.message})}finally{r++,O({current:r,total:n,percent:Math.round(r/n*100)})}x(`Deleted optimization for ${t.join(", ").toUpperCase()}`),setTimeout(async()=>{await R(),B([]),q(!1),T(!1)},100)}catch(l){x(`Delete error: ${l.message}`)}finally{de(!1),G([]),P([])}},Ve=t=>{var c,u;const l=((c=E[t.id])==null?void 0:c.success)||ue[t.id],n=((u=E[t.id])==null?void 0:u.data)||ue[t.id],r=t.optimizedLanguages||[],i=e.jsx(o,{width:"40px",height:"40px",background:"surface-neutral",borderRadius:"200"});return e.jsx(dt,{id:t.id,url:"",media:i,accessibilityLabel:`View details for ${t.title}`,children:e.jsxs(b,{gap:"400",align:"center",blockAlign:"center",wrap:!1,children:[e.jsxs(o,{style:{flex:"1 1 30%",minWidth:"200px"},children:[e.jsx(a,{variant:"bodyMd",fontWeight:"semibold",children:t.title}),e.jsxs(a,{variant:"bodySm",tone:"subdued",children:["Handle: ",t.handle]})]}),e.jsx(o,{style:{flex:"0 0 15%",minWidth:"100px",textAlign:"center"},children:e.jsxs(a,{variant:"bodyMd",children:[t.productsCount," products"]})}),e.jsx(o,{style:{flex:"0 0 25%",minWidth:"160px"},children:t.hasSeoData?e.jsx(b,{gap:"100",children:C.map(p=>e.jsx(J,{tone:r.includes(p)?"success":"subdued",size:"small",children:p.toUpperCase()},p))}):e.jsx(J,{tone:"subdued",children:"No AI Search Optimisation"})}),e.jsxs(o,{style:{flex:"0 0 15%",minWidth:"120px"},children:[l&&e.jsx(k,{size:"slim",onClick:()=>{te(n),ee(!0)},children:"Preview JSON"}),!l&&t.hasSeoData&&e.jsx(k,{size:"slim",loading:Le,onClick:()=>Fe(t.id),children:"Preview JSON"})]})]})})},qe=_&&!We.processing&&e.jsx(h,{open:_,title:"Processing Collections",onClose:()=>{},noScroll:!0,children:e.jsx(h.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(a,{variant:"bodyMd",children:re?`Processing: ${re}`:"Preparing..."}),e.jsx(Se,{progress:v.percent}),e.jsxs(a,{variant:"bodySm",tone:"subdued",children:[v.current," of ",v.total," collections (",v.percent,"%)"]})]})})}),Qe=e.jsx(h,{open:De,title:"Select Languages",primaryAction:{content:"Generate Optimization for AI Search",onAction:He,disabled:w.length===0},secondaryActions:[{content:"Cancel",onAction:()=>Z(!1)}],children:e.jsx(h.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(a,{variant:"bodyMd",children:["Select languages to generate AI Search Optimisation for ",j?"all":f.length," selected collections:"]}),e.jsx(o,{paddingBlockStart:"200",children:e.jsx(b,{gap:"200",wrap:!0,children:C.map(t=>e.jsx(me,{label:t.toUpperCase(),checked:w.includes(t),onChange:l=>{$(l?[...w,t]:w.filter(n=>n!==t))}},t))})}),e.jsx(o,{paddingBlockStart:"200",children:e.jsx(k,{plain:!0,onClick:()=>{$(w.length===C.length?[]:[...C])},children:w.length===C.length?"Deselect all":"Select all"})})]})})}),Ye=e.jsx(h,{open:Ie&&!_,title:"AI Search Optimisation Results",primaryAction:{content:"Apply Optimisation",onAction:Ge,disabled:!Object.values(E).some(t=>t.success)},secondaryActions:[{content:"Cancel",onAction:()=>X(!1)}],children:e.jsx(h.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(b,{gap:"400",children:[e.jsxs(o,{children:[e.jsx(a,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(a,{variant:"headingLg",fontWeight:"bold",tone:"success",children:Object.values(E).filter(t=>t.success&&!t.skipped).length})]}),e.jsxs(o,{children:[e.jsx(a,{variant:"bodyMd",fontWeight:"semibold",children:"Skipped:"}),e.jsx(a,{variant:"headingLg",fontWeight:"bold",tone:"info",children:Object.values(E).filter(t=>t.skipped).length})]}),e.jsxs(o,{children:[e.jsx(a,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(a,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:Object.values(E).filter(t=>!t.success&&!t.skipped).length})]})]}),z.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(nt,{}),e.jsx(a,{variant:"bodyMd",fontWeight:"semibold",children:"Errors:"}),e.jsxs(o,{maxHeight:"200px",overflowY:"scroll",children:[z.slice(0,10).map((t,l)=>e.jsxs(a,{variant:"bodySm",tone:"critical",children:[t.collection,": ",t.error]},l)),z.length>10&&e.jsxs(a,{variant:"bodySm",tone:"subdued",children:["... and ",z.length-10," more errors"]})]})]})]})})}),_e=e.jsx(h,{open:Pe,title:"SEO Data Preview",secondaryActions:[{content:"Close",onAction:()=>{ee(!1),te(null)}}],children:e.jsx(h.Section,{children:e.jsx(o,{children:e.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"12px",backgroundColor:"#f6f6f7",padding:"12px",borderRadius:"4px",maxHeight:"400px",overflow:"auto"},children:pe?JSON.stringify(pe,null,2):""})})})}),Ke=e.jsx(h,{open:Me,title:"Delete Optimization for AI Search",onClose:()=>{N(!1),P([])},primaryAction:{content:"Continue",onAction:()=>{G(D),N(!1),H(!0)},disabled:D.length===0},secondaryActions:[{content:"Cancel",onAction:()=>{N(!1),P([])}}],children:e.jsx(h.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsxs(a,{variant:"bodyMd",children:["Select languages to delete AI Search Optimisation from ",j?L:f.length," selected collections:"]}),e.jsx(o,{paddingBlockStart:"200",children:e.jsx(b,{gap:"400",wrap:!1,children:C.map(t=>e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer",userSelect:"none"},children:[e.jsx("input",{type:"checkbox",checked:D.includes(t),onChange:l=>{P(l.target.checked?[...D,t]:D.filter(n=>n!==t))},style:{marginRight:"8px",width:"18px",height:"18px",cursor:"pointer"}}),e.jsx(a,{variant:"bodyMd",children:t.toUpperCase()})]},t))})}),e.jsx(o,{children:e.jsx(k,{plain:!0,onClick:()=>{P(D.length===C.length?[]:[...C])},children:"Select all"})}),e.jsx(o,{paddingBlockStart:"300",children:e.jsx(a,{variant:"bodySm",children:"Warning: This will permanently delete AI Search Optimisation data for selected languages."})})]})})}),Xe=e.jsx(h,{open:Ee,title:"Confirm Deletion",onClose:()=>{H(!1),G([])},primaryAction:{content:"Delete",destructive:!0,onAction:async()=>{H(!1),setTimeout(()=>{Je(he)},100)}},secondaryActions:[{content:"Cancel",onAction:()=>{H(!1),G([]),P([])}}],children:e.jsx(h.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(a,{variant:"bodyMd",children:"Are you sure you want to delete AI Search Optimisation for the following languages?"}),e.jsx(o,{paddingBlockStart:"200",children:e.jsx(b,{gap:"200",children:he.map(t=>e.jsx(J,{tone:"warning",children:t.toUpperCase()},t))})}),e.jsxs(a,{variant:"bodyMd",children:["This will delete optimisation from ",j?L:f.length," selected collections."]}),e.jsx(o,{paddingBlockStart:"200",children:e.jsx(a,{variant:"bodySm",tone:"critical",children:"This action cannot be undone."})})]})})}),Ze=ce&&e.jsx(h,{open:ce,title:"Deleting SEO Data",onClose:()=>{},noScroll:!0,children:e.jsx(h.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(a,{variant:"bodyMd",children:"Deleting selected languages..."}),e.jsx(Se,{progress:v.percent}),e.jsxs(a,{variant:"bodySm",tone:"subdued",children:[v.current," of ",v.total," operations (",v.percent,"%)"]})]})})}),et=e.jsx(ht,{heading:"No collections found",action:{content:"Clear filters",onAction:()=>{Q(""),W("all"),R()}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Try adjusting your filters or search terms"})});return e.jsxs(e.Fragment,{children:[e.jsx(je,{children:e.jsxs(o,{padding:"400",children:[e.jsxs(b,{gap:"400",align:"space-between",blockAlign:"start",wrap:!1,children:[e.jsx(o,{minWidth:"400px",maxWidth:"600px",children:e.jsx(lt,{label:"",placeholder:"Search by collection name...",value:M,onChange:Q,prefix:e.jsx(at,{}),clearButton:!0,onClearButtonClick:()=>Q("")})}),e.jsxs(A,{gap:"200",children:[e.jsx(k,{primary:!0,onClick:Ne,disabled:f.length===0&&!j,children:"Generate Optimization for AI Search"}),f.length===0&&!j||!g.filter(n=>f.includes(n.id)).some(n=>{var r;return((r=n.optimizedLanguages)==null?void 0:r.length)>0})?null:e.jsx(k,{onClick:()=>se(!0),disabled:f.length===0&&!j,children:"AI Enhanced add-ons for AI Search"}),e.jsx(k,{outline:!0,destructive:!0,onClick:()=>N(!0),disabled:f.length===0||!Oe,children:"Delete Optimization for AI Search"})]})]}),L>0&&e.jsx(o,{paddingBlockStart:"300",children:e.jsx(me,{label:`Select all ${L} collections`,checked:j,onChange:Ue})})]})}),e.jsx(o,{paddingBlockStart:"400",children:e.jsxs(je,{children:[e.jsxs(o,{padding:"400",borderBlockEndWidth:"025",borderColor:"border",children:[e.jsx(b,{gap:"200",wrap:!0,children:e.jsx(ot,{active:ae,activator:e.jsx(k,{disclosure:"down",onClick:()=>Y(!ae),removeUnderline:!0,children:e.jsxs(b,{gap:"100",blockAlign:"center",children:[e.jsx("span",{children:"AI Search Status"}),y!=="all"&&e.jsx(o,{onClick:t=>{t.stopPropagation(),W("all")},children:e.jsx(a,{as:"span",tone:"subdued",children:"✕"})})]})}),onClose:()=>Y(!1),children:e.jsx(o,{padding:"300",minWidth:"200px",children:e.jsx(rt,{title:"AI Search Status",titleHidden:!0,choices:[{label:"All collections",value:"all"},{label:"Has AI Search Optimisation",value:"true"},{label:"No AI Search Optimisation",value:"false"}],selected:[y],onChange:t=>{W(t[0]),Y(!1)}})})})}),y!=="all"&&e.jsx(o,{paddingBlockStart:"200",children:e.jsx(b,{gap:"100",wrap:!0,children:e.jsx(J,{onRemove:()=>W("all"),children:y==="true"?"Has AI Search Optimisation":"No AI Search Optimisation"})})})]}),e.jsx(it,{resourceName:{singular:"collection",plural:"collections"},items:g,renderItem:Ve,selectedItems:f,onSelectionChange:$e,selectable:!0,loading:be,totalItemsCount:L,emptyState:et,showHeader:!1})]})}),qe,Qe,Ye,_e,Ke,Xe,Ze,e.jsx(h,{open:Be,onClose:()=>se(!1),title:"AI Enhanced add-ons for AI Search",primaryAction:{content:"Start AI Enhancement",onAction:handleStartEnhancement},secondaryActions:[{content:"Cancel",onAction:()=>se(!1)}],children:e.jsx(h.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(a,{variant:"bodyMd",children:["AI enhancement will improve bullets and FAQ for ",selectedWithSEO.length," collections."]}),e.jsx(a,{variant:"bodySm",tone:"subdued",children:"Note: AI enhancement is only available for Growth Extra and Enterprise plans."})]})})}),e.jsx(st,{open:ze,onClose:()=>Te(!1),featureName:"AI Enhancement",currentPlan:Re}),fe&&e.jsx(ct,{content:fe,onDismiss:()=>x("")})]})}export{Dt as default};
