import{d as e}from"./index-iNn-oBGi.js";const t=e=>new Promise(t=>setTimeout(t,e));let s=!1,r=null;function o(){return s?Promise.resolve():(r||(r=new Promise(e=>{const t=()=>{var r;(null==(r=window.shopify)?void 0:r.idToken)||"complete"===document.readyState?(s=!0,e()):setTimeout(t,100)};setTimeout(t,500),setTimeout(()=>{s=!0,e()},3e3)})),r)}function n(n=!0){return n&&e("[SFETCH] Creating session fetch for App Bridge v4"),async(n,i={})=>{var a,u,l,c;e("[SFETCH] Fetching:",n,i);const{method:d="GET",headers:m={},body:p,responseType:f,...w}=i,T={method:d,headers:{"Content-Type":"application/json",...m},credentials:"include",body:p?"string"==typeof p?p:JSON.stringify(p):void 0};let y=null;for(let g=1;g<=5;g++)try{1!==g||s||(e("[SFETCH] Waiting for App Bridge to be ready..."),await o());const t=await fetch(n,T);let r;if(e("[SFETCH] Response:",t.status,t.statusText),"text"===f)r=await t.text();else{const e=await t.text();try{r=e?JSON.parse(e):null}catch{r={error:(null==e?void 0:e.slice(0,500))||"Non-JSON response"}}}if(!t.ok){if(402===t.status&&r){const e=new Error(r.error||r.message||"Payment Required");throw e.status=402,Object.assign(e,r),e}const e=(null==r?void 0:r.error)||(null==r?void 0:r.message)||`HTTP ${t.status}`,s=new Error(e);throw s.status=t.status,s}return r}catch(h){if(y=h,h.status&&h.status>=400&&h.status<500&&408!==h.status&&429!==h.status)throw h;const o=!h.status&&((null==(a=h.message)?void 0:a.includes("Failed to fetch"))||(null==(u=h.message)?void 0:u.includes("NetworkError"))||(null==(l=h.message)?void 0:l.includes("CORS"))||(null==(c=h.message)?void 0:c.includes("access control"))||"TypeError"===h.name);if(o&&g<5){const o=800*g;e(`[SFETCH] CORS/Network error on attempt ${g}/5, retrying in ${o}ms...`),1===g&&(s=!1,r=null),await t(o);continue}throw o&&(h.isTemporary=!0,h.isCorsError=!0),h}throw y&&!y.status&&(y.isTemporary=!0,y.isCorsError=!0),y||new Error("Request failed after retries")}}export{n as m};
