import{j as e}from"./app-bridge-CvbmHFmi-1758457107341.js";import{r as s}from"./react-vendor-tAaa2TlE-1758457107341.js";import{m as ve}from"./index-C51qSp1Y-1758457107341.js";import{U as rt}from"./UpgradeModal-DG-yx5YN-1758457107341.js";import{M as f,d as A,T as d,e as Ce,a as u,I as j,f as we,B as O,D as it,g as W,C as Ae,h as ct,S as dt,P as ht,i as ut,R as gt,j as pt,l as ft,E as mt}from"./polaris-CnWCxshT-1758457107341.js";const St=(L,a="")=>{try{return new URLSearchParams(window.location.search).get(L)||a}catch{return a}};function xt(){const[L,a]=s.useState({useGraphQLCollections:!1}),[m,v]=s.useState(!0),[G,p]=s.useState(null);return s.useEffect(()=>{(async()=>{try{v(!0);const P=St("shop"),E=await ve()(`/api/feature-flags?shop=${encodeURIComponent(P)}`,{method:"GET",shop:P});console.log("[FEATURE-FLAGS] Received flags:",E),a(E),p(null)}catch(P){console.error("[FEATURE-FLAGS] Error fetching flags:",P),p(P)}finally{v(!1)}})()},[]),{flags:L,loading:m,error:G}}const jt=(L,a="")=>{try{return new URLSearchParams(window.location.search).get(L)||a}catch{return a}};function Rt({shop:L}){const a=L||jt("shop",""),m=s.useMemo(()=>ve(),[]),{flags:v,loading:G}=xt(),[p,ce]=s.useState([]),[P,se]=s.useState(!1),[E,Ee]=s.useState(0),[S,N]=s.useState([]),[y,V]=s.useState(!1),[yt,ke]=s.useState(""),[D,ne]=s.useState(""),[b,Y]=s.useState("all"),[de,le]=s.useState(!1),[Ie,Me]=s.useState(""),[bt,Oe]=s.useState([]),[k,_]=s.useState([]),[I,he]=s.useState([]),[oe,B]=s.useState(!1),[M,w]=s.useState({current:0,total:0,percent:0}),[ue,$]=s.useState(""),[H,ge]=s.useState([]),[Ct,wt]=s.useState(!1),[At,vt]=s.useState(null),[Et,kt]=s.useState(!1),[It,Le]=s.useState(""),[Pe,K]=s.useState(!1),[F,U]=s.useState([]),[pe,fe]=s.useState(!1),[De,Q]=s.useState(!1),[Te,X]=s.useState(!1),[me,Z]=s.useState([]),[T,ee]=s.useState({}),[ze,te]=s.useState(!1),[Re,ae]=s.useState(!1),[Se,Mt]=s.useState({}),[Be,re]=s.useState(!1),[xe,ie]=s.useState(null),[$e,je]=s.useState(!1),[ye,x]=s.useState(""),[Fe,q]=s.useState(!1),[Ue,be]=s.useState(!1),[We,Ge]=s.useState("starter"),[Ne,Ot]=s.useState({processing:!1,current:0,total:0,currentItem:"",results:null});s.useEffect(()=>{a&&m("/plans/me",{shop:a}).then(t=>{const n=(t==null?void 0:t.modelsSuggested)||["google/gemini-1.5-flash"];Oe(n.map(l=>({label:l,value:l}))),Me(n[0])}).catch(t=>x(`Error loading models: ${t.message}`))},[a,m]),s.useEffect(()=>{a&&m(`/api/languages/shop/${a}`).then(t=>{const n=(t==null?void 0:t.shopLanguages)||["en"];he(n),_([])}).catch(()=>{he(["en"]),_([])})},[a,m]);const z=s.useCallback(async()=>{se(!0);try{const t=new URLSearchParams({shop:a,...D&&{search:D},...b!=="all"&&{optimized:b}}),n=v.useGraphQLCollections?`/collections/list-graphql?${t}`:`/collections/list?${t}`;console.log("[COLLECTIONS] Using endpoint:",n,"GraphQL enabled:",v.useGraphQLCollections);let r=(await m(n)).collections||[];if(D){const o=D.toLowerCase();r=r.filter(i=>i.title.toLowerCase().includes(o)||i.handle.toLowerCase().includes(o))}b!=="all"&&(r=r.filter(o=>b==="true"?o.hasSeoData:!o.hasSeoData)),ce(r),Ee(r.length)}catch(t){x(`Error loading collections: ${t.message}`)}finally{se(!1)}},[a,D,b,m,v.useGraphQLCollections]);s.useEffect(()=>{a&&!G&&(z(),Q(!1))},[a,b,G,z]),s.useEffect(()=>{const t=setTimeout(()=>{a&&z()},500);return()=>clearTimeout(t)},[D]);const He=s.useCallback(t=>{N(t);const n=t.some(l=>{const r=p.find(o=>o.id===l);return r==null?void 0:r.hasSeoData});Q(n),t.length===0&&V(!1)},[p]),Qe=s.useCallback(t=>{if(V(t),t){N(p.map(l=>l.id));const n=p.some(l=>l.hasSeoData);Q(n)}else N([]),Q(!1)},[p]),qe=async t=>{je(!0);try{const n=`/collections/${t.split("/").pop()}/seo-data?shop=${encodeURIComponent(a)}`,l=await m(n);ie(l),re(!0)}catch(n){x((n==null?void 0:n.status)===404?"No SEO data found for this collection":"Failed to load SEO data")}finally{je(!1)}},Je=()=>{if(S.length===0&&!y){x("Please select collections first");return}ae(!0)},Ve=async()=>{try{B(!0),ke("Checking eligibility...");const t=await m("/ai-enhance/check-eligibility",{method:"POST",shop:a,body:{shop:a}});if(!t.eligible){Ge(t.currentPlan||"starter"),q(!1),be(!0);return}q(!1);const l=p.filter(h=>S.includes(h.id)).filter(h=>{var c;return((c=h.optimizedLanguages)==null?void 0:c.length)>0}),r=l.length;w({current:0,total:r,percent:0});const o={};for(let h=0;h<l.length;h++){const c=l[h];$(c.title);try{const g=c.optimizedLanguages||[];if(g.length===0){console.log(`No optimized languages for ${c.title}, skipping`),o[c.id]={success:!1,skipped:!0,error:"No optimized languages"};continue}console.log(`Enhancing ${c.title} for languages:`,g);const R=await m(`/ai-enhance/collection/${encodeURIComponent(c.id)}`,{method:"POST",shop:a,body:{shop:a,languages:g}});o[c.id]={success:R.ok,skipped:!1,data:R,error:R.ok?null:R.error||"Enhancement failed"}}catch(g){console.error("Error enhancing collection:",c.id,g),o[c.id]={success:!1,skipped:!1,error:g.message}}const C=h+1,J=Math.round(C/r*100);w({current:C,total:r,percent:J})}ee(o),te(!0);const i=Object.values(o).filter(h=>h.success).length;x(`Enhanced ${i} collections`),await z()}catch(t){console.error("AI Enhance error:",t),x("Failed to enhance collections")}finally{B(!1),$("")}},Ye=async()=>{if(!k.length){x("Please select at least one language");return}ae(!1),B(!0),w({current:0,total:0,percent:0}),ge([]),ee({});try{const t=y?p:p.filter(o=>S.includes(o.id)),n=t.length;w({current:0,total:n,percent:0});const l={};for(let o=0;o<t.length;o++){const i=t[o];$(i.title);try{const C=await m("/seo/generate-collection-multi",{method:"POST",shop:a,body:{shop:a,collectionId:i.id,model:Ie,languages:k}});l[i.id]={success:!0,data:C}}catch(C){l[i.id]={success:!1,error:C.message},ge(J=>[...J,{collection:i.title,error:C.message}])}const h=o+1,c=Math.round(h/n*100);w({current:h,total:n,percent:c})}ee(l),te(!0);const r=Object.values(l).filter(o=>o.success).length;x(`Generated optimization for ${r} collections`)}catch(t){x(`Error: ${t.message}`)}finally{B(!1),$("")}},_e=async()=>{var t,n;B(!0),w({current:0,total:0,percent:0});try{const l=Object.entries(T).filter(([o,i])=>i.success),r=l.length;w({current:0,total:r,percent:0});for(let o=0;o<l.length;o++){const[i,h]=l[o],c=p.find(g=>g.id===i);if(!c)continue;$(c.title);try{if(console.log("Applying SEO for collection:",i),console.log("Result data:",h.data),console.log("Results array:",(t=h.data)==null?void 0:t.results),!((n=h.data)!=null&&n.results)||!Array.isArray(h.data.results))throw new Error("Invalid results structure");const g=await m("/seo/apply-collection-multi",{method:"POST",shop:a,body:{shop:a,collectionId:i,results:h.data.results.map(R=>({language:R.language,seo:R.data})),options:{updateTitle:!0,updateDescription:!0,updateSeo:!0,updateMetafields:!0}}});if(!(g!=null&&g.ok))throw new Error((g==null?void 0:g.error)||"Apply failed")}catch(g){console.error("Apply error for collection:",i,g),H.push({id:c.id,title:c.title,message:g.message})}const C=o+1,J=Math.round(C/r*100);w({current:C,total:r,percent:J})}x("Optimization applied successfully!"),te(!1),ee({}),N([]),await z(),V(!1)}catch(l){x(`Error applying optimization: ${l.message}`)}finally{B(!1),$("")}},Ke=async(t=[])=>{fe(!0),Le("");try{const n=y?p:p.filter(i=>S.includes(i.id)),l=n.length*t.length;let r=0;const o=[];for(const i of n)for(const h of t)try{await m("/collections/delete-seo",{method:"DELETE",shop:a,body:{shop:a,collectionId:i.id,language:h}})}catch(c){console.error(`Failed to delete ${h} for ${i.title}:`,c),o.push({id:i.id,title:i.title,message:c.message})}finally{r++,w({current:r,total:l,percent:Math.round(r/l*100)})}x(`Deleted optimization for ${t.join(", ").toUpperCase()}`),setTimeout(async()=>{await z(),N([]),V(!1),Q(!1)},100)}catch(n){x(`Delete error: ${n.message}`)}finally{fe(!1),Z([]),U([])}},Xe=t=>{var i,h;const n=((i=T[t.id])==null?void 0:i.success)||Se[t.id],l=((h=T[t.id])==null?void 0:h.data)||Se[t.id],r=t.optimizedLanguages||[],o=e.jsx(u,{width:"40px",height:"40px",background:"surface-neutral",borderRadius:"200"});return e.jsx(ft,{id:t.id,url:"",media:o,accessibilityLabel:`View details for ${t.title}`,children:e.jsxs(j,{gap:"400",align:"center",blockAlign:"center",wrap:!1,children:[e.jsxs(u,{style:{flex:"1 1 30%",minWidth:"200px"},children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:t.title}),e.jsxs(d,{variant:"bodySm",tone:"subdued",children:["Handle: ",t.handle]})]}),e.jsx(u,{style:{flex:"0 0 15%",minWidth:"100px",textAlign:"center"},children:e.jsxs(d,{variant:"bodyMd",children:[t.productsCount," products"]})}),e.jsx(u,{style:{flex:"0 0 25%",minWidth:"160px"},children:t.hasSeoData?e.jsx(j,{gap:"100",children:I.map(c=>e.jsx(W,{tone:r.includes(c)?"success":"subdued",size:"small",children:c.toUpperCase()},c))}):e.jsx(W,{tone:"subdued",children:"No AI Search Optimisation"})}),e.jsxs(u,{style:{flex:"0 0 15%",minWidth:"120px"},children:[n&&e.jsx(O,{size:"slim",onClick:()=>{ie(l),re(!0)},children:"Preview JSON"}),!n&&t.hasSeoData&&e.jsx(O,{size:"slim",loading:$e,onClick:()=>qe(t.id),children:"Preview JSON"})]})]})})},Ze=oe&&!Ne.processing&&e.jsx(f,{open:oe,title:"Processing Collections",onClose:()=>{},noScroll:!0,children:e.jsx(f.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(d,{variant:"bodyMd",children:ue?`Processing: ${ue}`:"Preparing..."}),e.jsx(Ce,{progress:M.percent}),e.jsxs(d,{variant:"bodySm",tone:"subdued",children:[M.current," of ",M.total," collections (",M.percent,"%)"]})]})})}),et=e.jsx(f,{open:Re,title:"Select Languages",primaryAction:{content:"Generate Optimization for AI Search",onAction:Ye,disabled:k.length===0},secondaryActions:[{content:"Cancel",onAction:()=>ae(!1)}],children:e.jsx(f.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(d,{variant:"bodyMd",children:["Select languages to generate AI Search Optimisation for ",y?"all":S.length," selected collections:"]}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(j,{gap:"200",wrap:!0,children:I.map(t=>e.jsx(we,{label:t.toUpperCase(),checked:k.includes(t),onChange:n=>{_(n?[...k,t]:k.filter(l=>l!==t))}},t))})}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(O,{plain:!0,onClick:()=>{_(k.length===I.length?[]:[...I])},children:k.length===I.length?"Deselect all":"Select all"})})]})})}),tt=e.jsx(f,{open:ze&&!oe,title:"AI Search Optimisation Results",primaryAction:{content:"Apply Optimisation",onAction:_e,disabled:!Object.values(T).some(t=>t.success)},secondaryActions:[{content:"Cancel",onAction:()=>te(!1)}],children:e.jsx(f.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(j,{gap:"400",children:[e.jsxs(u,{children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(d,{variant:"headingLg",fontWeight:"bold",tone:"success",children:Object.values(T).filter(t=>t.success&&!t.skipped).length})]}),e.jsxs(u,{children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Skipped:"}),e.jsx(d,{variant:"headingLg",fontWeight:"bold",tone:"info",children:Object.values(T).filter(t=>t.skipped).length})]}),e.jsxs(u,{children:[e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(d,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:Object.values(T).filter(t=>!t.success&&!t.skipped).length})]})]}),H.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(it,{}),e.jsx(d,{variant:"bodyMd",fontWeight:"semibold",children:"Errors:"}),e.jsxs(u,{maxHeight:"200px",overflowY:"scroll",children:[H.slice(0,10).map((t,n)=>e.jsxs(d,{variant:"bodySm",tone:"critical",children:[t.collection,": ",t.error]},n)),H.length>10&&e.jsxs(d,{variant:"bodySm",tone:"subdued",children:["... and ",H.length-10," more errors"]})]})]})]})})}),st=e.jsx(f,{open:Be,title:"SEO Data Preview",secondaryActions:[{content:"Close",onAction:()=>{re(!1),ie(null)}}],children:e.jsx(f.Section,{children:e.jsx(u,{children:e.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"12px",backgroundColor:"#f6f6f7",padding:"12px",borderRadius:"4px",maxHeight:"400px",overflow:"auto"},children:xe?JSON.stringify(xe,null,2):""})})})}),nt=e.jsx(f,{open:Pe,title:"Delete Optimization for AI Search",onClose:()=>{K(!1),U([])},primaryAction:{content:"Continue",onAction:()=>{Z(F),K(!1),X(!0)},disabled:F.length===0},secondaryActions:[{content:"Cancel",onAction:()=>{K(!1),U([])}}],children:e.jsx(f.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsxs(d,{variant:"bodyMd",children:["Select languages to delete AI Search Optimisation from ",y?E:S.length," selected collections:"]}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(j,{gap:"400",wrap:!1,children:I.map(t=>e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer",userSelect:"none"},children:[e.jsx("input",{type:"checkbox",checked:F.includes(t),onChange:n=>{U(n.target.checked?[...F,t]:F.filter(l=>l!==t))},style:{marginRight:"8px",width:"18px",height:"18px",cursor:"pointer"}}),e.jsx(d,{variant:"bodyMd",children:t.toUpperCase()})]},t))})}),e.jsx(u,{children:e.jsx(O,{plain:!0,onClick:()=>{U(F.length===I.length?[]:[...I])},children:"Select all"})}),e.jsx(u,{paddingBlockStart:"300",children:e.jsx(d,{variant:"bodySm",children:"Warning: This will permanently delete AI Search Optimisation data for selected languages."})})]})})}),lt=e.jsx(f,{open:Te,title:"Confirm Deletion",onClose:()=>{X(!1),Z([])},primaryAction:{content:"Delete",destructive:!0,onAction:async()=>{X(!1),setTimeout(()=>{Ke(me)},100)}},secondaryActions:[{content:"Cancel",onAction:()=>{X(!1),Z([]),U([])}}],children:e.jsx(f.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(d,{variant:"bodyMd",children:"Are you sure you want to delete AI Search Optimisation for the following languages?"}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(j,{gap:"200",children:me.map(t=>e.jsx(W,{tone:"warning",children:t.toUpperCase()},t))})}),e.jsxs(d,{variant:"bodyMd",children:["This will delete optimisation from ",y?E:S.length," selected collections."]}),e.jsx(u,{paddingBlockStart:"200",children:e.jsx(d,{variant:"bodySm",tone:"critical",children:"This action cannot be undone."})})]})})}),ot=pe&&e.jsx(f,{open:pe,title:"Deleting SEO Data",onClose:()=>{},noScroll:!0,children:e.jsx(f.Section,{children:e.jsxs(A,{gap:"400",children:[e.jsx(d,{variant:"bodyMd",children:"Deleting selected languages..."}),e.jsx(Ce,{progress:M.percent}),e.jsxs(d,{variant:"bodySm",tone:"subdued",children:[M.current," of ",M.total," operations (",M.percent,"%)"]})]})})}),at=e.jsx(mt,{heading:"No collections found",action:{content:"Clear filters",onAction:()=>{ne(""),Y("all"),z()}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Try adjusting your filters or search terms"})});return e.jsxs(e.Fragment,{children:[e.jsx(Ae,{children:e.jsxs(u,{padding:"400",children:[e.jsxs(j,{gap:"400",align:"space-between",blockAlign:"start",wrap:!1,children:[e.jsx(u,{minWidth:"400px",maxWidth:"600px",children:e.jsxs(A,{gap:"200",children:[e.jsx(ct,{label:"",placeholder:"Search by collection name...",value:D,onChange:ne,prefix:e.jsx(dt,{}),clearButton:!0,onClearButtonClick:()=>ne("")}),e.jsxs(j,{gap:"200",align:"start",children:[e.jsx(W,{tone:v.useGraphQLCollections?"success":"info",children:v.useGraphQLCollections?"GraphQL API":"REST API"}),G&&e.jsx(W,{tone:"attention",children:"Loading flags..."})]})]})}),e.jsxs(A,{gap:"200",children:[e.jsx(O,{primary:!0,onClick:Je,disabled:S.length===0&&!y,children:"Generate Optimization for AI Search"}),S.length===0&&!y||!p.filter(l=>S.includes(l.id)).some(l=>{var r;return((r=l.optimizedLanguages)==null?void 0:r.length)>0})?null:e.jsx(O,{onClick:()=>q(!0),disabled:S.length===0&&!y,children:"AI Enhanced add-ons for AI Search"}),e.jsx(O,{outline:!0,destructive:!0,onClick:()=>K(!0),disabled:S.length===0||!De,children:"Delete Optimization for AI Search"})]})]}),E>0&&e.jsx(u,{paddingBlockStart:"300",children:e.jsx(we,{label:`Select all ${E} collections`,checked:y,onChange:Qe})})]})}),e.jsx(u,{paddingBlockStart:"400",children:e.jsxs(Ae,{children:[e.jsxs(u,{padding:"400",borderBlockEndWidth:"025",borderColor:"border",children:[e.jsx(j,{gap:"200",wrap:!0,children:e.jsx(ht,{active:de,activator:e.jsx(O,{disclosure:"down",onClick:()=>le(!de),removeUnderline:!0,children:e.jsxs(j,{gap:"100",blockAlign:"center",children:[e.jsx("span",{children:"AI Search Status"}),b!=="all"&&e.jsx(u,{onClick:t=>{t.stopPropagation(),Y("all")},children:e.jsx(d,{as:"span",tone:"subdued",children:"✕"})})]})}),onClose:()=>le(!1),children:e.jsx(u,{padding:"300",minWidth:"200px",children:e.jsx(ut,{title:"AI Search Status",titleHidden:!0,choices:[{label:"All collections",value:"all"},{label:"Has AI Search Optimisation",value:"true"},{label:"No AI Search Optimisation",value:"false"}],selected:[b],onChange:t=>{Y(t[0]),le(!1)}})})})}),b!=="all"&&e.jsx(u,{paddingBlockStart:"200",children:e.jsx(j,{gap:"100",wrap:!0,children:e.jsx(W,{onRemove:()=>Y("all"),children:b==="true"?"Has AI Search Optimisation":"No AI Search Optimisation"})})})]}),e.jsx(gt,{resourceName:{singular:"collection",plural:"collections"},items:p,renderItem:Xe,selectedItems:S,onSelectionChange:He,selectable:!0,loading:P,totalItemsCount:E,emptyState:at,showHeader:!1})]})}),Ze,et,tt,st,nt,lt,ot,e.jsx(f,{open:Fe,onClose:()=>q(!1),title:"AI Enhanced add-ons for AI Search",primaryAction:{content:"Start AI Enhancement",onAction:Ve},secondaryActions:[{content:"Cancel",onAction:()=>q(!1)}],children:e.jsx(f.Section,{children:e.jsxs(A,{gap:"300",children:[e.jsxs(d,{variant:"bodyMd",children:["AI enhancement will improve bullets and FAQ for ",p.filter(t=>{var n;return S.includes(t.id)&&((n=t.optimizedLanguages)==null?void 0:n.length)>0}).length," collections."]}),e.jsx(d,{variant:"bodySm",tone:"subdued",children:"Note: AI enhancement is only available for Growth Extra and Enterprise plans."})]})})}),e.jsx(rt,{open:Ue,onClose:()=>be(!1),featureName:"AI Enhancement",currentPlan:We}),ye&&e.jsx(pt,{content:ye,onDismiss:()=>x("")})]})}export{Rt as default};
