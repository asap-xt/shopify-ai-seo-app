import{j as e}from"./app-bridge-Dm9-0DVV-1760383774562.js";import{r as o}from"./react-vendor-tAaa2TlE-1760383774562.js";import{c as O,L as u,C as A,a as f,I as c,r as _,T as a,f as P,d,D as p,h as R,B as L,n as K,w as V,M as C,x as X,i as Z}from"./polaris-B0EbbdxY-1760383774562.js";const M=[10,20,50,100];function ae({shop:y}){var U,W,$;const[Y,E]=o.useState(!0),[s,J]=o.useState(null),[x,B]=o.useState(null),[q,g]=o.useState(!1),[z,b]=o.useState(!1),[m,S]=o.useState(""),[v,k]=o.useState(M[0]),[w,T]=o.useState(!1),[D,h]=o.useState(null),F=o.useCallback(async()=>{try{E(!0),h(null);const n=await fetch(`/api/billing/info?shop=${y}`,{headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`HTTP ${n.status}`);const r=await n.json();J(r)}catch(n){console.error("[Billing] Error fetching info:",n),h("Failed to load billing information")}finally{E(!1)}},[y]);o.useEffect(()=>{F()},[F]);const G=async n=>{var r;try{T(!0),h(null);const i=await fetch("/api/billing/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:y,plan:n,endTrial:((r=s==null?void 0:s.subscription)==null?void 0:r.inTrial)||!1})}),j=await i.json();if(!i.ok)throw new Error(j.error||"Failed to create subscription");j.confirmationUrl&&(window.top.location.href=j.confirmationUrl)}catch(i){console.error("[Billing] Subscribe error:",i),h(i.message)}finally{T(!1),g(!1)}},H=async n=>{try{T(!0),h(null);const r=await fetch("/api/billing/tokens/purchase",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:y,amount:parseFloat(n)})}),i=await r.json();if(!r.ok)throw new Error(i.error||"Failed to purchase tokens");i.confirmationUrl&&(window.top.location.href=i.confirmationUrl)}catch(r){console.error("[Billing] Purchase error:",r),h(r.message)}finally{T(!1),b(!1)}},I=n=>{const r=n*.6;return Math.floor(r/.1*1e6)};if(Y)return e.jsx(O,{title:"Billing & Subscriptions",children:e.jsx(u,{children:e.jsx(u.Section,{children:e.jsx(A,{children:e.jsx(f,{padding:"800",children:e.jsxs(c,{align:"center",blockAlign:"center",children:[e.jsx(_,{size:"large"}),e.jsx(a,{variant:"bodyMd",children:"Loading billing information..."})]})})})})})});const t=s==null?void 0:s.subscription,l=s==null?void 0:s.tokens,Q=(s==null?void 0:s.plans)||[];return e.jsxs(O,{title:"Billing & Plans",children:[e.jsxs(u,{children:[D&&e.jsx(u.Section,{children:e.jsx(P,{title:"Error",tone:"critical",onDismiss:()=>h(null),children:e.jsx("p",{children:D})})}),(t==null?void 0:t.inTrial)&&e.jsx(u.Section,{children:e.jsx(P,{title:"Trial Period Active",tone:"info",action:{content:"Activate Plan",onAction:()=>g(!0)},children:e.jsxs("p",{children:["Your trial ends on ",new Date(t.trialEndsAt).toLocaleDateString(),". Activate a plan to continue using all features after ",new Date(t.trialEndsAt).toLocaleDateString(),"."]})})}),e.jsx(u.Section,{children:e.jsx(A,{children:e.jsxs(d,{gap:"400",children:[e.jsx(a,{variant:"headingLg",children:"Available Plans"}),e.jsx(p,{}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))",gap:"16px"},children:Q.map(n=>{var r,i;return e.jsx(A,{children:e.jsxs(d,{gap:"300",children:[e.jsxs(c,{align:"space-between",blockAlign:"center",children:[e.jsx(a,{variant:"headingMd",children:n.name}),(t==null?void 0:t.plan)===n.key&&e.jsx(R,{tone:"success",children:"Current"})]}),e.jsxs(a,{variant:"heading2xl",children:["$",n.price]}),e.jsx(a,{variant:"bodySm",tone:"subdued",children:"per month"}),e.jsx(p,{}),e.jsxs(c,{align:"space-between",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",children:"Products"}),e.jsx(a,{variant:"bodySm",fontWeight:"semibold",children:((r=n.productLimit)==null?void 0:r.toLocaleString())||"N/A"})]}),e.jsxs(c,{align:"space-between",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",children:"AI Queries"}),e.jsx(a,{variant:"bodySm",fontWeight:"semibold",children:((i=n.queryLimit)==null?void 0:i.toLocaleString())||"N/A"})]}),n.includedTokens>0&&e.jsxs(R,{tone:"info",children:["+",n.includedTokens.toLocaleString()," tokens/month"]}),n.features&&n.features.length>0&&e.jsxs(f,{children:[e.jsx(a,{variant:"bodySm",fontWeight:"semibold",children:"Features:"}),e.jsxs(d,{gap:"100",children:[n.features.slice(0,5).map((j,N)=>e.jsxs(a,{variant:"bodySm",tone:"subdued",children:["✓ ",j]},N)),n.features.length>5&&e.jsxs(a,{variant:"bodySm",tone:"subdued",children:["+ ",n.features.length-5," more..."]})]})]}),e.jsx(L,{variant:(t==null?void 0:t.plan)===n.key?"plain":"primary",fullWidth:!0,disabled:(t==null?void 0:t.plan)===n.key,onClick:()=>{B(n),g(!0)},children:(t==null?void 0:t.plan)===n.key?"Current Plan":"Select Plan"})]})},n.key)})})]})})}),e.jsx(u.Section,{variant:"oneThird",children:e.jsx(A,{children:e.jsxs(d,{gap:"400",children:[e.jsxs(c,{align:"space-between",blockAlign:"center",children:[e.jsx(a,{variant:"headingMd",children:"Token Balance"}),e.jsx(K,{source:V,tone:"base"})]}),e.jsx(p,{}),e.jsxs(d,{gap:"300",children:[e.jsxs(f,{children:[e.jsx(a,{variant:"heading2xl",alignment:"center",children:((U=l==null?void 0:l.balance)==null?void 0:U.toLocaleString())||0}),e.jsx(a,{variant:"bodySm",tone:"subdued",alignment:"center",children:"tokens available"})]}),e.jsxs(c,{align:"space-between",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",children:"Purchased"}),e.jsx(a,{variant:"bodySm",children:((W=l==null?void 0:l.totalPurchased)==null?void 0:W.toLocaleString())||0})]}),e.jsxs(c,{align:"space-between",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",children:"Used"}),e.jsx(a,{variant:"bodySm",children:(($=l==null?void 0:l.totalUsed)==null?void 0:$.toLocaleString())||0})]}),e.jsx(p,{}),e.jsx(L,{variant:"primary",fullWidth:!0,onClick:()=>b(!0),children:"Buy Tokens"}),e.jsx(f,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",children:e.jsxs(d,{gap:"100",children:[e.jsx(a,{variant:"bodySm",tone:"subdued",children:"💡 Tokens enable AI features"}),e.jsx(a,{variant:"bodySm",tone:"subdued",children:"♻️ Never expire, roll over monthly"})]})})]})]})})})]}),e.jsx(C,{open:q,onClose:()=>{g(!1),B(null)},title:"Confirm Plan Selection",primaryAction:{content:w?"Processing...":"Confirm",loading:w,onAction:()=>G((x==null?void 0:x.key)||(t==null?void 0:t.plan))},secondaryActions:[{content:"Cancel",onAction:()=>{g(!1),B(null)}}],children:e.jsx(C.Section,{children:e.jsxs(d,{gap:"400",children:[e.jsxs(a,{children:["You are about to subscribe to the ",e.jsx("strong",{children:(x==null?void 0:x.name)||(t==null?void 0:t.plan)})," plan."]}),(t==null?void 0:t.inTrial)&&e.jsx(P,{tone:"warning",children:e.jsx("p",{children:"This will end your trial period and start billing immediately."})})]})})}),e.jsx(C,{open:z,onClose:()=>{b(!1),S(""),k(M[0])},title:"Purchase Tokens",primaryAction:{content:w?"Processing...":"Purchase",loading:w,onAction:()=>H(m||v)},secondaryActions:[{content:"Cancel",onAction:()=>{b(!1),S(""),k(M[0])}}],children:e.jsx(C.Section,{children:e.jsxs(d,{gap:"400",children:[e.jsx(a,{variant:"headingMd",children:"Select Amount"}),e.jsx(X,{variant:"segmented",children:M.map(n=>e.jsxs(L,{pressed:v===n&&!m,onClick:()=>{k(n),S("")},children:["$",n]},n))}),e.jsx(a,{variant:"bodyMd",tone:"subdued",children:"Or enter a custom amount (multiples of $5)"}),e.jsx(Z,{type:"number",value:m,onChange:n=>{S(n),k(null)},placeholder:"Enter amount",prefix:"$",min:5,step:5,autoComplete:"off"}),e.jsx(f,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:e.jsxs(d,{gap:"200",children:[e.jsxs(c,{align:"space-between",children:[e.jsx(a,{variant:"bodyMd",children:"Amount"}),e.jsxs(a,{variant:"bodyMd",fontWeight:"semibold",children:["$",m||v]})]}),e.jsxs(c,{align:"space-between",children:[e.jsx(a,{variant:"bodyMd",children:"Tokens"}),e.jsx(a,{variant:"bodyMd",fontWeight:"semibold",children:I(parseFloat(m||v)).toLocaleString()})]}),e.jsx(p,{}),e.jsx(a,{variant:"bodySm",tone:"subdued",children:"Tokens never expire and roll over indefinitely"})]})}),(t==null?void 0:t.inTrial)&&e.jsx(P,{tone:"info",children:e.jsx("p",{children:"Your trial will continue after purchasing tokens."})})]})})})]})}export{ae as default};
