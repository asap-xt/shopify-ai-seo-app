import{r as e,j as t}from"./react-vendor-BXVC7v0l.js";import{m as n}from"./sessionFetch-BXzpx4mg.js";import{T as i,I as s,a}from"./TokenPurchaseModal-DozAvzCY.js";import{U as r}from"./UpgradeModal-X30D51Sc.js";import{C as o,B as l,a as d,d as c,I as u,i as p,T as h,b as g,o as m,p as x,q as j,D as v,f as b,M as f,l as S}from"./polaris-CyaoFo5Q.js";import"./app-bridge-DUY42B6P.js";import"./vendor-Cs_VgJ2r.js";import"./index-CXDrMNGG.js";function A({shop:A}){var y,w;const k=A||((e,t="")=>{try{return new URLSearchParams(window.location.search).get(e)||t}catch{return t}})("shop",""),[I,C]=e.useState(null),[P,T]=e.useState(!1),[M,_]=e.useState(""),[z,E]=e.useState(null),[R,q]=e.useState(null),[O,$]=e.useState(!1),B=e.useMemo(()=>n(),[]),[W,L]=e.useState(!1),[F,G]=e.useState(null),[U,D]=e.useState(!1),[N,H]=e.useState({inProgress:!1,status:"idle",message:null,position:null,estimatedTime:null,generatedAt:null,productCount:0}),Q=e.useRef(null),[Y,J]=e.useState(!1),[K,V]=e.useState(null),[X,Z]=e.useState(!1),[ee,te]=e.useState(!1),[ne,ie]=e.useState(!1),[se,ae]=e.useState(!1),[re,oe]=e.useState(null),[le,de]=e.useState(!1),[ce,ue]=e.useState(null),[pe,he]=e.useState(!1),ge=e.useCallback(async()=>{if(k)try{const e=await B(`/api/sitemap/info?shop=${k}`);C(e)}catch(e){_(e.message||"Failed to load sitemap info")}},[k,B]),me=e.useCallback(async()=>{var e,t,n;if(k)try{const i="\n        query PlansMe($shop:String!) {\n          plansMe(shop:$shop) {\n            shop\n            plan\n            planKey\n            priceUsd\n            product_limit\n            collection_limit\n            language_limit\n            providersAllowed\n            modelsSuggested\n            autosyncCron\n            trial {\n              active\n              ends_at\n              days_left\n            }\n          }\n        }\n      ",s=await B("/graphql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:i,variables:{shop:k}})});if(null==(e=null==s?void 0:s.errors)?void 0:e.length)throw new Error((null==(t=s.errors[0])?void 0:t.message)||"GraphQL error");const a=null==(n=null==s?void 0:s.data)?void 0:n.plansMe;E(a||null)}catch(i){}},[k,B]),xe=e.useCallback(async()=>{var e,t,n,i;if(k){T(!0),q(null);try{const s=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(k)}`,{method:"POST",credentials:"include",headers:{Authorization:`Bearer ${(null==(n=null==(t=null==(e=window.__SHOPIFY_APP_BRIDGE__)?void 0:e.getState())?void 0:t.session)?void 0:n.token)||""}`,"Content-Type":"application/json"}});if(s.ok){const e=await s.json();e.success?(_(e.message||"Sitemap generation started!"),q(e.job),(null==(i=e.job)?void 0:i.queued)&&$(!0)):_(e.message||"Sitemap generation failed")}else{const e=await s.text();_(`Sitemap generation failed: ${e}`)}}catch(s){_(s.message||"Sitemap generation failed")}finally{T(!1)}}},[k]),je=e.useCallback(async()=>{if(k&&O)try{const e=await B(`/api/sitemap/status?shop=${k}`);q(e.queue),"completed"!==e.queue.status&&"failed"!==e.queue.status&&"idle"!==e.queue.status||($(!1),_(e.queue.message||"Sitemap generation completed!"),await ge())}catch(e){}},[k,O,B,ge]);e.useEffect(()=>{if(O){const e=setInterval(je,3e3);return()=>clearInterval(e)}},[O,je]);const ve=e.useCallback(async()=>{var e,t,n;if(k){L(!0),D(!0),G(null);try{const i=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(k)}&force=true&t=${Date.now()}`,{method:"GET",credentials:"include",headers:{Authorization:`Bearer ${(null==(n=null==(t=null==(e=window.__SHOPIFY_APP_BRIDGE__)?void 0:e.getState())?void 0:t.session)?void 0:n.token)||""}`}});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);{const e=await i.text();G(e)}}catch(i){G(`Error loading sitemap: ${i.message}`)}finally{D(!1)}}},[k]),be=e.useCallback(async()=>{var e,t;if(k)try{const n=await B(`/api/sitemap/status?shop=${k}`);(null==(e=n.sitemap)?void 0:e.generatedAt)&&!0===(null==(t=n.sitemap)?void 0:t.isAiEnhanced)?V({generated:!0,generatedAt:n.sitemap.generatedAt,productCount:n.sitemap.productCount||0}):V(null)}catch(n){}},[k,B]),fe=e.useCallback(async()=>{try{const e=await B(`/api/sitemap/status?shop=${k}`);return H(t=>{var n,i,s,a,r;return t.inProgress&&!e.inProgress&&("completed"===e.status||"failed"===e.status)&&(Q.current&&(clearInterval(Q.current),Q.current=null),"completed"===e.status?(_(`AI-Optimized Sitemap generated! (${(null==(n=e.sitemap)?void 0:n.productCount)||0} products)`),be()):"failed"===e.status&&_("AI-Optimized Sitemap generation failed")),{inProgress:e.inProgress||!1,status:e.status||"idle",message:e.message||null,position:(null==(i=e.queue)?void 0:i.position)||null,estimatedTime:(null==(s=e.queue)?void 0:s.estimatedTime)||null,generatedAt:(null==(a=e.sitemap)?void 0:a.generatedAt)||null,productCount:(null==(r=e.sitemap)?void 0:r.productCount)||0}}),e}catch(e){}},[k,B,be]),Se=e.useCallback(()=>{Q.current&&clearInterval(Q.current),fe(),Q.current=setInterval(()=>{fe()},5e3)},[fe]),Ae=e.useCallback(async()=>{var e,t,n;if(k){J(!0);try{const s=((null==z?void 0:z.plan)||"starter").toLowerCase().replace(" ","_"),a=["growth_extra","growth extra","enterprise"],r=["professional_plus","professional plus","growth_plus","growth plus"].includes(s);if(!a.includes(s)&&!r)return ae(!0),void J(!1);if(r)try{const e=(await B(`/api/billing/tokens/balance?shop=${k}`)).balance||0;if(!(e>0))return oe({feature:"ai-sitemap-optimized",tokensRequired:3e3,tokensAvailable:e,tokensNeeded:3e3}),te(!0),void J(!1)}catch(i){return _("Failed to check token balance"),void J(!1)}const o=await B("/graphql",{method:"POST",body:JSON.stringify({query:"mutation RegenerateSitemap($shop: String!) {\n            regenerateSitemap(shop: $shop) {\n              success\n              message\n              queued\n              position\n              estimatedTime\n            }\n          }",variables:{shop:k}})});if(null==(e=null==o?void 0:o.errors)?void 0:e.length){const e=(null==(t=o.errors[0])?void 0:t.message)||"GraphQL error";if(e.includes("TRIAL_RESTRICTION"))return oe({trialRestriction:!0,requiresActivation:!0,message:"AI-Optimized Sitemap is locked during trial period. Activate your plan to unlock."}),void Z(!0);throw new Error(e)}const l=null==(n=null==o?void 0:o.data)?void 0:n.regenerateSitemap;if(null==l?void 0:l.success)_(l.message||"AI-Optimized Sitemap generation started!"),l.queued&&(H({inProgress:!0,status:"queued",message:"Queued for processing...",position:l.position,estimatedTime:l.estimatedTime,generatedAt:null,productCount:0}),Se());else{if(((null==l?void 0:l.message)||"").startsWith("TRIAL_RESTRICTION:"))return J(!1),oe({trialRestriction:!0,requiresActivation:!0,feature:"ai-sitemap-optimized",currentPlan:(null==z?void 0:z.plan)||"enterprise"}),void Z(!0);_((null==l?void 0:l.message)||"Failed to start AI-Optimized Sitemap generation")}}catch(i){402===i.status&&i.trialRestriction&&i.requiresActivation?(oe({trialRestriction:!0,requiresActivation:!0,feature:"ai-sitemap-optimized",currentPlan:(null==z?void 0:z.plan)||"enterprise"}),Z(!0)):402===i.status||i.requiresPurchase?(oe(i),te(!0)):_(i.message||"Failed to generate AI-Optimized Sitemap")}finally{J(!1)}}},[k,B,z,Se]),ye=e.useCallback(async()=>{var e,t,n;if(k){de(!0),he(!0),ue(null);try{const i=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(k)}&force=true&ai=true&t=${Date.now()}`,{method:"GET",credentials:"include",headers:{Authorization:`Bearer ${(null==(n=null==(t=null==(e=window.__SHOPIFY_APP_BRIDGE__)?void 0:e.getState())?void 0:t.session)?void 0:n.token)||""}`}});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);{const e=await i.text();ue(e)}}catch(i){ue(`Error loading AI sitemap: ${i.message}`)}finally{he(!1)}}},[k]),we=e.useCallback(async()=>{try{const e=await B("/api/billing/activate",{method:"POST",body:{shop:k}});(null==e?void 0:e.confirmationUrl)?window.top.location.href=e.confirmationUrl:_("Failed to activate plan")}catch(e){_(e.message||"Failed to activate plan")}},[k,B]);return e.useEffect(()=>()=>{Q.current&&clearInterval(Q.current)},[]),e.useEffect(()=>{ge(),me(),be(),fe().then(e=>{(null==e?void 0:e.inProgress)&&Se()})},[ge,me,be,fe,Se]),t.jsxs(o,{children:[t.jsx(l,{padding:"400",children:t.jsxs(d,{gap:"400",children:[t.jsx(c,{tone:"info",children:t.jsxs("p",{children:["Your ",(null==z?void 0:z.plan)||"Starter"," plan includes up to"," ",t.jsxs("strong",{children:[(null==(y=null==z?void 0:z.product_limit)?void 0:y.toLocaleString())||"70"," products in up to ",(null==z?void 0:z.language_limit)||1," language",((null==z?void 0:z.language_limit)||1)>1?"s":""]}),".",(null==I?void 0:I.productCount)&&(null==z?void 0:z.product_limit)&&I.productCount>z.product_limit&&t.jsxs(t.Fragment,{children:[" You have ",I.productCount," products, so only the first"," ",z.product_limit.toLocaleString()," ","will be included in the sitemap."]})]})}),(O||R)&&t.jsx(c,{tone:"processing"===(null==R?void 0:R.status)?"info":"failed"===(null==R?void 0:R.status)?"critical":"success",children:t.jsxs(d,{gap:"200",children:[t.jsxs(u,{gap:"200",blockAlign:"center",children:[O&&t.jsx(p,{size:"small"}),t.jsx(h,{variant:"bodyMd",fontWeight:"medium",children:(null==R?void 0:R.message)||"Processing..."})]}),(null==R?void 0:R.position)>0&&t.jsxs(h,{variant:"bodySm",tone:"subdued",children:["Position in queue: ",R.position," | Estimated time: ~",R.estimatedTime,"s"]}),(null==R?void 0:R.queueLength)>0&&t.jsxs(h,{variant:"bodySm",tone:"subdued",children:["Queue length: ",R.queueLength," job(s)"]})]})}),t.jsxs(u,{align:"space-between",blockAlign:"center",children:[t.jsxs(l,{children:[t.jsx(h,{variant:"headingMd",as:"h3",children:"Sitemap Generator"}),t.jsx(h,{variant:"bodySm",tone:"subdued",children:"Generate structured sitemap for AI models to discover and index your products"})]}),t.jsx(g,{primary:!0,onClick:xe,loading:P,disabled:P,children:P?"Generating...":"Generate Sitemap"})]}),I&&t.jsx(l,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:t.jsxs(d,{gap:"300",children:[t.jsx(u,{gap:"200",blockAlign:"center",children:I.generated?t.jsxs(t.Fragment,{children:[t.jsx(m,{source:x,tone:"success"}),t.jsx(h,{variant:"bodyMd",fontWeight:"semibold",tone:"success",children:"Sitemap Active"})]}):t.jsxs(t.Fragment,{children:[t.jsx(m,{source:j}),t.jsx(h,{variant:"bodyMd",fontWeight:"semibold",children:"No Sitemap Found"})]})}),I.generated&&t.jsxs(d,{gap:"400",children:[t.jsx(l,{children:t.jsxs(d,{gap:"200",children:[t.jsx(l,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(u,{align:"space-between",children:[t.jsx(h,{variant:"bodyMd",color:"subdued",children:"Products included"}),t.jsxs(h,{variant:"bodyMd",fontWeight:"semibold",children:[I.lastProductCount||0," URLs"]})]})}),t.jsx(l,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(u,{align:"space-between",children:[t.jsx(h,{variant:"bodyMd",color:"subdued",children:"File size"}),t.jsx(h,{variant:"bodyMd",fontWeight:"semibold",children:I.size?`${(I.size/1024).toFixed(2)} KB`:"Unknown"})]})}),t.jsx(l,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(u,{align:"space-between",children:[t.jsx(h,{variant:"bodyMd",color:"subdued",children:"Last updated"}),t.jsx(h,{variant:"bodyMd",fontWeight:"semibold",children:I.generatedAt?new Date(I.generatedAt).toLocaleString():"Unknown"})]})})]})}),t.jsx(l,{children:t.jsx(g,{fullWidth:!0,onClick:ve,children:"View Sitemap"})})]})]})}),t.jsxs(l,{paddingBlockStart:"400",children:[t.jsx(h,{variant:"headingMd",as:"h4",children:"What's included:"}),t.jsx(l,{paddingBlockStart:"200",children:t.jsxs(d,{gap:"200",children:[t.jsxs(u,{gap:"200",blockAlign:"start",children:[t.jsx(l,{minWidth:"24px",children:t.jsx(m,{source:x,tone:"positive"})}),t.jsx(h,{children:"All active products with structured URLs for AI parsing"})]}),t.jsxs(u,{gap:"200",blockAlign:"start",children:[t.jsx(l,{minWidth:"24px",children:t.jsx(m,{source:x,tone:"positive"})}),t.jsx(h,{children:"Priority rankings to help AI models understand product importance"})]}),t.jsxs(u,{gap:"200",blockAlign:"start",children:[t.jsx(l,{minWidth:"24px",children:t.jsx(m,{source:x,tone:"positive"})}),t.jsx(h,{children:"Multi-language URLs for international AI search coverage"})]}),t.jsxs(u,{gap:"200",blockAlign:"start",children:[t.jsx(l,{minWidth:"24px",children:t.jsx(m,{source:x,tone:"positive"})}),t.jsx(h,{children:"Standard XML format that AI crawlers understand"})]})]})})]}),t.jsxs(l,{paddingBlockStart:"200",children:[t.jsx(h,{variant:"headingMd",as:"h4",children:"How it helps AI models:"}),t.jsx(l,{paddingBlockStart:"200",children:t.jsxs(d,{gap:"200",children:[t.jsx(h,{children:'1. Click "Generate Sitemap" to create a structured map of your products'}),t.jsx(h,{children:"2. The sitemap is automatically saved and available to AI crawlers"}),t.jsx(h,{children:"3. AI models can discover and understand your product catalog structure"}),t.jsx(h,{children:"4. Regenerate when you add new products to keep AI models updated"})]})})]}),(null==I?void 0:I.generated)&&t.jsxs(t.Fragment,{children:[t.jsx(v,{}),t.jsx(l,{paddingBlockStart:"200",children:t.jsxs(d,{gap:"400",children:[t.jsxs(u,{align:"space-between",blockAlign:"center",children:[t.jsxs(l,{children:[t.jsxs(u,{gap:"200",blockAlign:"center",children:[t.jsx(h,{variant:"headingMd",as:"h3",children:"AI-Optimized Sitemap"}),t.jsx(b,{tone:"info",children:"Premium"})]}),t.jsx(h,{variant:"bodySm",tone:"subdued",children:"Enhance your sitemap with AI-generated descriptions for better AI discovery"})]}),t.jsx(g,{primary:!0,onClick:Ae,loading:Y,disabled:Y||N.inProgress,children:Y||N.inProgress?"Generating...":"Generate AI-Optimized"})]}),N.inProgress&&t.jsx(c,{tone:"info",children:t.jsxs(u,{gap:"300",blockAlign:"center",children:[t.jsx(p,{size:"small"}),t.jsxs(d,{gap:"100",children:[t.jsx(h,{variant:"bodyMd",fontWeight:"semibold",children:"Generating AI-Optimized Sitemap..."}),t.jsx(h,{variant:"bodySm",tone:"subdued",children:N.message||"Processing in background..."}),N.position>0&&t.jsxs(h,{variant:"bodySm",tone:"subdued",children:["Queue position: ",N.position," Â· Est. ",Math.ceil((N.estimatedTime||60)/60)," min"]})]})]})}),!N.inProgress&&((null==K?void 0:K.generated)||"completed"===N.status)&&t.jsx(l,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:t.jsxs(d,{gap:"300",children:[t.jsxs(u,{gap:"200",blockAlign:"center",children:[t.jsx(m,{source:x,tone:"success"}),t.jsx(h,{variant:"bodyMd",fontWeight:"semibold",tone:"success",children:"AI-Optimized Sitemap Active"}),t.jsx(b,{tone:"success",children:"Generated"})]}),t.jsxs(d,{gap:"200",children:[t.jsx(l,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(u,{align:"space-between",children:[t.jsx(h,{variant:"bodyMd",color:"subdued",children:"Products included"}),t.jsxs(h,{variant:"bodyMd",fontWeight:"semibold",children:[(null==K?void 0:K.productCount)||N.productCount||0," products"]})]})}),t.jsx(l,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(u,{align:"space-between",children:[t.jsx(h,{variant:"bodyMd",color:"subdued",children:"Last generated"}),t.jsx(h,{variant:"bodyMd",fontWeight:"semibold",children:(e=>{if(!e)return"";const t=Math.floor((new Date-new Date(e))/1e3);if(t<60)return"just now";const n=Math.floor(t/60);if(n<60)return`${n}m ago`;const i=Math.floor(n/60);if(i<24)return`${i}h ago`;return`${Math.floor(i/24)}d ago`})((null==K?void 0:K.generatedAt)||N.generatedAt)})]})})]}),t.jsx(g,{fullWidth:!0,onClick:ye,children:"View AI-Optimized Sitemap"})]})}),t.jsxs(l,{paddingBlockStart:"200",children:[t.jsx(h,{variant:"headingSm",as:"h4",children:"What AI-Optimization adds:"}),t.jsx(l,{paddingBlockStart:"200",children:t.jsxs(d,{gap:"200",children:[t.jsxs(u,{gap:"200",blockAlign:"start",children:[t.jsx(l,{minWidth:"24px",children:t.jsx(m,{source:x,tone:"positive"})}),t.jsx(h,{children:"AI-generated product descriptions optimized for AI crawlers"})]}),t.jsxs(u,{gap:"200",blockAlign:"start",children:[t.jsx(l,{minWidth:"24px",children:t.jsx(m,{source:x,tone:"positive"})}),t.jsx(h,{children:"Enhanced metadata for better AI understanding"})]}),t.jsxs(u,{gap:"200",blockAlign:"start",children:[t.jsx(l,{minWidth:"24px",children:t.jsx(m,{source:x,tone:"positive"})}),t.jsx(h,{children:"Structured data annotations for AI parsing"})]})]})})]})]})})]})]})}),W&&t.jsx(f,{open:W,onClose:()=>{L(!1),G(null)},title:"AI-Optimized Sitemap",primaryAction:{content:"Copy",onAction:()=>{navigator.clipboard.writeText(F),_("Copied to clipboard!")},disabled:U},secondaryActions:[{content:"Close",onAction:()=>{L(!1),G(null)}}],children:t.jsx(f.Section,{children:t.jsx(l,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:U?t.jsxs(u,{align:"center",gap:"200",children:[t.jsx(p,{size:"small"}),t.jsx(h,{variant:"bodyMd",children:"Loading sitemap XML... This may take a moment for large stores."})]}):t.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"12px",margin:0,overflow:"auto",maxHeight:"400px"},children:F})})})}),le&&t.jsx(f,{open:le,onClose:()=>{de(!1),ue(null)},title:"AI-Optimized Sitemap",primaryAction:{content:"Copy",onAction:()=>{navigator.clipboard.writeText(ce),_("Copied to clipboard!")},disabled:pe},secondaryActions:[{content:"Close",onAction:()=>{de(!1),ue(null)}}],children:t.jsx(f.Section,{children:t.jsx(l,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:pe?t.jsxs(u,{align:"center",gap:"200",children:[t.jsx(p,{size:"small"}),t.jsx(h,{variant:"bodyMd",children:"Loading AI-optimized sitemap..."})]}):t.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"12px",margin:0,overflow:"auto",maxHeight:"400px"},children:ce})})})}),t.jsx(i,{open:X,onClose:()=>{Z(!1),oe(null)},featureName:"AI-Optimized Sitemap",currentPlan:(null==z?void 0:z.plan)||"Starter",trialEndsAt:null==(w=null==z?void 0:z.trial)?void 0:w.ends_at,onActivatePlan:we,onPurchaseTokens:()=>{Z(!1),ie(!0)}}),t.jsx(s,{open:ee,onClose:()=>{te(!1),oe(null)},featureName:"AI-Optimized Sitemap",tokensRequired:null==re?void 0:re.tokensRequired,tokensAvailable:null==re?void 0:re.tokensAvailable,currentPlan:(null==z?void 0:z.plan)||"Starter",needsUpgrade:null==re?void 0:re.needsUpgrade,onBuyTokens:()=>{te(!1),ie(!0)}}),t.jsx(a,{open:ne,onClose:()=>ie(!1),shop:k,returnTo:window.location.pathname+window.location.search}),t.jsx(r,{open:se,onClose:()=>ae(!1),featureName:"AI-Optimized Sitemap",currentPlan:(null==z?void 0:z.plan)||"Starter",minimumPlanRequired:"Professional Plus",features:["AI-enhanced product descriptions in sitemap","Better AI crawler understanding","Professional Plus, Growth Plus, Growth Extra, or Enterprise plan","Or purchase tokens on any Plus plan"],returnTo:window.location.pathname+window.location.search}),M&&t.jsx(S,{content:M,onDismiss:()=>_("")})]})}export{A as default};
