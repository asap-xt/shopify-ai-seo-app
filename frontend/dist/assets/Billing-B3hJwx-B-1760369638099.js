import{j as e}from"./app-bridge-Bihe1x3o-1760369638099.js";import{r as d}from"./react-vendor-tAaa2TlE-1760369638099.js";import{c as R,L as h,C as b,a as f,I as s,r as _,T as i,f as C,d as o,h as L,D as j,B as p,n as K,w as V,M as A,x as X,i as Z}from"./polaris-BukPmfrF-1760369638099.js";const M=[10,20,50,100];function te({shop:y}){var D,F,N;const[Y,E]=d.useState(!0),[l,J]=d.useState(null),[W,B]=d.useState(null),[q,u]=d.useState(!1),[z,S]=d.useState(!1),[m,v]=d.useState(""),[k,T]=d.useState(M[0]),[w,P]=d.useState(!1),[U,x]=d.useState(null),$=d.useCallback(async()=>{try{E(!0),x(null);const t=await fetch(`/api/billing/info?shop=${y}`,{headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const a=await t.json();J(a)}catch(t){console.error("[Billing] Error fetching info:",t),x("Failed to load billing information")}finally{E(!1)}},[y]);d.useEffect(()=>{$()},[$]);const G=async t=>{var a;try{P(!0),x(null);const r=await fetch("/api/billing/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:y,plan:t,endTrial:((a=l==null?void 0:l.subscription)==null?void 0:a.inTrial)||!1})}),g=await r.json();if(!r.ok)throw new Error(g.error||"Failed to create subscription");g.confirmationUrl&&(window.top.location.href=g.confirmationUrl)}catch(r){console.error("[Billing] Subscribe error:",r),x(r.message)}finally{P(!1),u(!1)}},H=async t=>{try{P(!0),x(null);const a=await fetch("/api/billing/tokens/purchase",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:y,amount:parseFloat(t)})}),r=await a.json();if(!a.ok)throw new Error(r.error||"Failed to purchase tokens");r.confirmationUrl&&(window.top.location.href=r.confirmationUrl)}catch(a){console.error("[Billing] Purchase error:",a),x(a.message)}finally{P(!1),S(!1)}},I=t=>{const a=t*.6;return Math.floor(a/.1*1e6)};if(Y)return e.jsx(R,{title:"Billing & Subscriptions",children:e.jsx(h,{children:e.jsx(h.Section,{children:e.jsx(b,{children:e.jsx(f,{padding:"800",children:e.jsxs(s,{align:"center",blockAlign:"center",children:[e.jsx(_,{size:"large"}),e.jsx(i,{variant:"bodyMd",children:"Loading billing information..."})]})})})})})});const n=l==null?void 0:l.subscription,c=l==null?void 0:l.tokens,Q=(l==null?void 0:l.plans)||[];return e.jsxs(R,{title:"Billing & Plans",children:[e.jsxs(h,{children:[U&&e.jsx(h.Section,{children:e.jsx(C,{title:"Error",tone:"critical",onDismiss:()=>x(null),children:e.jsx("p",{children:U})})}),(n==null?void 0:n.inTrial)&&e.jsx(h.Section,{children:e.jsx(C,{title:"Trial Period Active",tone:"info",action:{content:"Choose Plan",onAction:()=>u(!0)},children:e.jsxs("p",{children:["Your trial ends on ",new Date(n.trialEndsAt).toLocaleDateString(),". Choose a plan to continue using all features after your trial."]})})}),e.jsx(h.Section,{children:e.jsx(b,{children:e.jsxs(o,{gap:"400",children:[e.jsxs(s,{align:"space-between",blockAlign:"center",children:[e.jsx(i,{variant:"headingMd",children:"Your Plan"}),n&&e.jsx(L,{tone:n.inTrial?"attention":"success",children:n.inTrial?"Trial":"Active"})]}),e.jsx(j,{}),n?e.jsxs(o,{gap:"300",children:[e.jsxs(s,{align:"space-between",children:[e.jsx(i,{variant:"bodyMd",tone:"subdued",children:"Plan"}),e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:n.plan.charAt(0).toUpperCase()+n.plan.slice(1)})]}),e.jsxs(s,{align:"space-between",children:[e.jsx(i,{variant:"bodyMd",tone:"subdued",children:"Price"}),e.jsxs(i,{variant:"bodyMd",fontWeight:"semibold",children:["$",n.price,"/month"]})]}),n.inTrial&&e.jsxs(s,{align:"space-between",children:[e.jsx(i,{variant:"bodyMd",tone:"subdued",children:"Trial ends"}),e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:new Date(n.trialEndsAt).toLocaleDateString()})]}),e.jsx(j,{}),e.jsx(p,{variant:"primary",fullWidth:!0,onClick:()=>u(!0),children:n.inTrial?"Choose Plan":"Change Plan"})]}):e.jsxs(o,{gap:"300",children:[e.jsx(i,{variant:"bodyMd",tone:"subdued",children:"No active subscription"}),e.jsx(p,{variant:"primary",fullWidth:!0,onClick:()=>u(!0),children:"Choose a Plan"})]})]})})}),e.jsx(h.Section,{variant:"oneThird",children:e.jsx(b,{children:e.jsxs(o,{gap:"400",children:[e.jsxs(s,{align:"space-between",blockAlign:"center",children:[e.jsx(i,{variant:"headingMd",children:"Token Balance"}),e.jsx(K,{source:V,tone:"base"})]}),e.jsx(j,{}),e.jsxs(o,{gap:"300",children:[e.jsxs(f,{children:[e.jsx(i,{variant:"heading2xl",alignment:"center",children:((D=c==null?void 0:c.balance)==null?void 0:D.toLocaleString())||0}),e.jsx(i,{variant:"bodySm",tone:"subdued",alignment:"center",children:"tokens available"})]}),e.jsxs(s,{align:"space-between",children:[e.jsx(i,{variant:"bodySm",tone:"subdued",children:"Purchased"}),e.jsx(i,{variant:"bodySm",children:((F=c==null?void 0:c.totalPurchased)==null?void 0:F.toLocaleString())||0})]}),e.jsxs(s,{align:"space-between",children:[e.jsx(i,{variant:"bodySm",tone:"subdued",children:"Used"}),e.jsx(i,{variant:"bodySm",children:((N=c==null?void 0:c.totalUsed)==null?void 0:N.toLocaleString())||0})]}),e.jsx(j,{}),e.jsx(p,{variant:"primary",fullWidth:!0,onClick:()=>S(!0),children:"Buy Tokens"}),e.jsx(f,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",children:e.jsxs(o,{gap:"100",children:[e.jsx(i,{variant:"bodySm",tone:"subdued",children:"💡 Tokens enable AI features"}),e.jsx(i,{variant:"bodySm",tone:"subdued",children:"♻️ Never expire, roll over monthly"})]})})]})]})})}),e.jsx(h.Section,{children:e.jsx(b,{children:e.jsxs(o,{gap:"400",children:[e.jsx(i,{variant:"headingLg",children:"Available Plans"}),e.jsx(j,{}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))",gap:"16px"},children:Q.map(t=>{var a,r;return e.jsx(b,{children:e.jsxs(o,{gap:"300",children:[e.jsxs(s,{align:"space-between",blockAlign:"center",children:[e.jsx(i,{variant:"headingMd",children:t.name}),(n==null?void 0:n.plan)===t.key&&e.jsx(L,{tone:"success",children:"Current"})]}),e.jsxs(i,{variant:"heading2xl",children:["$",t.price]}),e.jsx(i,{variant:"bodySm",tone:"subdued",children:"per month"}),e.jsx(j,{}),e.jsxs(s,{align:"space-between",children:[e.jsx(i,{variant:"bodySm",tone:"subdued",children:"Products"}),e.jsx(i,{variant:"bodySm",fontWeight:"semibold",children:((a=t.productLimit)==null?void 0:a.toLocaleString())||"N/A"})]}),e.jsxs(s,{align:"space-between",children:[e.jsx(i,{variant:"bodySm",tone:"subdued",children:"AI Queries"}),e.jsx(i,{variant:"bodySm",fontWeight:"semibold",children:((r=t.queryLimit)==null?void 0:r.toLocaleString())||"N/A"})]}),t.includedTokens>0&&e.jsxs(L,{tone:"info",children:["+",t.includedTokens.toLocaleString()," tokens/month"]}),t.features&&t.features.length>0&&e.jsxs(f,{children:[e.jsx(i,{variant:"bodySm",fontWeight:"semibold",children:"Features:"}),e.jsxs(o,{gap:"100",children:[t.features.slice(0,5).map((g,O)=>e.jsxs(i,{variant:"bodySm",tone:"subdued",children:["✓ ",g]},O)),t.features.length>5&&e.jsxs(i,{variant:"bodySm",tone:"subdued",children:["+ ",t.features.length-5," more..."]})]})]}),e.jsx(p,{variant:(n==null?void 0:n.plan)===t.key?"secondary":"primary",fullWidth:!0,disabled:(n==null?void 0:n.plan)===t.key,onClick:()=>{B(t.key),u(!0)},children:(n==null?void 0:n.plan)===t.key?"Current Plan":"Select Plan"})]})},t.key)})})]})})})]}),e.jsx(A,{open:q,onClose:()=>{u(!1),B(null)},title:"Confirm Plan Selection",primaryAction:{content:w?"Processing...":"Confirm",loading:w,onAction:()=>G(W||(n==null?void 0:n.plan))},secondaryActions:[{content:"Cancel",onAction:()=>{u(!1),B(null)}}],children:e.jsx(A.Section,{children:e.jsxs(o,{gap:"400",children:[e.jsxs(i,{children:["You are about to subscribe to the ",e.jsx("strong",{children:W||(n==null?void 0:n.plan)})," plan."]}),(n==null?void 0:n.inTrial)&&e.jsx(C,{tone:"warning",children:e.jsx("p",{children:"This will end your trial period and start billing immediately."})})]})})}),e.jsx(A,{open:z,onClose:()=>{S(!1),v(""),T(M[0])},title:"Purchase Tokens",primaryAction:{content:w?"Processing...":"Purchase",loading:w,onAction:()=>H(m||k)},secondaryActions:[{content:"Cancel",onAction:()=>{S(!1),v(""),T(M[0])}}],children:e.jsx(A.Section,{children:e.jsxs(o,{gap:"400",children:[e.jsx(i,{variant:"headingMd",children:"Select Amount"}),e.jsx(X,{variant:"segmented",children:M.map(t=>e.jsxs(p,{pressed:k===t&&!m,onClick:()=>{T(t),v("")},children:["$",t]},t))}),e.jsx(i,{variant:"bodyMd",tone:"subdued",children:"Or enter a custom amount (multiples of $5)"}),e.jsx(Z,{type:"number",value:m,onChange:t=>{v(t),T(null)},placeholder:"Enter amount",prefix:"$",min:5,step:5,autoComplete:"off"}),e.jsx(f,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:e.jsxs(o,{gap:"200",children:[e.jsxs(s,{align:"space-between",children:[e.jsx(i,{variant:"bodyMd",children:"Amount"}),e.jsxs(i,{variant:"bodyMd",fontWeight:"semibold",children:["$",m||k]})]}),e.jsxs(s,{align:"space-between",children:[e.jsx(i,{variant:"bodyMd",children:"Tokens"}),e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:I(parseFloat(m||k)).toLocaleString()})]}),e.jsx(j,{}),e.jsx(i,{variant:"bodySm",tone:"subdued",children:"Tokens never expire and roll over indefinitely"})]})}),(n==null?void 0:n.inTrial)&&e.jsx(C,{tone:"info",children:e.jsx("p",{children:"Your trial will continue after purchasing tokens."})})]})})})]})}export{te as default};
