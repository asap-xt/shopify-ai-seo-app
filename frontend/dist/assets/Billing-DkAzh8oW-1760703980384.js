import{j as e}from"./app-bridge-_ygnHCH1-1760703980384.js";import{r as l}from"./react-vendor-tAaa2TlE-1760703980384.js";import{L as x,C as P,a as j,I as c,r as _,T as r,f as y,d as s,h as O,D as C,B as E,M as m,w as K,i as Q}from"./polaris-BIwdZeMC-1760703980384.js";const B=[10,20,50,100];function ae({shop:S}){var $,D,W;const[N,U]=l.useState(!0),[o,Y]=l.useState(null),[u,L]=l.useState(null),[q,f]=l.useState(!1),[z,v]=l.useState(!1),[H,b]=l.useState(!1),[p,k]=l.useState(""),[w,T]=l.useState(B[0]),[A,M]=l.useState(!1),[F,h]=l.useState(null),R=l.useCallback(async()=>{try{U(!0),h(null);const a=await fetch(`/api/billing/info?shop=${S}`,{headers:{"Content-Type":"application/json"}});if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.json();Y(t)}catch(a){console.error("[Billing] Error fetching info:",a),h("Failed to load billing information")}finally{U(!1)}},[S]);l.useEffect(()=>{R()},[R]);const J=async a=>{var t;try{M(!0),h(null);const i=await fetch("/api/billing/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:S,plan:a,endTrial:((t=o==null?void 0:o.subscription)==null?void 0:t.inTrial)||!1})}),g=await i.json();if(!i.ok)throw new Error(g.error||"Failed to create subscription");g.confirmationUrl&&(window.top.location.href=g.confirmationUrl)}catch(i){console.error("[Billing] Subscribe error:",i),h(i.message)}finally{M(!1),f(!1)}},G=async a=>{try{M(!0),h(null);const t=await fetch("/api/billing/tokens/purchase",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shop:S,amount:parseFloat(a)})}),i=await t.json();if(!t.ok)throw new Error(i.error||"Failed to purchase tokens");i.confirmationUrl&&(window.top.location.href=i.confirmationUrl)}catch(t){console.error("[Billing] Purchase error:",t),h(t.message)}finally{M(!1),v(!1)}},I=a=>{const t=a*.6;return Math.floor(t/.1*1e6)};if(N)return e.jsx(e.Fragment,{children:e.jsx(x,{children:e.jsx(x.Section,{children:e.jsx(P,{children:e.jsx(j,{padding:"800",children:e.jsxs(c,{align:"center",blockAlign:"center",children:[e.jsx(_,{size:"large"}),e.jsx(r,{variant:"bodyMd",children:"Loading billing information..."})]})})})})})});const n=o==null?void 0:o.subscription,d=o==null?void 0:o.tokens,V=(o==null?void 0:o.plans)||[];return console.log("[Billing] Current plan:",n==null?void 0:n.plan,"Type:",typeof(n==null?void 0:n.plan)),e.jsxs(e.Fragment,{children:[e.jsxs(x,{children:[F&&e.jsx(x.Section,{children:e.jsx(y,{title:"Error",tone:"critical",onDismiss:()=>h(null),children:e.jsx("p",{children:F})})}),(n==null?void 0:n.inTrial)&&e.jsx(x.Section,{children:e.jsx(y,{title:"Trial Period Active",tone:"info",action:{content:"Activate Plan",onAction:()=>f(!0)},children:e.jsxs("p",{children:["Your trial ends on ",new Date(n.trialEndsAt).toLocaleDateString(),". Activate a plan to continue using all features after ",new Date(n.trialEndsAt).toLocaleDateString(),"."]})})}),e.jsx(x.Section,{children:e.jsx(P,{children:e.jsx(s,{gap:"400",children:e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))",gap:"16px"},children:V.map(a=>{var t;return e.jsx(P,{children:e.jsxs(s,{gap:"300",children:[e.jsxs(c,{align:"space-between",blockAlign:"center",children:[e.jsx(r,{variant:"headingMd",children:a.name}),(n==null?void 0:n.plan)===a.key&&e.jsx(O,{tone:"success",children:"Current"})]}),e.jsxs(r,{variant:"heading2xl",children:["$",a.price]}),e.jsx(r,{variant:"bodySm",tone:"subdued",children:"per month"}),e.jsx(C,{}),e.jsxs(c,{align:"space-between",children:[e.jsx(r,{variant:"bodySm",tone:"subdued",children:"Products"}),e.jsxs(r,{variant:"bodySm",fontWeight:"semibold",children:["up to ",((t=a.productLimit)==null?void 0:t.toLocaleString())||"N/A"]})]}),e.jsxs(c,{align:"space-between",children:[e.jsx(r,{variant:"bodySm",tone:"subdued",children:"Supported languages"}),e.jsx(r,{variant:"bodySm",fontWeight:"semibold",children:a.languageLimit||1})]}),a.includedTokens>0&&!["growth extra","enterprise"].includes(a.key)&&e.jsxs(O,{tone:"info",children:["+",a.includedTokens.toLocaleString()," tokens/month"]}),a.features&&a.features.length>0&&e.jsxs(j,{children:[e.jsx(r,{variant:"bodySm",fontWeight:"semibold",children:"Features:"}),e.jsxs(s,{gap:"100",children:[a.features.slice(0,5).map((i,g)=>e.jsxs(r,{variant:"bodySm",tone:"subdued",children:["✓ ",i]},g)),a.features.length>5&&e.jsxs(r,{variant:"bodySm",tone:"subdued",children:["+ ",a.features.length-5," more..."]})]})]}),e.jsx(E,{variant:(n==null?void 0:n.plan)===a.key?"plain":"primary",fullWidth:!0,disabled:(n==null?void 0:n.plan)===a.key,onClick:()=>{L(a),f(!0)},children:(n==null?void 0:n.plan)===a.key?"Current Plan":"Select Plan"})]})},a.key)})})})})}),e.jsx(x.Section,{variant:"oneThird",children:e.jsx(P,{children:e.jsxs(s,{gap:"400",children:[e.jsx(r,{variant:"headingMd",children:"Token Balance"}),e.jsx(C,{}),e.jsxs(s,{gap:"300",children:[e.jsxs(j,{children:[e.jsx(r,{variant:"heading2xl",alignment:"center",children:(($=d==null?void 0:d.balance)==null?void 0:$.toLocaleString())||0}),e.jsx(r,{variant:"bodySm",tone:"subdued",alignment:"center",children:"tokens available"}),((n==null?void 0:n.plan)==="growth extra"||(n==null?void 0:n.plan)==="enterprise")&&e.jsxs(r,{variant:"bodySm",tone:"subdued",alignment:"center",children:["(",(n==null?void 0:n.plan)==="growth extra"?"100M":"300M"," included this cycle)"]})]}),e.jsxs(c,{align:"space-between",children:[e.jsx(r,{variant:"bodySm",tone:"subdued",children:(n==null?void 0:n.plan)==="growth extra"||(n==null?void 0:n.plan)==="enterprise"?"Additional Purchased":"Purchased"}),e.jsx(r,{variant:"bodySm",children:((D=d==null?void 0:d.totalPurchased)==null?void 0:D.toLocaleString())||0})]}),e.jsxs(c,{align:"space-between",children:[e.jsx(r,{variant:"bodySm",tone:"subdued",children:"Used"}),e.jsx(r,{variant:"bodySm",children:((W=d==null?void 0:d.totalUsed)==null?void 0:W.toLocaleString())||0})]}),e.jsx(C,{}),e.jsx(E,{variant:"primary",fullWidth:!0,onClick:()=>{console.log("[Billing] Buy Tokens clicked. Plan:",n==null?void 0:n.plan,"Comparison:",(n==null?void 0:n.plan)==="starter"),(n==null?void 0:n.plan)==="starter"?(console.log("[Billing] Showing upgrade modal for Starter plan"),b(!0)):(console.log("[Billing] Showing token purchase modal"),v(!0))},children:"Buy Tokens"}),e.jsx(j,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",children:e.jsxs(s,{gap:"100",children:[e.jsx(r,{variant:"bodySm",tone:"subdued",children:"💡 Tokens enable AI features"}),e.jsx(r,{variant:"bodySm",tone:"subdued",children:"♻️ Never expire, roll over monthly"})]})})]})]})})})]}),e.jsx(m,{open:q,onClose:()=>{f(!1),L(null)},title:"Confirm Plan Selection",primaryAction:{content:A?"Processing...":"Confirm",loading:A,onAction:()=>J((u==null?void 0:u.key)||(n==null?void 0:n.plan))},secondaryActions:[{content:"Cancel",onAction:()=>{f(!1),L(null)}}],children:e.jsx(m.Section,{children:e.jsxs(s,{gap:"400",children:[e.jsxs(r,{children:["You are about to subscribe to the ",e.jsx("strong",{children:(u==null?void 0:u.name)||(n==null?void 0:n.plan)})," plan."]}),(n==null?void 0:n.inTrial)&&e.jsx(y,{tone:"warning",children:e.jsx("p",{children:"This will end your trial period and start billing immediately."})})]})})}),e.jsx(m,{open:z,onClose:()=>{v(!1),k(""),T(B[0])},title:"Purchase Tokens",primaryAction:{content:A?"Processing...":"Purchase",loading:A,onAction:()=>G(p||w)},secondaryActions:[{content:"Cancel",onAction:()=>{v(!1),k(""),T(B[0])}}],children:e.jsx(m.Section,{children:e.jsxs(s,{gap:"400",children:[e.jsx(r,{variant:"headingMd",children:"Select Amount"}),e.jsx(K,{variant:"segmented",children:B.map(a=>e.jsxs(E,{pressed:w===a&&!p,onClick:()=>{T(a),k("")},children:["$",a]},a))}),e.jsx(r,{variant:"bodyMd",tone:"subdued",children:"Or enter a custom amount (multiples of $5)"}),e.jsx(Q,{type:"number",value:p,onChange:a=>{k(a),T(null)},placeholder:"Enter amount",prefix:"$",min:5,step:5,autoComplete:"off"}),e.jsx(j,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:e.jsxs(s,{gap:"200",children:[e.jsxs(c,{align:"space-between",children:[e.jsx(r,{variant:"bodyMd",children:"Amount"}),e.jsxs(r,{variant:"bodyMd",fontWeight:"semibold",children:["$",p||w]})]}),e.jsxs(c,{align:"space-between",children:[e.jsx(r,{variant:"bodyMd",children:"Tokens"}),e.jsx(r,{variant:"bodyMd",fontWeight:"semibold",children:I(parseFloat(p||w)).toLocaleString()})]}),e.jsx(C,{}),e.jsx(r,{variant:"bodySm",tone:"subdued",children:"Tokens never expire and roll over indefinitely"})]})}),(n==null?void 0:n.inTrial)&&e.jsx(y,{tone:"info",children:e.jsx("p",{children:"Your trial will continue after purchasing tokens."})})]})})}),e.jsx(m,{open:H,onClose:()=>b(!1),title:"Upgrade Required",primaryAction:{content:"View Plans",onAction:()=>{b(!1),window.scrollTo({top:0,behavior:"smooth"})}},secondaryActions:[{content:"Cancel",onAction:()=>b(!1)}],children:e.jsx(m.Section,{children:e.jsxs(s,{gap:"400",children:[e.jsxs(r,{variant:"bodyLg",children:["Token purchases require ",e.jsx("strong",{children:"Professional"})," plan or higher."]}),e.jsxs(r,{variant:"bodyMd",tone:"subdued",children:["Your current plan: ",e.jsx("strong",{children:"Starter"})]}),e.jsx(j,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:e.jsxs(s,{gap:"200",children:[e.jsx(r,{variant:"headingSm",children:"Upgrade to unlock:"}),e.jsx(r,{variant:"bodyMd",children:"✓ Token purchases"}),e.jsx(r,{variant:"bodyMd",children:"✓ AI-enhanced optimization"}),e.jsx(r,{variant:"bodyMd",children:"✓ Store Metadata for AI Search"}),e.jsx(r,{variant:"bodyMd",children:"✓ More AI bot access"}),e.jsx(r,{variant:"bodyMd",children:"✓ Higher product limits"})]})}),e.jsx(y,{tone:"info",children:e.jsx("p",{children:"Professional plan starts at $15.99/month with up to 250 products."})})]})})})]})}export{ae as default};
