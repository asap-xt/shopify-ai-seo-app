import{j as e}from"./app-bridge-BBQkl22A-1758035570226.js";import{r as s}from"./react-vendor-tAaa2TlE-1758035570226.js";import{m as tt}from"./index-CE9vuTD2-1758035570226.js";import{M as u,d as w,T as i,e as oe,a as r,I as C,f as ye,B as O,D as st,g as q,C as Ce,h as nt,S as lt,P as ot,i as at,R as it,j as rt,l as ct,E as dt}from"./polaris-HiI2ZWh4-1758035570226.js";const ht=(Q,c="")=>{try{return new URLSearchParams(window.location.search).get(Q)||c}catch{return c}};function wt({shop:Q}){const c=Q||ht("shop",""),m=s.useMemo(()=>tt(),[]),[x,Ae]=s.useState([]),[ve,ae]=s.useState(!1),[W,we]=s.useState(0),[S,$]=s.useState([]),[A,Y]=s.useState(!1),[ut,ie]=s.useState(""),[D,_]=s.useState(""),[v,U]=s.useState("all"),[re,K]=s.useState(!1),[Ie,Ee]=s.useState(""),[gt,ke]=s.useState([]),[I,N]=s.useState([]),[E,ce]=s.useState([]),[X,B]=s.useState(!1),[k,M]=s.useState({current:0,total:0,percent:0}),[de,H]=s.useState(""),[z,he]=s.useState([]),[pt,ft]=s.useState(!1),[xt,St]=s.useState(null),[mt,jt]=s.useState(!1),[bt,Me]=s.useState(""),[Oe,G]=s.useState(!1),[T,R]=s.useState([]),[ue,ge]=s.useState(!1),[De,F]=s.useState(!1),[Pe,J]=s.useState(!1),[pe,V]=s.useState([]),[P,Z]=s.useState({}),[Le,ee]=s.useState(!1),[Be,te]=s.useState(!1),[fe,Te]=s.useState({}),[Re,se]=s.useState(!1),[xe,ne]=s.useState(null),[We,Se]=s.useState(!1),[me,f]=s.useState(""),[le,je]=s.useState(!1),[g,be]=s.useState({processing:!1,current:0,total:0,currentItem:"",results:null});s.useEffect(()=>{c&&m("/plans/me",{shop:c}).then(t=>{const n=(t==null?void 0:t.modelsSuggested)||["google/gemini-1.5-flash"];ke(n.map(l=>({label:l,value:l}))),Ee(n[0])}).catch(t=>f(`Error loading models: ${t.message}`))},[c,m]),s.useEffect(()=>{c&&m(`/api/languages/shop/${c}`).then(t=>{const n=(t==null?void 0:t.shopLanguages)||["en"];ce(n),N([])}).catch(()=>{ce(["en"]),N([])})},[c,m]);const L=s.useCallback(async()=>{ae(!0);try{const t=new URLSearchParams({shop:c,...D&&{search:D},...v!=="all"&&{optimized:v}});let l=(await m(`/collections/list?${t}`)).collections||[];if(D){const o=D.toLowerCase();l=l.filter(a=>a.title.toLowerCase().includes(o)||a.handle.toLowerCase().includes(o))}v!=="all"&&(l=l.filter(o=>v==="true"?o.hasSeoData:!o.hasSeoData)),Ae(l),we(l.length)}catch(t){f(`Error loading collections: ${t.message}`)}finally{ae(!1)}},[c,D,v,m]);s.useEffect(()=>{c&&(L(),F(!1))},[c,v]),s.useEffect(()=>{const t=setTimeout(()=>{c&&L()},500);return()=>clearTimeout(t)},[D]);const $e=s.useCallback(t=>{$(t);const n=t.some(l=>{const o=x.find(a=>a.id===l);return o==null?void 0:o.hasSeoData});F(n),t.length===0&&Y(!1)},[x]),ze=s.useCallback(t=>{if(Y(t),t){$(x.map(l=>l.id));const n=x.some(l=>l.hasSeoData);F(n)}else $([]),F(!1)},[x]),Fe=async t=>{Se(!0);try{const n=`/collections/${t.split("/").pop()}/seo-data?shop=${encodeURIComponent(c)}`,l=await m(n);ne(l),se(!0)}catch(n){f((n==null?void 0:n.status)===404?"No SEO data found for this collection":"Failed to load SEO data")}finally{Se(!1)}},Ue=()=>{if(S.length===0&&!A){f("Please select collections first");return}te(!0)},Ne=()=>{const t=x.filter(a=>S.includes(a.id)),n=t.filter(a=>{var d;return((d=a.optimizedLanguages)==null?void 0:d.length)>0}),l=async()=>{try{B(!0),ie("Checking eligibility...");const a=await m("/ai-enhance/check-eligibility",{method:"POST",shop:c,body:{shop:c}});if(!a.eligible){f(a.reason||"AI Enhance add-ons not available for your plan");return}console.log("Selected collections:",t),console.log("Selected collections length:",t.length),console.log("Shop domain:",c),console.log("Selected language:",I);const d={successful:0,failed:0,skipped:0};for(const h of t)try{console.log("Starting AI enhance for collection:",h),console.log("Collection ID:",h.id),console.log("Encoded ID:",encodeURIComponent(h.id)),console.log("Full endpoint:",`/ai-enhance/collection/${encodeURIComponent(h.id)}`);const p=h.optimizedLanguages||["en"];console.log("Request body:",{shop:c,languages:p});try{console.log("Before API call");const j=await m(`/ai-enhance/collection/${encodeURIComponent(h.id)}`,{method:"POST",shop:c,body:{shop:c,languages:p}});console.log("After API call, result:",j),j.ok?(d.successful++,console.log(`Enhanced ${h.title} successfully`)):(d.failed++,console.log(`Failed to enhance ${h.title}`,j))}catch(j){console.error("API call error:",j),d.failed++}}catch(p){console.error("Error enhancing collection:",h.id,p),d.failed++,f(`Error enhancing ${h.title}`)}be({processing:!1,current:0,total:0,currentItem:"",results:d}),await L()}catch(a){console.error("AI Enhance error:",a),f("Failed to enhance collections")}finally{B(!1),ie("")}},o=()=>{je(!1),be({processing:!1,current:0,total:0,currentItem:"",results:null}),g.results&&g.results.successful>0&&L()};return!g.processing&&!g.results?e.jsx(u,{open:le,title:"AI Enhanced add-ons for AI Search",onClose:o,primaryAction:{content:"Start AI Enhancement",onAction:l},secondaryActions:[{content:"Cancel",onAction:o}],children:e.jsx(u.Section,{children:e.jsxs(w,{gap:"300",children:[e.jsxs(i,{variant:"bodyMd",children:["AI enhancement will improve bullets and FAQ for ",n.length," collections."]}),e.jsx(i,{variant:"bodySm",tone:"subdued",children:"Note: AI enhancement is only available for Growth Extra and Enterprise plans."})]})})}):g.processing?e.jsx(u,{open:le,title:"Processing AI Enhancement",onClose:()=>{},noScroll:!0,children:e.jsx(u.Section,{children:e.jsxs(w,{gap:"400",children:[e.jsxs(i,{variant:"bodyMd",children:["Processing: ",g.currentItem]}),e.jsx(oe,{progress:g.current/g.total*100}),e.jsxs(i,{variant:"bodySm",tone:"subdued",children:[g.current," of ",g.total," collections (",Math.round(g.current/g.total*100),"%)"]})]})})}):g.results!==null?e.jsx(u,{open:le,title:"AI Enhancement Results",onClose:o,primaryAction:{content:"Done",onAction:o},children:e.jsx(u.Section,{children:e.jsxs(w,{gap:"300",children:[e.jsxs(C,{gap:"400",children:[e.jsxs(r,{children:[e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(i,{variant:"headingLg",fontWeight:"bold",tone:"success",children:g.results.successful})]}),e.jsxs(r,{children:[e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(i,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:g.results.failed})]}),e.jsxs(r,{children:[e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:"Skipped:"}),e.jsx(i,{variant:"headingLg",fontWeight:"bold",tone:"info",children:g.results.skipped})]})]}),g.results.skippedDueToPlan>0&&e.jsx(r,{paddingBlockStart:"300",children:e.jsx(i,{variant:"bodySm",tone:"subdued",children:"AI enhancement is only available for Growth Extra and Enterprise plans."})})]})})}):null},He=async()=>{if(!I.length){f("Please select at least one language");return}te(!1),B(!0),M({current:0,total:0,percent:0}),he([]),Z({});try{const t=A?x:x.filter(a=>S.includes(a.id)),n=t.length;M({current:0,total:n,percent:0});const l={};for(let a=0;a<t.length;a++){const d=t[a];H(d.title);try{const j=await m("/seo/generate-collection-multi",{method:"POST",shop:c,body:{shop:c,collectionId:d.id,model:Ie,languages:I}});l[d.id]={success:!0,data:j}}catch(j){l[d.id]={success:!1,error:j.message},he(b=>[...b,{collection:d.title,error:j.message}])}const h=a+1,p=Math.round(h/n*100);M({current:h,total:n,percent:p})}Z(l),ee(!0);const o=Object.values(l).filter(a=>a.success).length;f(`Generated SEO for ${o} collections`)}catch(t){f(`Error: ${t.message}`)}finally{B(!1),H("")}},Ge=async()=>{B(!0),M({current:0,total:0,percent:0});try{const t=Object.entries(P).filter(([o,a])=>a.success),n=t.length;M({current:0,total:n,percent:0});for(let o=0;o<t.length;o++){const[a,d]=t[o],h=x.find(b=>b.id===a);if(!h)continue;H(h.title);try{const b=await m("/seo/apply-collection-multi",{method:"POST",shop:c,body:{shop:c,collectionId:a,results:d.data.results.filter(y=>y==null?void 0:y.seo).map(y=>({language:y.language,seo:y.seo})),options:{updateTitle:!0,updateDescription:!0,updateSeo:!0,updateMetafields:!0}}});if(!(b!=null&&b.ok))throw new Error((b==null?void 0:b.error)||"Apply failed");M(y=>({...y,current:y.current+1,percent:Math.round((y.current+1)/y.total*100)}))}catch(b){z.push({id:h.id,title:h.title,message:b.message})}const p=o+1,j=Math.round(p/n*100);M({current:p,total:n,percent:j})}const l={};Object.entries(P).forEach(([o,a])=>{a.success&&(l[o]=a.data)}),Te(o=>({...o,...l})),f("SEO applied successfully!"),ee(!1),Z({}),$([]),await L()}catch(t){f(`Error applying SEO: ${t.message}`)}finally{B(!1),H("")}},Je=async(t=[])=>{ge(!0),Me("");try{const n=A?x:x.filter(d=>S.includes(d.id)),l=n.length*t.length;let o=0;const a=[];for(const d of n)for(const h of t)try{await m("/collections/delete-seo",{method:"DELETE",shop:c,body:{shop:c,collectionId:d.id,language:h}})}catch(p){console.error(`Failed to delete ${h} for ${d.title}:`,p),a.push({id:d.id,title:d.title,message:p.message})}finally{o++,M({current:o,total:l,percent:Math.round(o/l*100)})}f(`Deleted SEO for ${t.join(", ").toUpperCase()}`),setTimeout(async()=>{await L(),$([]),Y(!1),F(!1)},100)}catch(n){f(`Delete error: ${n.message}`)}finally{ge(!1),V([]),R([])}},Ve=t=>{var d,h;const n=((d=P[t.id])==null?void 0:d.success)||fe[t.id],l=((h=P[t.id])==null?void 0:h.data)||fe[t.id],o=t.optimizedLanguages||[],a=e.jsx(r,{width:"40px",height:"40px",background:"surface-neutral",borderRadius:"200"});return e.jsx(ct,{id:t.id,url:"",media:a,accessibilityLabel:`View details for ${t.title}`,children:e.jsxs(C,{gap:"400",align:"center",blockAlign:"center",wrap:!1,children:[e.jsxs(r,{style:{flex:"1 1 30%",minWidth:"200px"},children:[e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:t.title}),e.jsxs(i,{variant:"bodySm",tone:"subdued",children:["Handle: ",t.handle]})]}),e.jsx(r,{style:{flex:"0 0 15%",minWidth:"100px",textAlign:"center"},children:e.jsxs(i,{variant:"bodyMd",children:[t.productsCount," products"]})}),e.jsx(r,{style:{flex:"0 0 25%",minWidth:"160px"},children:t.hasSeoData?e.jsx(C,{gap:"100",children:E.map(p=>e.jsx(q,{tone:o.includes(p)?"success":"subdued",size:"small",children:p.toUpperCase()},p))}):e.jsx(q,{tone:"subdued",children:"No AI Search Optimisation"})}),e.jsxs(r,{style:{flex:"0 0 15%",minWidth:"120px"},children:[n&&e.jsx(O,{size:"slim",onClick:()=>{ne(l),se(!0)},children:"Preview JSON"}),!n&&t.hasSeoData&&e.jsx(O,{size:"slim",loading:We,onClick:()=>Fe(t.id),children:"Preview JSON"})]})]})})},qe=X&&e.jsx(u,{open:X,title:"Processing Collections",onClose:()=>{},noScroll:!0,children:e.jsx(u.Section,{children:e.jsxs(w,{gap:"400",children:[e.jsx(i,{variant:"bodyMd",children:de?`Processing: ${de}`:"Preparing..."}),e.jsx(oe,{progress:k.percent}),e.jsxs(i,{variant:"bodySm",tone:"subdued",children:[k.current," of ",k.total," collections (",k.percent,"%)"]})]})})}),Qe=e.jsx(u,{open:Be,title:"Select Languages",primaryAction:{content:"Generate Optimization for AI Search",onAction:He,disabled:I.length===0},secondaryActions:[{content:"Cancel",onAction:()=>te(!1)}],children:e.jsx(u.Section,{children:e.jsxs(w,{gap:"300",children:[e.jsxs(i,{variant:"bodyMd",children:["Select languages to generate AI Search Optimisation for ",A?"all":S.length," selected collections:"]}),e.jsx(r,{paddingBlockStart:"200",children:e.jsx(C,{gap:"200",wrap:!0,children:E.map(t=>e.jsx(ye,{label:t.toUpperCase(),checked:I.includes(t),onChange:n=>{N(n?[...I,t]:I.filter(l=>l!==t))}},t))})}),e.jsx(r,{paddingBlockStart:"200",children:e.jsx(O,{plain:!0,onClick:()=>{N(I.length===E.length?[]:[...E])},children:I.length===E.length?"Deselect all":"Select all"})})]})})}),Ye=e.jsx(u,{open:Le&&!X,title:"AI Search Optimisation Results",primaryAction:{content:"Apply Optimisation",onAction:Ge,disabled:!Object.values(P).some(t=>t.success)},secondaryActions:[{content:"Cancel",onAction:()=>ee(!1)}],children:e.jsx(u.Section,{children:e.jsxs(w,{gap:"300",children:[e.jsxs(C,{gap:"400",children:[e.jsxs(r,{children:[e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(i,{variant:"headingLg",fontWeight:"bold",tone:"success",children:Object.values(P).filter(t=>t.success).length})]}),e.jsxs(r,{children:[e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(i,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:Object.values(P).filter(t=>!t.success).length})]})]}),z.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(st,{}),e.jsx(i,{variant:"bodyMd",fontWeight:"semibold",children:"Errors:"}),e.jsxs(r,{maxHeight:"200px",overflowY:"scroll",children:[z.slice(0,10).map((t,n)=>e.jsxs(i,{variant:"bodySm",tone:"critical",children:[t.collection,": ",t.error]},n)),z.length>10&&e.jsxs(i,{variant:"bodySm",tone:"subdued",children:["... and ",z.length-10," more errors"]})]})]})]})})}),_e=e.jsx(u,{open:Re,title:"SEO Data Preview",secondaryActions:[{content:"Close",onAction:()=>{se(!1),ne(null)}}],children:e.jsx(u.Section,{children:e.jsx(r,{children:e.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"12px",backgroundColor:"#f6f6f7",padding:"12px",borderRadius:"4px",maxHeight:"400px",overflow:"auto"},children:xe?JSON.stringify(xe,null,2):""})})})}),Ke=e.jsx(u,{open:Oe,title:"Delete Optimization for AI Search",onClose:()=>{G(!1),R([])},primaryAction:{content:"Continue",onAction:()=>{V(T),G(!1),J(!0)},disabled:T.length===0},secondaryActions:[{content:"Cancel",onAction:()=>{G(!1),R([])}}],children:e.jsx(u.Section,{children:e.jsxs(w,{gap:"400",children:[e.jsxs(i,{variant:"bodyMd",children:["Select languages to delete AI Search Optimisation from ",A?W:S.length," selected collections:"]}),e.jsx(r,{paddingBlockStart:"200",children:e.jsx(C,{gap:"400",wrap:!1,children:E.map(t=>e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer",userSelect:"none"},children:[e.jsx("input",{type:"checkbox",checked:T.includes(t),onChange:n=>{R(n.target.checked?[...T,t]:T.filter(l=>l!==t))},style:{marginRight:"8px",width:"18px",height:"18px",cursor:"pointer"}}),e.jsx(i,{variant:"bodyMd",children:t.toUpperCase()})]},t))})}),e.jsx(r,{children:e.jsx(O,{plain:!0,onClick:()=>{R(T.length===E.length?[]:[...E])},children:"Select all"})}),e.jsx(r,{paddingBlockStart:"300",children:e.jsx(i,{variant:"bodySm",children:"Warning: This will permanently delete AI Search Optimisation data for selected languages."})})]})})}),Xe=e.jsx(u,{open:Pe,title:"Confirm Deletion",onClose:()=>{J(!1),V([])},primaryAction:{content:"Delete",destructive:!0,onAction:async()=>{J(!1),setTimeout(()=>{Je(pe)},100)}},secondaryActions:[{content:"Cancel",onAction:()=>{J(!1),V([]),R([])}}],children:e.jsx(u.Section,{children:e.jsxs(w,{gap:"400",children:[e.jsx(i,{variant:"bodyMd",children:"Are you sure you want to delete AI Search Optimisation for the following languages?"}),e.jsx(r,{paddingBlockStart:"200",children:e.jsx(C,{gap:"200",children:pe.map(t=>e.jsx(q,{tone:"warning",children:t.toUpperCase()},t))})}),e.jsxs(i,{variant:"bodyMd",children:["This will delete optimisation from ",A?W:S.length," selected collections."]}),e.jsx(r,{paddingBlockStart:"200",children:e.jsx(i,{variant:"bodySm",tone:"critical",children:"This action cannot be undone."})})]})})}),Ze=ue&&e.jsx(u,{open:ue,title:"Deleting SEO Data",onClose:()=>{},noScroll:!0,children:e.jsx(u.Section,{children:e.jsxs(w,{gap:"400",children:[e.jsx(i,{variant:"bodyMd",children:"Deleting selected languages..."}),e.jsx(oe,{progress:k.percent}),e.jsxs(i,{variant:"bodySm",tone:"subdued",children:[k.current," of ",k.total," operations (",k.percent,"%)"]})]})})}),et=e.jsx(dt,{heading:"No collections found",action:{content:"Clear filters",onAction:()=>{_(""),U("all"),L()}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Try adjusting your filters or search terms"})});return e.jsxs(e.Fragment,{children:[e.jsx(Ce,{children:e.jsxs(r,{padding:"400",children:[e.jsxs(C,{gap:"400",align:"space-between",blockAlign:"start",wrap:!1,children:[e.jsx(r,{minWidth:"400px",maxWidth:"600px",children:e.jsx(nt,{label:"",placeholder:"Search by collection name...",value:D,onChange:_,prefix:e.jsx(lt,{}),clearButton:!0,onClearButtonClick:()=>_("")})}),e.jsxs(w,{gap:"200",children:[e.jsx(O,{primary:!0,onClick:Ue,disabled:S.length===0&&!A,children:"Generate Optimization for AI Search"}),S.length===0&&!A||!x.filter(l=>S.includes(l.id)).some(l=>{var o;return((o=l.optimizedLanguages)==null?void 0:o.length)>0})?null:e.jsx(O,{onClick:()=>je(!0),disabled:S.length===0&&!A,children:"AI Enhanced add-ons for AI Search"}),e.jsx(O,{outline:!0,destructive:!0,onClick:()=>G(!0),disabled:S.length===0||!De,children:"Delete Optimization for AI Search"})]})]}),W>0&&e.jsx(r,{paddingBlockStart:"300",children:e.jsx(ye,{label:`Select all ${W} collections`,checked:A,onChange:ze})})]})}),e.jsx(r,{paddingBlockStart:"400",children:e.jsxs(Ce,{children:[e.jsxs(r,{padding:"400",borderBlockEndWidth:"025",borderColor:"border",children:[e.jsx(C,{gap:"200",wrap:!0,children:e.jsx(ot,{active:re,activator:e.jsx(O,{disclosure:"down",onClick:()=>K(!re),removeUnderline:!0,children:e.jsxs(C,{gap:"100",blockAlign:"center",children:[e.jsx("span",{children:"AI Search Status"}),v!=="all"&&e.jsx(r,{onClick:t=>{t.stopPropagation(),U("all")},children:e.jsx(i,{as:"span",tone:"subdued",children:"âœ•"})})]})}),onClose:()=>K(!1),children:e.jsx(r,{padding:"300",minWidth:"200px",children:e.jsx(at,{title:"AI Search Status",titleHidden:!0,choices:[{label:"All collections",value:"all"},{label:"Has AI Search Optimisation",value:"true"},{label:"No AI Search Optimisation",value:"false"}],selected:[v],onChange:t=>{U(t[0]),K(!1)}})})})}),v!=="all"&&e.jsx(r,{paddingBlockStart:"200",children:e.jsx(C,{gap:"100",wrap:!0,children:e.jsx(q,{onRemove:()=>U("all"),children:v==="true"?"Has AI Search Optimisation":"No AI Search Optimisation"})})})]}),e.jsx(it,{resourceName:{singular:"collection",plural:"collections"},items:x,renderItem:Ve,selectedItems:S,onSelectionChange:$e,selectable:!0,loading:ve,totalItemsCount:W,emptyState:et,showHeader:!1})]})}),qe,Qe,Ye,_e,Ke,Xe,Ze,Ne(),me&&e.jsx(rt,{content:me,onDismiss:()=>f("")})]})}export{wt as default};
