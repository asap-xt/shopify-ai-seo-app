import{j as e}from"./app-bridge-ColYhAdH-1757745303743.js";import{r as s}from"./react-vendor-tAaa2TlE-1757745303743.js";import{m as et}from"./index-DuExliVD-1757745303743.js";import{M as p,d as v,T as r,e as ae,a as c,I as w,f as be,B as O,D as tt,g as q,C as ye,h as st,S as nt,P as lt,i as ot,R as at,j as rt,l as it,E as ct}from"./polaris-5c_qu2R2-1757745303743.js";const dt=(Q,d="")=>{try{return new URLSearchParams(window.location.search).get(Q)||d}catch{return d}};function Ct({shop:Q}){const d=Q||dt("shop",""),S=s.useMemo(()=>et(),[]),[j,we]=s.useState([]),[Ce,re]=s.useState(!1),[W,Ae]=s.useState(0),[b,z]=s.useState([]),[C,_]=s.useState(!1),[D,K]=s.useState(""),[A,N]=s.useState("all"),[ie,X]=s.useState(!1),[ve,ke]=s.useState(""),[ut,Ie]=s.useState([]),[k,H]=s.useState([]),[E,ce]=s.useState([]),[Z,U]=s.useState(!1),[M,I]=s.useState({current:0,total:0,percent:0}),[de,G]=s.useState(""),[R,ue]=s.useState([]),[ht,pt]=s.useState(!1),[gt,ft]=s.useState(null),[xt,mt]=s.useState(!1),[St,Ee]=s.useState(""),[Me,J]=s.useState(!1),[L,T]=s.useState([]),[he,pe]=s.useState(!1),[Oe,$]=s.useState(!1),[De,V]=s.useState(!1),[ge,Y]=s.useState([]),[P,ee]=s.useState({}),[Pe,te]=s.useState(!1),[Le,se]=s.useState(!1),[fe,Te]=s.useState({}),[Be,ne]=s.useState(!1),[xe,le]=s.useState(null),[We,me]=s.useState(!1),[Se,m]=s.useState(""),[oe,je]=s.useState(!1),[f,F]=s.useState({processing:!1,current:0,total:0,currentItem:"",results:null});s.useEffect(()=>{d&&S("/plans/me",{shop:d}).then(t=>{const n=(t==null?void 0:t.modelsSuggested)||["google/gemini-1.5-flash"];Ie(n.map(l=>({label:l,value:l}))),ke(n[0])}).catch(t=>m(`Error loading models: ${t.message}`))},[d,S]),s.useEffect(()=>{d&&S(`/api/languages/shop/${d}`).then(t=>{const n=(t==null?void 0:t.shopLanguages)||["en"];ce(n),H([])}).catch(()=>{ce(["en"]),H([])})},[d,S]);const B=s.useCallback(async()=>{re(!0);try{const t=new URLSearchParams({shop:d,...D&&{search:D},...A!=="all"&&{optimized:A}});let l=(await S(`/collections/list?${t}`)).collections||[];if(D){const o=D.toLowerCase();l=l.filter(a=>a.title.toLowerCase().includes(o)||a.handle.toLowerCase().includes(o))}A!=="all"&&(l=l.filter(o=>A==="true"?o.hasSeoData:!o.hasSeoData)),we(l),Ae(l.length)}catch(t){m(`Error loading collections: ${t.message}`)}finally{re(!1)}},[d,D,A,S]);s.useEffect(()=>{d&&(B(),$(!1))},[d,A]),s.useEffect(()=>{const t=setTimeout(()=>{d&&B()},500);return()=>clearTimeout(t)},[D]);const ze=s.useCallback(t=>{z(t);const n=t.some(l=>{const o=j.find(a=>a.id===l);return o==null?void 0:o.hasSeoData});$(n),t.length===0&&_(!1)},[j]),Re=s.useCallback(t=>{if(_(t),t){z(j.map(l=>l.id));const n=j.some(l=>l.hasSeoData);$(n)}else z([]),$(!1)},[j]),$e=async t=>{me(!0);try{const n=`/collections/${t.split("/").pop()}/seo-data?shop=${encodeURIComponent(d)}`,l=await S(n);le(l),ne(!0)}catch(n){m((n==null?void 0:n.status)===404?"No SEO data found for this collection":"Failed to load SEO data")}finally{me(!1)}},Fe=()=>{if(b.length===0&&!C){m("Please select collections first");return}se(!0)},Ne=()=>{const n=j.filter(a=>b.includes(a.id)).filter(a=>{var i;return((i=a.optimizedLanguages)==null?void 0:i.length)>0}),l=async()=>{F({processing:!0,current:0,total:n.length,currentItem:"",results:null});const a={successful:0,failed:0,skipped:0,skippedDueToPlan:0};for(let i=0;i<n.length;i++){const g=n[i];F(h=>({...h,current:i,currentItem:g.title}));try{const h=await S("/ai-enhance/check-eligibility",{method:"POST",shop:d,body:{shop:d}});if(!(h!=null&&h.ok)){m("Your plan does not allow AI enhancement for collections");break}const x=await S("/ai-enhance/collection",{method:"POST",shop:d,body:{shop:d,collectionId:g.id,languages:k}});if(!(x!=null&&x.ok))throw new Error((x==null?void 0:x.error)||"AI enhancement failed");await S("/api/seo/apply-collection-multi",{method:"POST",shop:d,body:{shop:d,collectionId:g.id,results:x.data.results.filter(u=>u==null?void 0:u.seo).map(u=>({language:u.language,seo:u.seo})),options:{updateTitle:!0,updateDescription:!0,updateSeo:!0,updateMetafields:!0}}}),I(u=>({...u,current:u.current+1,percent:Math.round((u.current+1)/u.total*100)})),a[g.id]={success:!0,data:x.data}}catch(h){console.error("Enhancement error:",h),a.failed++}F(h=>({...h,current:i+1}))}F(i=>({...i,processing:!1,results:a})),m(`AI enhancement complete! ${a.successful} collections enhanced.`)},o=()=>{je(!1),F({processing:!1,current:0,total:0,currentItem:"",results:null}),f.results&&f.results.successful>0&&B()};return!f.processing&&!f.results?e.jsx(p,{open:oe,title:"AI Enhanced add-ons for AI Search",onClose:o,primaryAction:{content:"Start AI Enhancement",onAction:l},secondaryActions:[{content:"Cancel",onAction:o}],children:e.jsx(p.Section,{children:e.jsxs(v,{gap:"300",children:[e.jsxs(r,{variant:"bodyMd",children:["AI enhancement will improve bullets and FAQ for ",n.length," collections."]}),e.jsx(r,{variant:"bodySm",tone:"subdued",children:"Note: AI enhancement is only available for Growth Extra and Enterprise plans."})]})})}):f.processing?e.jsx(p,{open:oe,title:"Processing AI Enhancement",onClose:()=>{},noScroll:!0,children:e.jsx(p.Section,{children:e.jsxs(v,{gap:"400",children:[e.jsxs(r,{variant:"bodyMd",children:["Processing: ",f.currentItem]}),e.jsx(ae,{progress:f.current/f.total*100}),e.jsxs(r,{variant:"bodySm",tone:"subdued",children:[f.current," of ",f.total," collections (",Math.round(f.current/f.total*100),"%)"]})]})})}):f.results!==null?e.jsx(p,{open:oe,title:"AI Enhancement Results",onClose:o,primaryAction:{content:"Done",onAction:o},children:e.jsx(p.Section,{children:e.jsxs(v,{gap:"300",children:[e.jsxs(w,{gap:"400",children:[e.jsxs(c,{children:[e.jsx(r,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(r,{variant:"headingLg",fontWeight:"bold",tone:"success",children:f.results.successful})]}),e.jsxs(c,{children:[e.jsx(r,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(r,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:f.results.failed})]}),e.jsxs(c,{children:[e.jsx(r,{variant:"bodyMd",fontWeight:"semibold",children:"Skipped:"}),e.jsx(r,{variant:"headingLg",fontWeight:"bold",tone:"info",children:f.results.skipped})]})]}),f.results.skippedDueToPlan>0&&e.jsx(c,{paddingBlockStart:"300",children:e.jsx(r,{variant:"bodySm",tone:"subdued",children:"AI enhancement is only available for Growth Extra and Enterprise plans."})})]})})}):null},He=async()=>{if(!k.length){m("Please select at least one language");return}se(!1),U(!0),I({current:0,total:0,percent:0}),ue([]),ee({});try{const t=C?j:j.filter(a=>b.includes(a.id)),n=t.length;I({current:0,total:n,percent:0});const l={};for(let a=0;a<t.length;a++){const i=t[a];G(i.title);try{const x=await S("/seo/generate-collection-multi",{method:"POST",shop:d,body:{shop:d,collectionId:i.id,model:ve,languages:k}});l[i.id]={success:!0,data:x}}catch(x){l[i.id]={success:!1,error:x.message},ue(u=>[...u,{collection:i.title,error:x.message}])}const g=a+1,h=Math.round(g/n*100);I({current:g,total:n,percent:h})}ee(l),te(!0);const o=Object.values(l).filter(a=>a.success).length;m(`Generated SEO for ${o} collections`)}catch(t){m(`Error: ${t.message}`)}finally{U(!1),G("")}},Ue=async()=>{U(!0),I({current:0,total:0,percent:0});try{const t=Object.entries(P).filter(([o,a])=>a.success),n=t.length;I({current:0,total:n,percent:0});for(let o=0;o<t.length;o++){const[a,i]=t[o],g=j.find(u=>u.id===a);if(!g)continue;G(g.title);try{const u=await S("/seo/apply-collection-multi",{method:"POST",shop:d,body:{shop:d,collectionId:a,results:i.data.results.filter(y=>y==null?void 0:y.seo).map(y=>({language:y.language,seo:y.seo})),options:{updateTitle:!0,updateDescription:!0,updateSeo:!0,updateMetafields:!0}}});if(!(u!=null&&u.ok))throw new Error((u==null?void 0:u.error)||"Apply failed");I(y=>({...y,current:y.current+1,percent:Math.round((y.current+1)/y.total*100)}))}catch(u){R.push({id:g.id,title:g.title,message:u.message})}const h=o+1,x=Math.round(h/n*100);I({current:h,total:n,percent:x})}const l={};Object.entries(P).forEach(([o,a])=>{a.success&&(l[o]=a.data)}),Te(o=>({...o,...l})),m("SEO applied successfully!"),te(!1),ee({}),z([]),await B()}catch(t){m(`Error applying SEO: ${t.message}`)}finally{U(!1),G("")}},Ge=async(t=[])=>{pe(!0),Ee("");try{const n=C?j:j.filter(i=>b.includes(i.id)),l=n.length*t.length;let o=0;const a=[];for(const i of n)for(const g of t)try{await S("/collections/delete-seo",{method:"DELETE",shop:d,body:{shop:d,collectionId:i.id,language:g}})}catch(h){console.error(`Failed to delete ${g} for ${i.title}:`,h),a.push({id:i.id,title:i.title,message:h.message})}finally{o++,I({current:o,total:l,percent:Math.round(o/l*100)})}m(`Deleted SEO for ${t.join(", ").toUpperCase()}`),setTimeout(async()=>{await B(),z([]),_(!1),$(!1)},100)}catch(n){m(`Delete error: ${n.message}`)}finally{pe(!1),Y([]),T([])}},Je=t=>{var i,g;const n=((i=P[t.id])==null?void 0:i.success)||fe[t.id],l=((g=P[t.id])==null?void 0:g.data)||fe[t.id],o=t.optimizedLanguages||[],a=e.jsx(c,{width:"40px",height:"40px",background:"surface-neutral",borderRadius:"200"});return e.jsx(it,{id:t.id,url:"",media:a,accessibilityLabel:`View details for ${t.title}`,children:e.jsxs(w,{gap:"400",align:"center",blockAlign:"center",wrap:!1,children:[e.jsxs(c,{style:{flex:"1 1 30%",minWidth:"200px"},children:[e.jsx(r,{variant:"bodyMd",fontWeight:"semibold",children:t.title}),e.jsxs(r,{variant:"bodySm",tone:"subdued",children:["Handle: ",t.handle]})]}),e.jsx(c,{style:{flex:"0 0 15%",minWidth:"100px",textAlign:"center"},children:e.jsxs(r,{variant:"bodyMd",children:[t.productsCount," products"]})}),e.jsx(c,{style:{flex:"0 0 25%",minWidth:"160px"},children:t.hasSeoData?e.jsx(w,{gap:"100",children:E.map(h=>e.jsx(q,{tone:o.includes(h)?"success":"subdued",size:"small",children:h.toUpperCase()},h))}):e.jsx(q,{tone:"subdued",children:"No AI Search Optimisation"})}),e.jsxs(c,{style:{flex:"0 0 15%",minWidth:"120px"},children:[n&&e.jsx(O,{size:"slim",onClick:()=>{le(l),ne(!0)},children:"Preview JSON"}),!n&&t.hasSeoData&&e.jsx(O,{size:"slim",loading:We,onClick:()=>$e(t.id),children:"Preview JSON"})]})]})})},Ve=Z&&e.jsx(p,{open:Z,title:"Processing Collections",onClose:()=>{},noScroll:!0,children:e.jsx(p.Section,{children:e.jsxs(v,{gap:"400",children:[e.jsx(r,{variant:"bodyMd",children:de?`Processing: ${de}`:"Preparing..."}),e.jsx(ae,{progress:M.percent}),e.jsxs(r,{variant:"bodySm",tone:"subdued",children:[M.current," of ",M.total," collections (",M.percent,"%)"]})]})})}),Ye=e.jsx(p,{open:Le,title:"Select Languages",primaryAction:{content:"Generate Optimization for AI Search",onAction:He,disabled:k.length===0},secondaryActions:[{content:"Cancel",onAction:()=>se(!1)}],children:e.jsx(p.Section,{children:e.jsxs(v,{gap:"300",children:[e.jsxs(r,{variant:"bodyMd",children:["Select languages to generate AI Search Optimisation for ",C?"all":b.length," selected collections:"]}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(w,{gap:"200",wrap:!0,children:E.map(t=>e.jsx(be,{label:t.toUpperCase(),checked:k.includes(t),onChange:n=>{H(n?[...k,t]:k.filter(l=>l!==t))}},t))})}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(O,{plain:!0,onClick:()=>{H(k.length===E.length?[]:[...E])},children:k.length===E.length?"Deselect all":"Select all"})})]})})}),qe=e.jsx(p,{open:Pe&&!Z,title:"AI Search Optimisation Results",primaryAction:{content:"Apply Optimisation",onAction:Ue,disabled:!Object.values(P).some(t=>t.success)},secondaryActions:[{content:"Cancel",onAction:()=>te(!1)}],children:e.jsx(p.Section,{children:e.jsxs(v,{gap:"300",children:[e.jsxs(w,{gap:"400",children:[e.jsxs(c,{children:[e.jsx(r,{variant:"bodyMd",fontWeight:"semibold",children:"Successful:"}),e.jsx(r,{variant:"headingLg",fontWeight:"bold",tone:"success",children:Object.values(P).filter(t=>t.success).length})]}),e.jsxs(c,{children:[e.jsx(r,{variant:"bodyMd",fontWeight:"semibold",children:"Failed:"}),e.jsx(r,{variant:"headingLg",fontWeight:"bold",tone:"critical",children:Object.values(P).filter(t=>!t.success).length})]})]}),R.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(tt,{}),e.jsx(r,{variant:"bodyMd",fontWeight:"semibold",children:"Errors:"}),e.jsxs(c,{maxHeight:"200px",overflowY:"scroll",children:[R.slice(0,10).map((t,n)=>e.jsxs(r,{variant:"bodySm",tone:"critical",children:[t.collection,": ",t.error]},n)),R.length>10&&e.jsxs(r,{variant:"bodySm",tone:"subdued",children:["... and ",R.length-10," more errors"]})]})]})]})})}),Qe=e.jsx(p,{open:Be,title:"SEO Data Preview",secondaryActions:[{content:"Close",onAction:()=>{ne(!1),le(null)}}],children:e.jsx(p.Section,{children:e.jsx(c,{children:e.jsx("pre",{style:{whiteSpace:"pre-wrap",wordBreak:"break-word",fontSize:"12px",backgroundColor:"#f6f6f7",padding:"12px",borderRadius:"4px",maxHeight:"400px",overflow:"auto"},children:xe?JSON.stringify(xe,null,2):""})})})}),_e=e.jsx(p,{open:Me,title:"Delete Optimization for AI Search",onClose:()=>{J(!1),T([])},primaryAction:{content:"Continue",onAction:()=>{Y(L),J(!1),V(!0)},disabled:L.length===0},secondaryActions:[{content:"Cancel",onAction:()=>{J(!1),T([])}}],children:e.jsx(p.Section,{children:e.jsxs(v,{gap:"400",children:[e.jsxs(r,{variant:"bodyMd",children:["Select languages to delete AI Search Optimisation from ",C?W:b.length," selected collections:"]}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(w,{gap:"400",wrap:!1,children:E.map(t=>e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer",userSelect:"none"},children:[e.jsx("input",{type:"checkbox",checked:L.includes(t),onChange:n=>{T(n.target.checked?[...L,t]:L.filter(l=>l!==t))},style:{marginRight:"8px",width:"18px",height:"18px",cursor:"pointer"}}),e.jsx(r,{variant:"bodyMd",children:t.toUpperCase()})]},t))})}),e.jsx(c,{children:e.jsx(O,{plain:!0,onClick:()=>{T(L.length===E.length?[]:[...E])},children:"Select all"})}),e.jsx(c,{paddingBlockStart:"300",children:e.jsx(r,{variant:"bodySm",children:"Warning: This will permanently delete AI Search Optimisation data for selected languages."})})]})})}),Ke=e.jsx(p,{open:De,title:"Confirm Deletion",onClose:()=>{V(!1),Y([])},primaryAction:{content:"Delete",destructive:!0,onAction:async()=>{V(!1),setTimeout(()=>{Ge(ge)},100)}},secondaryActions:[{content:"Cancel",onAction:()=>{V(!1),Y([]),T([])}}],children:e.jsx(p.Section,{children:e.jsxs(v,{gap:"400",children:[e.jsx(r,{variant:"bodyMd",children:"Are you sure you want to delete AI Search Optimisation for the following languages?"}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(w,{gap:"200",children:ge.map(t=>e.jsx(q,{tone:"warning",children:t.toUpperCase()},t))})}),e.jsxs(r,{variant:"bodyMd",children:["This will delete optimisation from ",C?W:b.length," selected collections."]}),e.jsx(c,{paddingBlockStart:"200",children:e.jsx(r,{variant:"bodySm",tone:"critical",children:"This action cannot be undone."})})]})})}),Xe=he&&e.jsx(p,{open:he,title:"Deleting SEO Data",onClose:()=>{},noScroll:!0,children:e.jsx(p.Section,{children:e.jsxs(v,{gap:"400",children:[e.jsx(r,{variant:"bodyMd",children:"Deleting selected languages..."}),e.jsx(ae,{progress:M.percent}),e.jsxs(r,{variant:"bodySm",tone:"subdued",children:[M.current," of ",M.total," operations (",M.percent,"%)"]})]})})}),Ze=e.jsx(ct,{heading:"No collections found",action:{content:"Clear filters",onAction:()=>{K(""),N("all"),B()}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Try adjusting your filters or search terms"})});return e.jsxs(e.Fragment,{children:[e.jsx(ye,{children:e.jsxs(c,{padding:"400",children:[e.jsxs(w,{gap:"400",align:"space-between",blockAlign:"start",wrap:!1,children:[e.jsx(c,{minWidth:"400px",maxWidth:"600px",children:e.jsx(st,{label:"",placeholder:"Search by collection name...",value:D,onChange:K,prefix:e.jsx(nt,{}),clearButton:!0,onClearButtonClick:()=>K("")})}),e.jsxs(v,{gap:"200",children:[e.jsx(O,{primary:!0,onClick:Fe,disabled:b.length===0&&!C,children:"Generate Optimization for AI Search"}),b.length===0&&!C||!j.filter(l=>b.includes(l.id)).some(l=>{var o;return((o=l.optimizedLanguages)==null?void 0:o.length)>0})?null:e.jsx(O,{onClick:()=>je(!0),disabled:b.length===0&&!C,children:"AI Enhanced add-ons for AI Search"}),e.jsx(O,{outline:!0,destructive:!0,onClick:()=>J(!0),disabled:b.length===0||!Oe,children:"Delete Optimization for AI Search"})]})]}),W>0&&e.jsx(c,{paddingBlockStart:"300",children:e.jsx(be,{label:`Select all ${W} collections`,checked:C,onChange:Re})})]})}),e.jsx(c,{paddingBlockStart:"400",children:e.jsxs(ye,{children:[e.jsxs(c,{padding:"400",borderBlockEndWidth:"025",borderColor:"border",children:[e.jsx(w,{gap:"200",wrap:!0,children:e.jsx(lt,{active:ie,activator:e.jsx(O,{disclosure:"down",onClick:()=>X(!ie),removeUnderline:!0,children:e.jsxs(w,{gap:"100",blockAlign:"center",children:[e.jsx("span",{children:"AI Search Status"}),A!=="all"&&e.jsx(c,{onClick:t=>{t.stopPropagation(),N("all")},children:e.jsx(r,{as:"span",tone:"subdued",children:"✕"})})]})}),onClose:()=>X(!1),children:e.jsx(c,{padding:"300",minWidth:"200px",children:e.jsx(ot,{title:"AI Search Status",titleHidden:!0,choices:[{label:"All collections",value:"all"},{label:"Has AI Search Optimisation",value:"true"},{label:"No AI Search Optimisation",value:"false"}],selected:[A],onChange:t=>{N(t[0]),X(!1)}})})})}),A!=="all"&&e.jsx(c,{paddingBlockStart:"200",children:e.jsx(w,{gap:"100",wrap:!0,children:e.jsx(q,{onRemove:()=>N("all"),children:A==="true"?"Has AI Search Optimisation":"No AI Search Optimisation"})})})]}),e.jsx(at,{resourceName:{singular:"collection",plural:"collections"},items:j,renderItem:Je,selectedItems:b,onSelectionChange:ze,selectable:!0,loading:Ce,totalItemsCount:W,emptyState:Ze,showHeader:!1})]})}),Ve,Ye,qe,Qe,_e,Ke,Xe,Ne(),Se&&e.jsx(rt,{content:Se,onDismiss:()=>m("")})]})}export{Ct as default};
