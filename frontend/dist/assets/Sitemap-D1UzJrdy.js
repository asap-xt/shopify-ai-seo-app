import{r as e,j as t}from"./react-vendor-BXVC7v0l.js";import{m as n}from"./sessionFetch-D3PrWWoO.js";import{T as i,I as s,a}from"./TokenPurchaseModal-DozAvzCY.js";import{C as r,B as o,a as d,d as l,I as c,i as u,T as p,b as h,o as g,p as m,q as x,D as j,f as b,M as v,l as f}from"./polaris-CyaoFo5Q.js";import"./app-bridge-DUY42B6P.js";import"./vendor-Cs_VgJ2r.js";import"./index-DOSq6dA3.js";function S({shop:S}){var y,A;const w=S||((e,t="")=>{try{return new URLSearchParams(window.location.search).get(e)||t}catch{return t}})("shop",""),[k,I]=e.useState(null),[C,P]=e.useState(!1),[T,M]=e.useState(""),[_,E]=e.useState(null),[z,R]=e.useState(null),[$,O]=e.useState(!1),q=e.useMemo(()=>n(),[]),[B,W]=e.useState(!1),[L,F]=e.useState(null),[G,U]=e.useState(!1),[D,H]=e.useState({inProgress:!1,status:"idle",message:null,position:null,estimatedTime:null,generatedAt:null,productCount:0}),N=e.useRef(null),[Q,Y]=e.useState(!1),[J,K]=e.useState(null),[V,X]=e.useState(!1),[Z,ee]=e.useState(!1),[te,ne]=e.useState(!1),[ie,se]=e.useState(null),[ae,re]=e.useState(!1),[oe,de]=e.useState(null),[le,ce]=e.useState(!1),ue=e.useCallback(async()=>{if(w)try{const e=await q(`/api/sitemap/info?shop=${w}`);I(e)}catch(e){M(e.message||"Failed to load sitemap info")}},[w,q]),pe=e.useCallback(async()=>{var e,t,n;if(w)try{const i="\n        query PlansMe($shop:String!) {\n          plansMe(shop:$shop) {\n            shop\n            plan\n            planKey\n            priceUsd\n            product_limit\n            collection_limit\n            language_limit\n            providersAllowed\n            modelsSuggested\n            autosyncCron\n            trial {\n              active\n              ends_at\n              days_left\n            }\n          }\n        }\n      ",s=await q("/graphql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:i,variables:{shop:w}})});if(null==(e=null==s?void 0:s.errors)?void 0:e.length)throw new Error((null==(t=s.errors[0])?void 0:t.message)||"GraphQL error");const a=null==(n=null==s?void 0:s.data)?void 0:n.plansMe;E(a||null)}catch(i){}},[w,q]),he=e.useCallback(async()=>{var e,t,n,i;if(w){P(!0),R(null);try{const s=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(w)}`,{method:"POST",credentials:"include",headers:{Authorization:`Bearer ${(null==(n=null==(t=null==(e=window.__SHOPIFY_APP_BRIDGE__)?void 0:e.getState())?void 0:t.session)?void 0:n.token)||""}`,"Content-Type":"application/json"}});if(s.ok){const e=await s.json();e.success?(M(e.message||"Sitemap generation started!"),R(e.job),(null==(i=e.job)?void 0:i.queued)&&O(!0)):M(e.message||"Sitemap generation failed")}else{const e=await s.text();M(`Sitemap generation failed: ${e}`)}}catch(s){M(s.message||"Sitemap generation failed")}finally{P(!1)}}},[w]),ge=e.useCallback(async()=>{if(w&&$)try{const e=await q(`/api/sitemap/status?shop=${w}`);R(e.queue),"completed"!==e.queue.status&&"failed"!==e.queue.status&&"idle"!==e.queue.status||(O(!1),M(e.queue.message||"Sitemap generation completed!"),await ue())}catch(e){}},[w,$,q,ue]);e.useEffect(()=>{if($){const e=setInterval(ge,3e3);return()=>clearInterval(e)}},[$,ge]);const me=e.useCallback(async()=>{var e,t,n;if(w){W(!0),U(!0),F(null);try{const i=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(w)}&force=true&t=${Date.now()}`,{method:"GET",credentials:"include",headers:{Authorization:`Bearer ${(null==(n=null==(t=null==(e=window.__SHOPIFY_APP_BRIDGE__)?void 0:e.getState())?void 0:t.session)?void 0:n.token)||""}`}});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);{const e=await i.text();F(e)}}catch(i){F(`Error loading sitemap: ${i.message}`)}finally{U(!1)}}},[w]),xe=e.useCallback(async()=>{try{const e=await q(`/api/sitemap/status?shop=${w}`);return H(t=>{var n,i,s,a,r;return t.inProgress&&!e.inProgress&&("completed"===e.status||"failed"===e.status)&&(N.current&&(clearInterval(N.current),N.current=null),"completed"===e.status?(M(`AI-Optimized Sitemap generated! (${(null==(n=e.sitemap)?void 0:n.productCount)||0} products)`),be()):"failed"===e.status&&M("AI-Optimized Sitemap generation failed")),{inProgress:e.inProgress||!1,status:e.status||"idle",message:e.message||null,position:(null==(i=e.queue)?void 0:i.position)||null,estimatedTime:(null==(s=e.queue)?void 0:s.estimatedTime)||null,generatedAt:(null==(a=e.sitemap)?void 0:a.generatedAt)||null,productCount:(null==(r=e.sitemap)?void 0:r.productCount)||0}}),e}catch(e){}},[w,q]),je=e.useCallback(()=>{N.current&&clearInterval(N.current),xe(),N.current=setInterval(()=>{xe()},5e3)},[xe]),be=e.useCallback(async()=>{var e;if(w)try{const t=await q(`/api/sitemap/status?shop=${w}`);(null==(e=t.sitemap)?void 0:e.generatedAt)&&K({generated:!0,generatedAt:t.sitemap.generatedAt,productCount:t.sitemap.productCount||0})}catch(t){}},[w,q]),ve=e.useCallback(async()=>{var e,t,n,i;if(w){Y(!0);try{const i=await q("/graphql",{method:"POST",body:JSON.stringify({query:"mutation RegenerateSitemap($shop: String!) {\n            regenerateSitemap(shop: $shop) {\n              success\n              message\n              queued\n              position\n              estimatedTime\n            }\n          }",variables:{shop:w}})});if(null==(e=null==i?void 0:i.errors)?void 0:e.length){const e=(null==(t=i.errors[0])?void 0:t.message)||"GraphQL error";if(e.includes("TRIAL_RESTRICTION"))return se({trialRestriction:!0,requiresActivation:!0,message:"AI-Optimized Sitemap is locked during trial period. Activate your plan to unlock."}),void X(!0);throw new Error(e)}const s=null==(n=null==i?void 0:i.data)?void 0:n.regenerateSitemap;(null==s?void 0:s.success)?(M(s.message||"AI-Optimized Sitemap generation started!"),s.queued&&(H({inProgress:!0,status:"queued",message:"Queued for processing...",position:s.position,estimatedTime:s.estimatedTime,generatedAt:null,productCount:0}),je())):M((null==s?void 0:s.message)||"Failed to start AI-Optimized Sitemap generation")}catch(s){(null==(i=s.message)?void 0:i.includes("TRIAL_RESTRICTION"))||s.trialRestriction?(se({trialRestriction:!0,requiresActivation:!0,message:s.message}),X(!0)):402===s.status||s.requiresPurchase?(se(s),ee(!0)):M(s.message||"Failed to generate AI-Optimized Sitemap")}finally{Y(!1)}}},[w,q,je]),fe=e.useCallback(async()=>{var e,t,n;if(w){re(!0),ce(!0),de(null);try{const i=await fetch(`/api/sitemap/generate?shop=${encodeURIComponent(w)}&force=true&ai=true&t=${Date.now()}`,{method:"GET",credentials:"include",headers:{Authorization:`Bearer ${(null==(n=null==(t=null==(e=window.__SHOPIFY_APP_BRIDGE__)?void 0:e.getState())?void 0:t.session)?void 0:n.token)||""}`}});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);{const e=await i.text();de(e)}}catch(i){de(`Error loading AI sitemap: ${i.message}`)}finally{ce(!1)}}},[w]),Se=e.useCallback(async()=>{try{const e=await q("/api/billing/activate",{method:"POST",body:{shop:w}});(null==e?void 0:e.confirmationUrl)?window.top.location.href=e.confirmationUrl:M("Failed to activate plan")}catch(e){M(e.message||"Failed to activate plan")}},[w,q]);return e.useEffect(()=>()=>{N.current&&clearInterval(N.current)},[]),e.useEffect(()=>{ue(),pe(),be(),xe().then(e=>{(null==e?void 0:e.inProgress)&&je()})},[ue,pe,be,xe,je]),t.jsxs(r,{children:[t.jsx(o,{padding:"400",children:t.jsxs(d,{gap:"400",children:[t.jsx(l,{tone:"info",children:t.jsxs("p",{children:["Your ",(null==_?void 0:_.plan)||"Starter"," plan includes up to"," ",t.jsxs("strong",{children:[(null==(y=null==_?void 0:_.product_limit)?void 0:y.toLocaleString())||"70"," products in up to ",(null==_?void 0:_.language_limit)||1," language",((null==_?void 0:_.language_limit)||1)>1?"s":""]}),".",(null==k?void 0:k.productCount)&&(null==_?void 0:_.product_limit)&&k.productCount>_.product_limit&&t.jsxs(t.Fragment,{children:[" You have ",k.productCount," products, so only the first"," ",_.product_limit.toLocaleString()," ","will be included in the sitemap."]})]})}),($||z)&&t.jsx(l,{tone:"processing"===(null==z?void 0:z.status)?"info":"failed"===(null==z?void 0:z.status)?"critical":"success",children:t.jsxs(d,{gap:"200",children:[t.jsxs(c,{gap:"200",blockAlign:"center",children:[$&&t.jsx(u,{size:"small"}),t.jsx(p,{variant:"bodyMd",fontWeight:"medium",children:(null==z?void 0:z.message)||"Processing..."})]}),(null==z?void 0:z.position)>0&&t.jsxs(p,{variant:"bodySm",tone:"subdued",children:["Position in queue: ",z.position," | Estimated time: ~",z.estimatedTime,"s"]}),(null==z?void 0:z.queueLength)>0&&t.jsxs(p,{variant:"bodySm",tone:"subdued",children:["Queue length: ",z.queueLength," job(s)"]})]})}),t.jsxs(c,{align:"space-between",blockAlign:"center",children:[t.jsxs(o,{children:[t.jsx(p,{variant:"headingMd",as:"h3",children:"Sitemap Generator"}),t.jsx(p,{variant:"bodySm",tone:"subdued",children:"Generate structured sitemap for AI models to discover and index your products"})]}),t.jsx(h,{primary:!0,onClick:he,loading:C,disabled:C,children:C?"Generating...":"Generate Sitemap"})]}),k&&t.jsx(o,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:t.jsxs(d,{gap:"300",children:[t.jsx(c,{gap:"200",blockAlign:"center",children:k.generated?t.jsxs(t.Fragment,{children:[t.jsx(g,{source:m,tone:"success"}),t.jsx(p,{variant:"bodyMd",fontWeight:"semibold",tone:"success",children:"Sitemap Active"})]}):t.jsxs(t.Fragment,{children:[t.jsx(g,{source:x}),t.jsx(p,{variant:"bodyMd",fontWeight:"semibold",children:"No Sitemap Found"})]})}),k.generated&&t.jsxs(d,{gap:"400",children:[t.jsx(o,{children:t.jsxs(d,{gap:"200",children:[t.jsx(o,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(c,{align:"space-between",children:[t.jsx(p,{variant:"bodyMd",color:"subdued",children:"Products included"}),t.jsxs(p,{variant:"bodyMd",fontWeight:"semibold",children:[k.lastProductCount||0," URLs"]})]})}),t.jsx(o,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(c,{align:"space-between",children:[t.jsx(p,{variant:"bodyMd",color:"subdued",children:"File size"}),t.jsx(p,{variant:"bodyMd",fontWeight:"semibold",children:k.size?`${(k.size/1024).toFixed(2)} KB`:"Unknown"})]})}),t.jsx(o,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(c,{align:"space-between",children:[t.jsx(p,{variant:"bodyMd",color:"subdued",children:"Last updated"}),t.jsx(p,{variant:"bodyMd",fontWeight:"semibold",children:k.generatedAt?new Date(k.generatedAt).toLocaleString():"Unknown"})]})})]})}),t.jsx(o,{children:t.jsx(h,{fullWidth:!0,onClick:me,children:"View Sitemap"})})]})]})}),t.jsxs(o,{paddingBlockStart:"400",children:[t.jsx(p,{variant:"headingMd",as:"h4",children:"What's included:"}),t.jsx(o,{paddingBlockStart:"200",children:t.jsxs(d,{gap:"200",children:[t.jsxs(c,{gap:"200",blockAlign:"start",children:[t.jsx(o,{minWidth:"24px",children:t.jsx(g,{source:m,tone:"positive"})}),t.jsx(p,{children:"All active products with structured URLs for AI parsing"})]}),t.jsxs(c,{gap:"200",blockAlign:"start",children:[t.jsx(o,{minWidth:"24px",children:t.jsx(g,{source:m,tone:"positive"})}),t.jsx(p,{children:"Priority rankings to help AI models understand product importance"})]}),t.jsxs(c,{gap:"200",blockAlign:"start",children:[t.jsx(o,{minWidth:"24px",children:t.jsx(g,{source:m,tone:"positive"})}),t.jsx(p,{children:"Multi-language URLs for international AI search coverage"})]}),t.jsxs(c,{gap:"200",blockAlign:"start",children:[t.jsx(o,{minWidth:"24px",children:t.jsx(g,{source:m,tone:"positive"})}),t.jsx(p,{children:"Standard XML format that AI crawlers understand"})]})]})})]}),t.jsxs(o,{paddingBlockStart:"200",children:[t.jsx(p,{variant:"headingMd",as:"h4",children:"How it helps AI models:"}),t.jsx(o,{paddingBlockStart:"200",children:t.jsxs(d,{gap:"200",children:[t.jsx(p,{children:'1. Click "Generate Sitemap" to create a structured map of your products'}),t.jsx(p,{children:"2. The sitemap is automatically saved and available to AI crawlers"}),t.jsx(p,{children:"3. AI models can discover and understand your product catalog structure"}),t.jsx(p,{children:"4. Regenerate when you add new products to keep AI models updated"})]})})]}),(null==k?void 0:k.generated)&&t.jsxs(t.Fragment,{children:[t.jsx(j,{}),t.jsx(o,{paddingBlockStart:"200",children:t.jsxs(d,{gap:"400",children:[t.jsxs(c,{align:"space-between",blockAlign:"center",children:[t.jsxs(o,{children:[t.jsxs(c,{gap:"200",blockAlign:"center",children:[t.jsx(p,{variant:"headingMd",as:"h3",children:"AI-Optimized Sitemap"}),t.jsx(b,{tone:"info",children:"Premium"})]}),t.jsx(p,{variant:"bodySm",tone:"subdued",children:"Enhance your sitemap with AI-generated descriptions for better AI discovery"})]}),t.jsx(h,{primary:!0,onClick:ve,loading:Q,disabled:Q||D.inProgress,children:Q||D.inProgress?"Generating...":"Generate AI-Optimized"})]}),D.inProgress&&t.jsx(l,{tone:"info",children:t.jsxs(c,{gap:"300",blockAlign:"center",children:[t.jsx(u,{size:"small"}),t.jsxs(d,{gap:"100",children:[t.jsx(p,{variant:"bodyMd",fontWeight:"semibold",children:"Generating AI-Optimized Sitemap..."}),t.jsx(p,{variant:"bodySm",tone:"subdued",children:D.message||"Processing in background..."}),D.position>0&&t.jsxs(p,{variant:"bodySm",tone:"subdued",children:["Queue position: ",D.position," Â· Est. ",Math.ceil((D.estimatedTime||60)/60)," min"]})]})]})}),!D.inProgress&&((null==J?void 0:J.generated)||"completed"===D.status)&&t.jsx(o,{background:"bg-surface-secondary",padding:"400",borderRadius:"200",children:t.jsxs(d,{gap:"300",children:[t.jsxs(c,{gap:"200",blockAlign:"center",children:[t.jsx(g,{source:m,tone:"success"}),t.jsx(p,{variant:"bodyMd",fontWeight:"semibold",tone:"success",children:"AI-Optimized Sitemap Active"}),t.jsx(b,{tone:"success",children:"Generated"})]}),t.jsxs(d,{gap:"200",children:[t.jsx(o,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(c,{align:"space-between",children:[t.jsx(p,{variant:"bodyMd",color:"subdued",children:"Products included"}),t.jsxs(p,{variant:"bodyMd",fontWeight:"semibold",children:[(null==J?void 0:J.productCount)||D.productCount||0," products"]})]})}),t.jsx(o,{paddingBlockEnd:"200",borderBlockEndWidth:"025",borderColor:"border-subdued",children:t.jsxs(c,{align:"space-between",children:[t.jsx(p,{variant:"bodyMd",color:"subdued",children:"Last generated"}),t.jsx(p,{variant:"bodyMd",fontWeight:"semibold",children:(e=>{if(!e)return"";const t=Math.floor((new Date-new Date(e))/1e3);if(t<60)return"just now";const n=Math.floor(t/60);if(n<60)return`${n}m ago`;const i=Math.floor(n/60);if(i<24)return`${i}h ago`;return`${Math.floor(i/24)}d ago`})((null==J?void 0:J.generatedAt)||D.generatedAt)})]})})]}),t.jsx(h,{fullWidth:!0,onClick:fe,children:"View AI-Optimized Sitemap"})]})}),t.jsxs(o,{paddingBlockStart:"200",children:[t.jsx(p,{variant:"headingSm",as:"h4",children:"What AI-Optimization adds:"}),t.jsx(o,{paddingBlockStart:"200",children:t.jsxs(d,{gap:"200",children:[t.jsxs(c,{gap:"200",blockAlign:"start",children:[t.jsx(o,{minWidth:"24px",children:t.jsx(g,{source:m,tone:"positive"})}),t.jsx(p,{children:"AI-generated product descriptions optimized for AI crawlers"})]}),t.jsxs(c,{gap:"200",blockAlign:"start",children:[t.jsx(o,{minWidth:"24px",children:t.jsx(g,{source:m,tone:"positive"})}),t.jsx(p,{children:"Enhanced metadata for better AI understanding"})]}),t.jsxs(c,{gap:"200",blockAlign:"start",children:[t.jsx(o,{minWidth:"24px",children:t.jsx(g,{source:m,tone:"positive"})}),t.jsx(p,{children:"Structured data annotations for AI parsing"})]})]})})]})]})})]})]})}),B&&t.jsx(v,{open:B,onClose:()=>{W(!1),F(null)},title:"AI-Optimized Sitemap",primaryAction:{content:"Copy",onAction:()=>{navigator.clipboard.writeText(L),M("Copied to clipboard!")},disabled:G},secondaryActions:[{content:"Close",onAction:()=>{W(!1),F(null)}}],children:t.jsx(v.Section,{children:t.jsx(o,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:G?t.jsxs(c,{align:"center",gap:"200",children:[t.jsx(u,{size:"small"}),t.jsx(p,{variant:"bodyMd",children:"Loading sitemap XML... This may take a moment for large stores."})]}):t.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"12px",margin:0,overflow:"auto",maxHeight:"400px"},children:L})})})}),ae&&t.jsx(v,{open:ae,onClose:()=>{re(!1),de(null)},title:"AI-Optimized Sitemap",primaryAction:{content:"Copy",onAction:()=>{navigator.clipboard.writeText(oe),M("Copied to clipboard!")},disabled:le},secondaryActions:[{content:"Close",onAction:()=>{re(!1),de(null)}}],children:t.jsx(v.Section,{children:t.jsx(o,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:le?t.jsxs(c,{align:"center",gap:"200",children:[t.jsx(u,{size:"small"}),t.jsx(p,{variant:"bodyMd",children:"Loading AI-optimized sitemap..."})]}):t.jsx("pre",{style:{whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:"12px",margin:0,overflow:"auto",maxHeight:"400px"},children:oe})})})}),t.jsx(i,{open:V,onClose:()=>{X(!1),se(null)},featureName:"AI-Optimized Sitemap",currentPlan:(null==_?void 0:_.plan)||"Starter",trialEndsAt:null==(A=null==_?void 0:_.trial)?void 0:A.ends_at,onActivatePlan:Se,onPurchaseTokens:()=>{X(!1),ne(!0)}}),t.jsx(s,{open:Z,onClose:()=>{ee(!1),se(null)},featureName:"AI-Optimized Sitemap",tokensRequired:null==ie?void 0:ie.tokensRequired,tokensAvailable:null==ie?void 0:ie.tokensAvailable,currentPlan:(null==_?void 0:_.plan)||"Starter",needsUpgrade:null==ie?void 0:ie.needsUpgrade,onBuyTokens:()=>{ee(!1),ne(!0)}}),t.jsx(a,{open:te,onClose:()=>ne(!1),shop:w,returnTo:window.location.pathname+window.location.search}),T&&t.jsx(f,{content:T,onDismiss:()=>M("")})]})}export{S as default};
